<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Seguimiento â€“ HormigÃ³n / CNC</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#ffffff;
      --muted:#667085;
      --ink:#101828;
      --brand:#ef4444;
      --brand2:#111827;
      --shadow:0 10px 35px rgba(0,0,0,.18);
      --radius:18px;
      --stroke:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(1200px 600px at 90% 0%, rgba(239,68,68,.16), transparent 55%),
                  var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1220px;margin:22px auto 60px;padding:0 14px}
    header{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:14px 14px;
      display:flex;align-items:center;gap:14px;
      color:#fff;
      box-shadow: var(--shadow);
    }
    .logo{
      width:160px; height:54px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .logo img{max-width:100%; max-height:100%; object-fit:contain}
    .title{flex:1 1 auto}
    .title h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
    .title p{margin:2px 0 0;font-size:12px;opacity:.85}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{
      border:0; cursor:pointer;
      padding:10px 12px;border-radius:12px;
      font-weight:700; font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
      background: rgba(255,255,255,.10);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
    }
    .btn.primary{background: var(--brand); border-color: rgba(255,255,255,.0)}
    .btn:active{transform: translateY(1px)}
    .grid{display:grid; gap:14px; margin-top:14px}
    .filters{
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .filters h3{margin:0 0 10px;font-size:13px;color:#1f2937}
    .fgrid{display:grid;gap:10px;grid-template-columns: 1.4fr repeat(5,1fr)}
    .fgrid2{display:grid;gap:10px;grid-template-columns: repeat(5,1fr);margin-top:10px}
    .fgrid3{display:grid;gap:10px;grid-template-columns: repeat(6,1fr);margin-top:10px}
    @media (max-width: 1050px){
      .fgrid{grid-template-columns: 1fr 1fr}
      .fgrid2{grid-template-columns: 1fr 1fr}
      .fgrid3{grid-template-columns: 1fr 1fr}
    }
    .field label{display:block;font-size:11px;font-weight:800;color:#344054;margin:0 0 6px}
    .field input,.field select{
      width:100%; padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .cards{display:grid;gap:14px;grid-template-columns: repeat(6,1fr)}
    @media (max-width: 1050px){.cards{grid-template-columns: repeat(2,1fr)}}
    .card{
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px; min-height:96px;
      position:relative; overflow:hidden;
    }
    .card .k{font-size:11px;font-weight:800;color:#344054}
    .card .v{font-size:26px;font-weight:900;margin-top:6px}
    .card .s{font-size:11px;color:var(--muted);margin-top:2px}
    .card:before{
      content:""; position:absolute; right:-22px; top:-22px;
      width:120px; height:120px; border-radius:999px;
      background: rgba(239,68,68,.10);
    }
    .panels{display:grid;gap:14px;grid-template-columns: 1.5fr 1fr}
    .panels2{display:grid;gap:14px;grid-template-columns: 1fr 1fr}
    @media (max-width: 1050px){
      .panels{grid-template-columns:1fr}
      .panels2{grid-template-columns:1fr}
    }
    .panel{
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      min-height:340px;
    }
    .panel h3{margin:0 0 10px;font-size:13px;color:#111827}
    canvas{max-width:100%}
    .table{
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .table h3{margin:0 0 10px;font-size:13px;color:#111827}
    .scroll{overflow:auto;border-radius:14px;border:1px solid #0b1220}
    table{border-collapse:collapse; width:100%; min-width:980px; background:#0b1220; color:#fff}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:12px; white-space:nowrap}
    th{position:sticky; top:0; background:#0a1020; z-index:2; text-align:left}
    .hint{margin-top:10px;color:#fff;opacity:.75;font-size:12px}
    .status{margin-top:10px;font-size:12px;font-weight:800}
    .ok{color:#16a34a}
    .bad{color:#ef4444}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{width:min(980px, 100%); background:#fff; border-radius:22px; box-shadow: var(--shadow); padding:16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal-head h2{margin:0;font-size:18px}
    .close{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .formgrid{display:grid;gap:10px;grid-template-columns: repeat(4, 1fr)}
    @media (max-width: 1050px){.formgrid{grid-template-columns:1fr 1fr}}
    .footer-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <!-- PON TU LOGO EN LA MISMA CARPETA: logo_Xtreme.png -->
        <img src="logo_Xtreme.png" alt="Xtreme" onerror="this.style.display='none'">
      </div>
      <div class="title">
        <h1>Dashboard Seguimiento â€“ HormigÃ³n / CNC</h1>
        <p>Xtreme Mining â€¢ Datos desde Google Sheets (CSV) + Ingreso vÃ­a Apps Script</p>
      </div>
      <div class="actions">
        <button class="btn" id="btnNew">âž• Nuevo registro</button>
        <button class="btn" id="btnClear">ðŸ§¹ Limpiar filtros</button>
        <button class="btn primary" id="btnRefresh">ðŸ”„ Actualizar</button>
      </div>
    </header>

    <section class="filters grid">
      <div class="filters">
        <div class="fgrid">
          <div class="field">
            <label>Buscar (texto libre)</label>
            <input id="q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." />
          </div>
          <div class="field"><label>MES</label><select id="fMES"></select></div>
          <div class="field"><label>SEMANA</label><select id="fSEMANA"></select></div>
          <div class="field"><label>TURNO</label><select id="fTURNO"></select></div>
          <div class="field"><label>GRUPO</label><select id="fGRUPO"></select></div>
          <div class="field"><label>MINA</label><select id="fMINA"></select></div>
        </div>

        <div class="fgrid2">
          <div class="field"><label>GRADO</label><select id="fGRADO"></select></div>
          <div class="field"><label>SUMINISTRO</label><select id="fSUMINISTRO"></select></div>
          <div class="field"><label>SALA DE CONTROL</label><select id="fSALA"></select></div>
          <div class="field"><label>LABOR_POSTURA</label><select id="fLABOR"></select></div>
          <div class="field"><label>CNC_NIVEL 2</label><select id="fCNC2"></select></div>
        </div>

        <div class="fgrid3">
          <div class="field"><label>CNC_NIVEL 1</label><select id="fCNC1"></select></div>
          <div class="field"><label>RESPONSABLE_CNC</label><select id="fRESP"></select></div>
          <div class="field"><label>FECHA</label><select id="fFECHA"></select></div>
          <div class="field"><label>PLANIFICADO</label><select id="fPLAN"></select></div>
          <div class="field"><label>SUMINISTRADO</label><select id="fSUMI"></select></div>
          <div class="field"><label>PENDIENTE</label><select id="fPEND"></select></div>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div class="cards">
        <div class="card"><div class="k">REGISTROS FILTRADOS</div><div class="v" id="kRows">0</div><div class="s">Total visible segÃºn filtros</div></div>
        <div class="card"><div class="k">mÂ³ PLANIFICADO (suma)</div><div class="v" id="kPlan">0</div><div class="s">Suma columna PLANIFICADO</div></div>
        <div class="card"><div class="k">mÂ³ SUMINISTRADO (suma)</div><div class="v" id="kSumi">0</div><div class="s">Suma columna SUMINISTRADO</div></div>
        <div class="card"><div class="k">PENDIENTE (suma)</div><div class="v" id="kPend">0</div><div class="s">Suma columna PENDIENTE</div></div>
        <div class="card"><div class="k">RECHAZADO (suma)</div><div class="v" id="kRech">0</div><div class="s">Suma columna RECHAZADO</div></div>
        <div class="card"><div class="k">CNC NIVEL 1 (TOP)</div><div class="v" id="kTop">-</div><div class="s">Causa principal</div></div>
      </div>

      <div class="panels">
        <div class="panel">
          <h3>Incidentes por CNC_NIVEL 1 (TOP 10)</h3>
          <canvas id="chTop"></canvas>
        </div>
        <div class="panel">
          <h3>DistribuciÃ³n por RESPONSABLE_CNC</h3>
          <canvas id="chResp"></canvas>
        </div>
      </div>

      <div class="panels2">
        <div class="panel">
          <h3>mÂ³ por MINA (Planificado vs Suministrado)</h3>
          <canvas id="chMina"></canvas>
        </div>
        <div class="panel">
          <h3>mÂ³ por FECHA (Planificado vs Suministrado)</h3>
          <canvas id="chFecha"></canvas>
        </div>
      </div>

      <div class="table">
        <h3>Detalle (todas las columnas)</h3>
        <div class="scroll">
          <table id="tbl">
            <thead><tr id="th"></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
        <div class="hint" id="hint"></div>
      </div>
    </section>
  </div>

  <!-- MODAL -->
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <div class="modal-head">
        <h2>âž• Nuevo Registro</h2>
        <button class="close" id="btnClose">Cerrar</button>
      </div>

      <div class="formgrid" id="formGrid"></div>

      <div class="footer-actions">
        <button class="btn primary" id="btnSave">ðŸ’¾ Guardar</button>
      </div>

      <div class="status" id="saveStatus"></div>
    </div>
  </div>

<script>
/** ===================== CONFIG ===================== **/

// 1) ESTE CSV ES EL QUE EL DASHBOARD LEE (PUBLICADO).
//    Debe apuntar al GID correcto (pestaÃ±a de datos).
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv";

// 2) ESTE ES TU WEBAPP /exec (GUARDA DATOS).
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyctroxdNNdWJhm39r7Ym7fKzW8pY5k2UDkwxzlRvVHMehTii1XNhmBi0IeKvKB-P2K/exec";

/** Encabezados exactos de la hoja de registros (HORMIGONES) **/
const HEADERS = [
  "FECHA","MES","SEMANA","TURNO","GRUPO","MINA","LABOR_POSTURA","GRADO","SUMINISTRO",
  "PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO","REAGENDADO","ELIMINADO",
  "NÃšMERO GUÃA","HORA SALIDA PLANTA","HORA LLEGADA OBRA","HORA INICIO DESCARGA","HORA TERMINO DESCARGA",
  "CNC _NIVEL 2","CNC _NIVEL 1","RESPONSABLE_CNC","SALA DE CONTROL"
];

// Campos que deben ser desplegables en el ingreso
const FORM_SELECT_FIELDS = new Set([
  "MES","SEMANA","TURNO","GRUPO","MINA","LABOR_POSTURA","GRADO","SUMINISTRO",
  "CNC _NIVEL 2","CNC _NIVEL 1","RESPONSABLE_CNC","SALA DE CONTROL"
]);

// CatÃ¡logo â€œfijoâ€ (tu lista) para que los selects del modal SIEMPRE tengan opciones aunque el CSV estÃ© vacÃ­o.
const CATALOG = {
  "GRADO": ["SH-22,5 NORMAL","SH-22,5 FIBRA","SH-300","HN-70","HN-30","HN-40","HN-50","HB-30","HB-40","HB-50","GN-25","HB-70","GN-65"],
  "SUMINISTRO": ["En Planta","En Obra"],
  "TURNO": ["1","2","A","B","C"],
  "GRUPO": ["Grupo_1","Grupo_2","Grupo_3","Grupo_4"],
  "SALA DE CONTROL": ["Carlos Salazar Rodriguez","Martin Arriaza Vidal","Alvaro Coloma Toledo","Marcelo Henriquez Ortiz"],
  "MINA": [
    "ESMERALDA","ESMERALDA_ACARREO","ESMERALDA_PANEL_1","ESMERALDA_PANEL_2","DIABLO_REGIMIENTO","PACIFICO_SUPERIOR",
    "PILAR_NORTE","PANEL_RENO","RENO","RRNN","DACITA","PANEL_INVARIANTE","TENIENTE_6","TENIENTE_7","TENIENTE_8",
    "ANDESITA","COLÃ“N","ADIT_71"
  ],
  "LABOR_POSTURA": [
    "C-49 IZ","C-55 IZ","C-25 Z-44 HW","C-25 Z-45 HW","C-49 OP-48","C-23 Z-0","C-23 Z-42 FW","C-23 Z-42 HW",
    "C-2 Z-10/9","C-2 Z-5/6","C-0 SOC. SUR A Z-10","OP-27 UH","OP-26 Pto 22-A","OP-26 Pto 22-B","OP-26 Pto 24",
    "OP-26 Pto 23","OP-27 Pto 20-A","OP-27 Pto 20-B","OP-27 Pto 21-A","OP-27 Pto 21-B","OP-27 Pto 22-A",
    "Pilar Bz 24-1S (Pto 1)","Soc. Hw 1 (Pto 2)","Soc. Hw 1 / Acceso Sur Loop (Pto 3)","Acceso Sur Loop (Pto 4)",
    "Soc. Hw 1 / Loop Norte (Pto 5)","Loop Fw A (Pto 6)","Loop Fw B (Pto 7)","CX 1S/2S con Loop 1S (Pto 8)",
    "Loop Hw / CX Loop 1S/2S (Pto 9)","Loop Hw / Adit 65 (Pto 10)","Loop Hw entre P4 y P5 (Pto 11)",
    "Fr Inv descarga Dacita (Pto 12)","CAV acceso descarga CH DT (Pto 13)","GalerÃ­a curva CH DT (Pto 14)","OP 24","EDIFICIO 132"
  ],
  "CNC _NIVEL 2": [
    "Interferencia por derrumbe","ComunicaciÃ³n","Trabajos en ruta","Traslado personal DET","ruta no apta para el ingreso de mixer",
    "Simulacros","Ventana horaria","RestricciÃ³n por evento climatico","Movilizaciones","Visita Gerencia GSYS","Cambio de prioridad",
    "Sin Autorizacion DET","APP no disponible","Planta sin comunicaciÃ³n","SismologÃ­a","Ruta marina","Cenefa","Trabajo otras empresas",
    "Equipos en Ã¡rea","Marina en postura","LiberaciÃ³n de gases","EnergÃ­a","Agua","Cancha no lista","Trabajos otras disciplinas",
    "Cancelacion Suministro","Pedido Fuera de Programa","Confirmacion fuera de horario","Indisponibilidad de mixer propio","Falta operador",
    "Falta personal OOCC","Equipo shortcrete F/S","Bomba F/S","Problemas con escolta","Lento retorno de equipos","Mixer Retrasado",
    "Sin retorno de mixer a planta","Capacidad maxima equipo","Mezcladores","Postura rematada con menos m3","Cambio de Postura",
    "Suspension Administrativa","PlanificaciÃ³n errÃ³nea","Problemas en la calidad","Falta suministros","Falla planta","Incumplimiento horario APP",
    "Equipo F/S Xtreme","Tarjeta Verde","Somnolencia","Proceso de carguÃ­o tarda mas de lo programado","Espera equipo en planta"
  ],
  "CNC _NIVEL 1": [
    "Ruta Codelco","Clima","Personal","Prioridades","APP no disponible","ComunicaciÃ³n","SismologÃ­a","Ruta","Interferencia empresas",
    "LiberaciÃ³n de gases","Servicios","Frente no preparada","Pedido","Indisponibilidad de mixer propio","DotaciÃ³n no disponible","Equipos",
    "Postura","Suministro","PlanificaciÃ³n errÃ³nea","Calidad","Indisponibilidad de planta","Incumplimiento horario APP","Equipo F/S","Planta",
    "Falla operacional","Espera equipo en planta"
  ],
  "RESPONSABLE_CNC": ["CODELCO","INTERNA","SUMINISTRO"]
};

/** ===================== STATE ===================== **/
let rawRows = [];     // objects
let filtered = [];
let charts = {};
let lastHeadersInCsv = [];

/** ===================== HELPERS ===================== **/
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (isNaN(n)?0:n).toLocaleString("es-CL");
const toNum = (v)=> {
  if(v===null||v===undefined) return 0;
  const s=String(v).trim().replaceAll(".","").replace(",",".");
  const x=parseFloat(s);
  return isNaN(x)?0:x;
};
function uniqueSorted(arr){
  return [...new Set(arr.filter(v=>String(v).trim()!=="").map(v=>String(v).trim()))].sort((a,b)=>a.localeCompare(b,"es"));
}
function setStatus(msg, ok=true){
  const el=$("status");
  el.textContent=msg;
  el.className="status "+(ok?"ok":"bad");
}

/** ===================== CSV LOAD ===================== **/
async function fetchCsvWithRetry(url, tries=3){
  let lastErr=null;
  for(let i=0;i<tries;i++){
    try{
      const bust = (url.includes("?")?"&":"?")+"ts="+Date.now()+"_"+i;
      const res = await fetch(url+bust, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();
      if(!text || text.trim().length<5) throw new Error("CSV vacÃ­o");
      return text;
    }catch(e){
      lastErr=e;
      await new Promise(r=>setTimeout(r, 400*(i+1)));
    }
  }
  throw lastErr;
}

function parseCsv(text){
  // parser simple CSV (soporta comillas)
  const rows=[];
  let i=0, field="", row=[], inQ=false;
  const pushField=()=>{ row.push(field); field=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
      if(c==='"'){ inQ=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c==='"'){ inQ=true; i++; continue; }
      if(c===','){ pushField(); i++; continue; }
      if(c==='\n'){ pushField(); pushRow(); i++; continue; }
      if(c==='\r'){ i++; continue; }
      field+=c; i++; continue;
    }
  }
  pushField(); pushRow();
  return rows;
}

async function loadData(){
  try{
    setStatus("Cargando CSVâ€¦");
    const csvText = await fetchCsvWithRetry(CSV_URL, 4);
    const grid = parseCsv(csvText);
    const headers = grid[0].map(h=>String(h).trim());
    lastHeadersInCsv = headers;

    const dataRows = grid.slice(1).filter(r=>r.some(x=>String(x||"").trim()!==""));
    rawRows = dataRows.map(r=>{
      const obj={};
      headers.forEach((h,idx)=>obj[h]= (r[idx]??""));
      // normaliza nombres esperados por dashboard (por si vienen con espacios)
      // (no tocamos HEADERS, solo para filtro/render)
      return obj;
    });

    if(dataRows.length===0){
      setStatus("CSV cargado (sin filas). Puedes ingresar registros con 'Nuevo registro'.", true);
      $("hint").textContent="CSV sin filas (solo encabezados). Igual puedes ingresar registros con â€œNuevo registroâ€.";
    }else{
      setStatus("CSV cargado: "+dataRows.length+" filas.", true);
      $("hint").textContent="Mostrando registros desde el CSV publicado.";
    }

    buildFilterOptions();
    applyFilters();
  }catch(e){
    setStatus("Error de red: no se pudo leer el CSV. Revisa permisos y el link publicado (output=csv).", false);
    $("hint").textContent="Error: "+String(e);
    rawRows=[];
    buildFilterOptions(true);
    applyFilters();
  }
}

/** ===================== FILTER OPTIONS ===================== **/
function fillSelect(selId, values, allLabel="Todos"){
  const sel=$(selId);
  sel.innerHTML="";
  const opt0=document.createElement("option");
  opt0.value="__ALL__"; opt0.textContent=allLabel;
  sel.appendChild(opt0);
  values.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}

function buildFilterOptions(fallback=false){
  const get = (h)=> uniqueSorted(rawRows.map(r=>r[h]));
  // si no hay datos, igual dejamos selects con "Todos"
  fillSelect("fMES", get("MES"));
  fillSelect("fSEMANA", get("SEMANA"));
  fillSelect("fTURNO", get("TURNO"));
  fillSelect("fGRUPO", get("GRUPO"));
  fillSelect("fMINA", get("MINA"));
  fillSelect("fGRADO", get("GRADO"));
  fillSelect("fSUMINISTRO", get("SUMINISTRO"));
  fillSelect("fSALA", get("SALA DE CONTROL") , "Todos");
  fillSelect("fLABOR", get("LABOR_POSTURA"));
  fillSelect("fCNC2", get("CNC _NIVEL 2"));
  fillSelect("fCNC1", get("CNC _NIVEL 1"));
  fillSelect("fRESP", get("RESPONSABLE_CNC"));
  fillSelect("fFECHA", get("FECHA"), "Todas");
  fillSelect("fPLAN", uniqueSorted(rawRows.map(r=>String(r["PLANIFICADO"]??"").trim()).filter(Boolean)), "Todos");
  fillSelect("fSUMI", uniqueSorted(rawRows.map(r=>String(r["SUMINISTRADO"]??"").trim()).filter(Boolean)), "Todos");
  fillSelect("fPEND", uniqueSorted(rawRows.map(r=>String(r["PENDIENTE"]??"").trim()).filter(Boolean)), "Todos");
}

/** ===================== APPLY FILTERS ===================== **/
function valOrAll(sel){ const v=$(sel).value; return v==="__ALL__" ? "" : v; }

function applyFilters(){
  const q = $("q").value.trim().toLowerCase();

  const F = {
    MES: valOrAll("fMES"),
    SEMANA: valOrAll("fSEMANA"),
    TURNO: valOrAll("fTURNO"),
    GRUPO: valOrAll("fGRUPO"),
    MINA: valOrAll("fMINA"),
    GRADO: valOrAll("fGRADO"),
    SUMINISTRO: valOrAll("fSUMINISTRO"),
    SALA: valOrAll("fSALA"),
    LABOR: valOrAll("fLABOR"),
    CNC2: valOrAll("fCNC2"),
    CNC1: valOrAll("fCNC1"),
    RESP: valOrAll("fRESP"),
    FECHA: valOrAll("fFECHA"),
    PLAN: valOrAll("fPLAN"),
    SUMI: valOrAll("fSUMI"),
    PEND: valOrAll("fPEND")
  };

  filtered = rawRows.filter(r=>{
    if(F.MES && String(r["MES"]||"").trim()!==F.MES) return false;
    if(F.SEMANA && String(r["SEMANA"]||"").trim()!==F.SEMANA) return false;
    if(F.TURNO && String(r["TURNO"]||"").trim()!==F.TURNO) return false;
    if(F.GRUPO && String(r["GRUPO"]||"").trim()!==F.GRUPO) return false;
    if(F.MINA && String(r["MINA"]||"").trim()!==F.MINA) return false;
    if(F.GRADO && String(r["GRADO"]||"").trim()!==F.GRADO) return false;
    if(F.SUMINISTRO && String(r["SUMINISTRO"]||"").trim()!==F.SUMINISTRO) return false;
    if(F.SALA && String(r["SALA DE CONTROL"]||"").trim()!==F.SALA) return false;
    if(F.LABOR && String(r["LABOR_POSTURA"]||"").trim()!==F.LABOR) return false;
    if(F.CNC2 && String(r["CNC _NIVEL 2"]||"").trim()!==F.CNC2) return false;
    if(F.CNC1 && String(r["CNC _NIVEL 1"]||"").trim()!==F.CNC1) return false;
    if(F.RESP && String(r["RESPONSABLE_CNC"]||"").trim()!==F.RESP) return false;
    if(F.FECHA && String(r["FECHA"]||"").trim()!==F.FECHA) return false;
    if(F.PLAN && String(r["PLANIFICADO"]||"").trim()!==F.PLAN) return false;
    if(F.SUMI && String(r["SUMINISTRADO"]||"").trim()!==F.SUMI) return false;
    if(F.PEND && String(r["PENDIENTE"]||"").trim()!==F.PEND) return false;

    if(q){
      const blob = Object.values(r).join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });

  renderAll();
}

/** ===================== RENDER ===================== **/
function destroyChart(key){
  if(charts[key]){ charts[key].destroy(); charts[key]=null; }
}
function renderKpis(){
  $("kRows").textContent = fmt(filtered.length);
  const sumPlan = filtered.reduce((a,r)=>a+toNum(r["PLANIFICADO"]),0);
  const sumSumi = filtered.reduce((a,r)=>a+toNum(r["SUMINISTRADO"]),0);
  const sumPend = filtered.reduce((a,r)=>a+toNum(r["PENDIENTE"]),0);
  const sumRech = filtered.reduce((a,r)=>a+toNum(r["RECHAZADO"]),0);
  $("kPlan").textContent = fmt(sumPlan);
  $("kSumi").textContent = fmt(sumSumi);
  $("kPend").textContent = fmt(sumPend);
  $("kRech").textContent = fmt(sumRech);

  const counts = {};
  filtered.forEach(r=>{
    const k=String(r["CNC _NIVEL 1"]||"").trim();
    if(!k) return;
    counts[k]=(counts[k]||0)+1;
  });
  let top="-", topv=0;
  Object.entries(counts).forEach(([k,v])=>{ if(v>topv){top=k;topv=v;} });
  $("kTop").textContent = top;
}
function renderCharts(){
  // TOP 10 CNC1
  const cnc1Counts={};
  filtered.forEach(r=>{
    const k=String(r["CNC _NIVEL 1"]||"").trim();
    if(!k) return;
    cnc1Counts[k]=(cnc1Counts[k]||0)+1;
  });
  const top10 = Object.entries(cnc1Counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  destroyChart("top");
  charts.top = new Chart($("chTop"),{
    type:"bar",
    data:{ labels: top10.map(x=>x[0]), datasets:[{ label:"Cantidad", data: top10.map(x=>x[1]) }]},
    options:{ responsive:true, plugins:{ legend:{display:false}}, scales:{x:{ticks:{maxRotation:50,minRotation:25}}}}
  });

  // Resp distrib
  const respCounts={};
  filtered.forEach(r=>{
    const k=String(r["RESPONSABLE_CNC"]||"").trim();
    if(!k) return;
    respCounts[k]=(respCounts[k]||0)+1;
  });
  const resp = Object.entries(respCounts).sort((a,b)=>b[1]-a[1]);
  destroyChart("resp");
  charts.resp = new Chart($("chResp"),{
    type:"doughnut",
    data:{ labels: resp.map(x=>x[0]), datasets:[{ data: resp.map(x=>x[1]) }]},
    options:{ responsive:true, plugins:{ legend:{position:"bottom"}}}
  });

  // Mina plan vs sum
  const minaAgg={};
  filtered.forEach(r=>{
    const m=String(r["MINA"]||"").trim()||"(Sin mina)";
    minaAgg[m]=minaAgg[m]||{plan:0,sumi:0};
    minaAgg[m].plan += toNum(r["PLANIFICADO"]);
    minaAgg[m].sumi += toNum(r["SUMINISTRADO"]);
  });
  const mina = Object.entries(minaAgg).sort((a,b)=>b[1].plan-a[1].plan).slice(0,12);
  destroyChart("mina");
  charts.mina = new Chart($("chMina"),{
    type:"bar",
    data:{
      labels: mina.map(x=>x[0]),
      datasets:[
        { label:"Planificado", data: mina.map(x=>x[1].plan) },
        { label:"Suministrado", data: mina.map(x=>x[1].sumi) }
      ]
    },
    options:{ responsive:true, plugins:{ legend:{position:"bottom"}}, scales:{x:{ticks:{maxRotation:45,minRotation:20}}}}
  });

  // Fecha plan vs sum
  const fechaAgg={};
  filtered.forEach(r=>{
    const f=String(r["FECHA"]||"").trim()||"(Sin fecha)";
    fechaAgg[f]=fechaAgg[f]||{plan:0,sumi:0};
    fechaAgg[f].plan += toNum(r["PLANIFICADO"]);
    fechaAgg[f].sumi += toNum(r["SUMINISTRADO"]);
  });
  const fechas = Object.entries(fechaAgg).sort((a,b)=>a[0].localeCompare(b[0],"es")).slice(-20);
  destroyChart("fecha");
  charts.fecha = new Chart($("chFecha"),{
    type:"line",
    data:{
      labels: fechas.map(x=>x[0]),
      datasets:[
        { label:"Planificado", data: fechas.map(x=>x[1].plan), tension:.35 },
        { label:"Suministrado", data: fechas.map(x=>x[1].sumi), tension:.35 }
      ]
    },
    options:{ responsive:true, plugins:{ legend:{position:"bottom"}}}
  });
}
function renderTable(){
  const th=$("th"), tb=$("tb");
  th.innerHTML=""; tb.innerHTML="";
  const cols = HEADERS; // usamos los headers esperados
  cols.forEach(h=>{
    const c=document.createElement("th"); c.textContent=h; th.appendChild(c);
  });
  // solo primeras 200 filas por rendimiento
  filtered.slice(0,200).forEach(r=>{
    const tr=document.createElement("tr");
    cols.forEach(h=>{
      const td=document.createElement("td");
      // en CSV algunos encabezados vienen sin acentos o distinto; intentamos por nombre exacto
      td.textContent = (r[h] ?? r[h.replaceAll("_"," ")] ?? r[h.replaceAll(" ","_")] ?? "");
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}
function renderAll(){
  renderKpis();
  renderCharts();
  renderTable();
}

/** ===================== MODAL FORM ===================== **/
function openModal(){
  $("modalBack").style.display="flex";
  buildForm();
}
function closeModal(){ $("modalBack").style.display="none"; $("saveStatus").textContent=""; $("saveStatus").className="status"; }

function buildForm(){
  const grid=$("formGrid");
  grid.innerHTML="";

  HEADERS.forEach(h=>{
    const field=document.createElement("div");
    field.className="field";
    const label=document.createElement("label");
    label.textContent = h;
    field.appendChild(label);

    let input;
    if(h==="FECHA"){
      input=document.createElement("input");
      input.type="date";
      // default hoy
      const d=new Date();
      const iso=d.toISOString().slice(0,10);
      input.value=iso;
    }else if(h.startsWith("HORA ")){
      input=document.createElement("input");
      input.type="time";
      input.value="";
    }else if(FORM_SELECT_FIELDS.has(h)){
      input=document.createElement("select");
      const valuesFromCsv = uniqueSorted(rawRows.map(r=>r[h]).filter(Boolean));
      const values = valuesFromCsv.length ? valuesFromCsv : (CATALOG[h] || []);
      const o0=document.createElement("option"); o0.value=""; o0.textContent="Seleccioneâ€¦"; input.appendChild(o0);
      values.forEach(v=>{
        const o=document.createElement("option"); o.value=v; o.textContent=v; input.appendChild(o);
      });
    }else{
      input=document.createElement("input");
      // num for some columns
      const numericCols = new Set(["PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO","REAGENDADO","ELIMINADO","NÃšMERO GUÃA"]);
      input.type = numericCols.has(h) ? "number" : "text";
      if(numericCols.has(h)) input.step="any";
      input.placeholder=h;
    }

    input.id="in_"+h;
    field.appendChild(input);
    grid.appendChild(field);
  });
}

function setSaveStatus(msg, ok=true){
  const el=$("saveStatus");
  el.textContent=msg;
  el.className="status "+(ok?"ok":"bad");
}

function rowFromForm(){
  const obj={};
  HEADERS.forEach(h=>{
    const el=$("in_"+h);
    if(!el) return;
    let v=el.value ?? "";
    // formatea fecha dd-mm-yyyy para igualar tu estilo (si prefieres ISO, bÃ³rralo)
    if(h==="FECHA" && v){
      const [yy,mm,dd]=v.split("-");
      v = `${dd}-${mm}-${yy}`;
      // tambiÃ©n rellena MES/SEMANA si estÃ¡n vacÃ­os
      try{
        const d=new Date(`${yy}-${mm}-${dd}T00:00:00`);
        const mes=d.toLocaleString("es-CL",{month:"long"});
        if(!$("in_MES").value) $("in_MES").value = mes.charAt(0).toUpperCase()+mes.slice(1);
        // semana ISO simple
        const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum=tmp.getUTCDay()||7;
        tmp.setUTCDate(tmp.getUTCDate()+4-dayNum);
        const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
        const week=Math.ceil((((tmp-yearStart)/86400000)+1)/7);
        if(!$("in_SEMANA").value) $("in_SEMANA").value = String(week);
      }catch(_){}
    }
    obj[h]=v;
  });
  return obj;
}

// Guardar: enviamos POST a Apps Script. Como GitHub Pages, usamos no-cors (no podemos leer respuesta),
// y ADEMÃS agregamos la fila localmente para que se vea al tiro en el dashboard (aunque el CSV tarde).
async function saveRow(){
  const payload = rowFromForm();

  setSaveStatus("Enviandoâ€¦", true);

  try{
    await fetch(WEBAPP_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    // Insertar local para que aparezca inmediatamente
    const localObj={};
    // construimos con llaves exactas esperadas por filtros
    Object.keys(payload).forEach(k=> localObj[k]=payload[k]);
    rawRows.push(localObj);

    // reconstruye opciones y aplica filtros
    buildFilterOptions();
    applyFilters();

    setSaveStatus("âœ… Enviado. Actualizado en pantalla. (Si tu CSV publicado tarda, se verÃ¡ igual aquÃ­).", true);
    // intenta recargar CSV por si ya refrescÃ³
    setTimeout(()=>loadData(), 1200);

  }catch(e){
    setSaveStatus("âŒ Error de red al enviar. Revisa la URL /exec y permisos.", false);
  }
}

/** ===================== WIRE ===================== **/
function wire(){
  // filtros
  ["q","fMES","fSEMANA","fTURNO","fGRUPO","fMINA","fGRADO","fSUMINISTRO","fSALA","fLABOR","fCNC2","fCNC1","fRESP","fFECHA","fPLAN","fSUMI","fPEND"]
    .forEach(id=>{
      const el=$(id);
      if(!el) return;
      el.addEventListener(id==="q" ? "input" : "change", ()=>applyFilters());
    });

  $("btnClear").addEventListener("click", ()=>{
    $("q").value="";
    document.querySelectorAll("select").forEach(s=>{ if(s.id.startsWith("f")) s.value="__ALL__"; });
    $("fFECHA").value="__ALL__";
    applyFilters();
  });

  $("btnRefresh").addEventListener("click", ()=>loadData());
  $("btnNew").addEventListener("click", ()=>openModal());
  $("btnClose").addEventListener("click", ()=>closeModal());
  $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });
  $("btnSave").addEventListener("click", ()=>saveRow());
}

wire();
loadData();

</script>
</body>
</html>
