<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Seguimiento – Hormigón / CNC</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --panel:#ffffff; --border:#e6e9f2;
    --text:#111827; --muted:#6b7280; --accent:#d7262f;
    --shadow: 0 8px 24px rgba(16,24,40,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
  .wrap{max-width:1320px;margin:14px auto 26px;padding:0 14px}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:var(--radius);background:var(--panel);border:1px solid var(--border);box-shadow:var(--shadow)}
  .brand{display:flex;gap:12px;align-items:center;min-width:0}
  .logoBox{width:148px;height:56px;border-radius:14px;background:#fff;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto}
  .logoBox img{width:100%;height:100%;object-fit:contain;display:block}
  .logoFallback{font-weight:900;letter-spacing:.6px;color:#111827}
  .titles{min-width:0}
  .titles h1{margin:0;font-size:18px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .titles p{margin:2px 0 0;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  button{border:1px solid var(--border);background:#fff;color:var(--text);padding:9px 11px;border-radius:12px;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button:active{transform:translateY(1px)}
  .cfg,.filters{margin-top:12px;padding:12px;border-radius:var(--radius);background:var(--panel);border:1px solid var(--border);box-shadow:var(--shadow)}
  .cfgGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:980px){.cfgGrid{grid-template-columns:1fr}}
  .cfg label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px}
  .cfg input{width:100%;height:40px;padding:0 12px;border-radius:12px;background:#fff;border:1px solid var(--border);color:var(--text)}
  .cfgActions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .filters .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;align-items:end}
  .field label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px}
  .field input,.field select{width:100%;height:38px;padding:0 10px;border-radius:12px;background:#fff;border:1px solid var(--border);color:var(--text)}
  .field select:disabled{opacity:.6}
  .ok{color:#0f8a3b;font-weight:700;font-size:12px;margin-top:8px}
  .err{color:#b42318;font-weight:700;font-size:12px;margin-top:8px}
  .cards{margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;min-height:72px;position:relative;overflow:hidden;box-shadow:var(--shadow)}
  .card:before{content:"";position:absolute;right:-16px;top:-16px;width:76px;height:76px;border-radius:999px;background:rgba(215,38,47,.10)}
  .card .t{font-size:11px;color:#374151}
  .card .v{font-size:20px;font-weight:900;margin-top:4px;line-height:1.05}
  .card .s{font-size:11px;color:var(--muted);margin-top:2px}
  .panels{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:980px){.panels{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;min-height:240px;box-shadow:var(--shadow)}
  .panel h3{margin:0 0 8px;font-size:12px;color:#111827}
  canvas{width:100%!important;height:180px!important;display:block}
  .tablePanel{margin-top:10px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .tablePanel h3{margin:0 0 10px;font-size:12px}
  .tableWrap{overflow:auto;max-width:100%;border-radius:14px;border:1px solid var(--border);background:#fff}
  table{border-collapse:collapse;width:max-content;min-width:1600px;background:#fff}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);white-space:nowrap;font-size:12px;color:#111827}
  th{position:sticky;top:0;background:#0b1220;color:#fff;z-index:1;text-transform:uppercase;font-size:11px;letter-spacing:.4px}
  tr:hover td{background:#f7f8fc}
  .note{margin-top:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logoBox"><img src="data:image/png;base64,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" alt="Xtreme Mining" /></div>
      <div class="titles">
        <h1>Dashboard Seguimiento – Hormigón / CNC</h1>
        <p>Xtreme Mining · Fuente: Google Sheets (CSV publicado)</p>
      </div>
    </div>
    <div class="actions">
      <button id="btnConfig">Configurar fuente</button>
      <button id="btnClear">Limpiar filtros</button>
      <button class="primary" id="btnRefresh">Actualizar</button>
    </div>
  </header>

  <section class="cfg" id="cfgBox" style="display:none">
    <div class="cfgGrid">
      <div>
        <label>URL CSV publicado</label>
        <input id="csvUrl" placeholder="Pega aquí el link ...output=csv" />
        <div class="note">Debe contener <b>output=csv</b>.</div>
      </div>
      <div>
        <label>Logo (opcional): URL pública o ruta local (ej: <b>logo_xtreme.png</b>)</label>
        <input id="logoUrl" placeholder="Ej: logo_xtreme.png" />
        <div class="note">Si usas archivo local, déjalo en la misma carpeta del HTML.</div>
      </div>
    </div>
    <div class="cfgActions">
      <button class="primary" id="btnSaveCfg">Guardar</button>
    </div>
    <div id="cfgMsg"></div>
  </section>

  <section class="filters">
    <div class="row">
      <div class="field"><label>Buscar (texto libre)</label><input id="q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." /></div>
      <div class="field"><label>GRADO</label><select id="f_grado"></select></div>
      <div class="field"><label>SUMINISTRO</label><select id="f_suministro"></select></div>
      <div class="field"><label>TURNO</label><select id="f_turno"></select></div>
      <div class="field"><label>GRUPO</label><select id="f_grupo"></select></div>
      <div class="field"><label>SALA_CONTROL</label><select id="f_sala"></select></div>
      <div class="field"><label>MINA</label><select id="f_mina"></select></div>
      <div class="field"><label>LABOR_POSTURA</label><select id="f_labor"></select></div>
      <div class="field"><label>CNC_NIVEL 2</label><select id="f_cnc2"></select></div>
      <div class="field"><label>CNC_NIVEL 1</label><select id="f_cnc1"></select></div>
      <div class="field"><label>RESPONSABLE_CNC</label><select id="f_resp"></select></div>
      <div class="field"><label>MES</label><select id="f_mes"></select></div>
      <div class="field"><label>SEMANA</label><select id="f_semana"></select></div>
      <div class="field"><label>FECHA</label><select id="f_fecha"></select></div>
    </div>
    <div class="ok" id="status"></div>
    <div class="err" id="error" style="display:none"></div>
  </section>

  <section class="cards">
    <div class="card"><div class="t">REGISTROS FILTRADOS</div><div class="v" id="k_regs">0</div><div class="s">Total visible según filtros</div></div>
    <div class="card"><div class="t">m³ PLANIFICADO (suma)</div><div class="v" id="k_plan">0</div><div class="s">Suma columna PLANIFICADO</div></div>
    <div class="card"><div class="t">m³ SUMINISTRADO (suma)</div><div class="v" id="k_sum">0</div><div class="s">Suma columna SUMINISTRADO</div></div>
    <div class="card"><div class="t">PENDIENTE (suma)</div><div class="v" id="k_pend">0</div><div class="s">Suma columna PENDIENTE</div></div>
    <div class="card"><div class="t">RECHAZADO (suma)</div><div class="v" id="k_rech">0</div><div class="s">Suma columna RECHAZADO</div></div>
  </section>

  <section class="panels">
    <div class="panel"><h3>Incidentes por CNC_NIVEL 1 (TOP 10)</h3><canvas id="ch_cnc1"></canvas></div>
    <div class="panel"><h3>Distribución por RESPONSABLE_CNC</h3><canvas id="ch_resp"></canvas></div>
  </section>

  <section class="panels">
    <div class="panel"><h3>m³ por MINA (Planificado vs Suministrado)</h3><canvas id="ch_mina"></canvas></div>
    <div class="panel"><h3>m³ por FECHA (Planificado vs Suministrado)</h3><canvas id="ch_fecha"></canvas></div>
  </section>

  <section class="tablePanel">
    <h3>Detalle (todas las columnas)</h3>
    <div class="tableWrap"><table id="tbl"></table></div>
    <div class="note">La barra lateral aparece en esta tabla para ver todas las columnas.</div>
  </section>
</div>

<script>
const DEFAULT_CSV_URL = "";
const LS_KEY_URL  = "xtreme_hormigon_csv_url";
const LS_KEY_LOGO = "xtreme_hormigon_logo_url";

function parseCSV(text){
  const rows=[]; let row=[], cur="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'){ if(inQ && n==='"'){cur+='"'; i++;} else inQ=!inQ; }
    else if(c===',' && !inQ){ row.push(cur); cur=""; }
    else if((c==='\n' || c==='\r') && !inQ){ if(c==='\r'&&n==='\n') i++; row.push(cur); rows.push(row); row=[]; cur=""; }
    else cur+=c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r=>r.some(v=>(v||"").trim()!==""));
}
function toNumber(v){
  if(v==null) return 0;
  const s=String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"").trim();
  const n=Number(s); return Number.isFinite(n)?n:0;
}
function fmt(n){ return new Intl.NumberFormat("es-CL",{maximumFractionDigits:0}).format(n); }

let RAW=[], COLS=[], COL_MAP=new Map(), CH={};
const el=(id)=>document.getElementById(id);

function cleanHeader(s){
  return String(s??"").replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim().replace(/\s+/g," ");
}
function norm(s){ return cleanHeader(s).toLowerCase().replace(/\s+/g,"_"); }

function showError(msg){ el("error").style.display="block"; el("error").textContent=msg; }
function clearError(){ el("error").style.display="none"; el("error").textContent=""; }

function getCsvUrl(){ return localStorage.getItem(LS_KEY_URL) || DEFAULT_CSV_URL || ""; }
function setCsvUrl(url){ localStorage.setItem(LS_KEY_URL, url); }
function getLogoUrl(){ return localStorage.getItem(LS_KEY_LOGO) || ""; }
function setLogoUrl(url){ localStorage.setItem(LS_KEY_LOGO, url); }

function applyLogo(){
  const box=el("logoBox"); const fallback=el("logoFallback");
  const url=getLogoUrl(); box.innerHTML="";
  if(url){
    const img=document.createElement("img");
    img.src=url; img.alt="Logo";
    img.onerror=()=>{ box.innerHTML=""; box.appendChild(fallback); };
    box.appendChild(img);
  } else box.appendChild(fallback);
}

async function loadData(){
  clearError(); applyLogo();
  const url=getCsvUrl();
  if(!url){ showError("Falta configurar la URL CSV. Presiona “Configurar fuente” y pega el link CSV publicado."); el("status").textContent=""; return; }
  el("status").textContent="Cargando CSV…";
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("No se pudo descargar CSV ("+res.status+")");
  const text=await res.text();
  const rows=parseCSV(text);
  if(rows.length<2) throw new Error("CSV vacío o con formato inesperado.");
  const headers=rows[0].map(h=>cleanHeader(h));
  COLS=headers;
  COL_MAP=new Map();
  headers.forEach(h=>COL_MAP.set(norm(h), h));
  RAW=rows.slice(1).map(r=>{
    const o={};
    headers.forEach((h,i)=> o[h]=(r[i]??"").trim());
    return o;
  });
  el("status").textContent="CSV cargado: "+RAW.length+" filas.";
  buildFilters();
  applyFilters();
}

function findCol(...candidates){
  for(const cand of candidates){
    const k=norm(cand);
    if(COL_MAP.has(k)) return COL_MAP.get(k);
  }
  return null;
}
function unique(arr){
  return Array.from(new Set(arr.filter(v=>(v??"").toString().trim()!=="").map(v=>v.toString().trim())))
    .sort((a,b)=>String(a).localeCompare(String(b),"es",{numeric:true}));
}
function setSelectOptions(sel, values){
  sel.innerHTML="";
  const all=document.createElement("option"); all.value=""; all.textContent="Todos"; sel.appendChild(all);
  values.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
}
const FILTERS=[
  {sel:"f_grado", cols:["GRADO"]},
  {sel:"f_suministro", cols:["SUMINISTRO"]},
  {sel:"f_turno", cols:["TURNO"]},
  {sel:"f_grupo", cols:["GRUPO"]},
  {sel:"f_sala", cols:["SALA_CONTROL","SALA CONTROL","SALA_DE_CONTROL","SALA DE CONTROL"]},
  {sel:"f_mina", cols:["MINA"]},
  {sel:"f_labor", cols:["LABOR_POSTURA","LABOR POSTURA"]},
  {sel:"f_cnc2", cols:["CNC_NIVEL 2","CNC_NIVEL_2","CNC NIVEL 2"]},
  {sel:"f_cnc1", cols:["CNC_NIVEL 1","CNC_NIVEL_1","CNC NIVEL 1"]},
  {sel:"f_resp", cols:["RESPONSABLE_CNC","RESPONSABLE CNC"]},
  {sel:"f_mes", cols:["MES"]},
  {sel:"f_semana", cols:["SEMANA"]},
  {sel:"f_fecha", cols:["FECHA"]},
];

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

function buildFilters(){
  FILTERS.forEach(f=>{
    const sel=el(f.sel);
    const col=findCol(...f.cols);
    if(!col){ sel.disabled=true; setSelectOptions(sel,[]); return; }
    sel.disabled=false;
    setSelectOptions(sel, unique(RAW.map(r=>r[col])));
    sel.onchange=applyFilters;
  });
  el("q").oninput = debounce(applyFilters,150);
}
function rowMatchesText(r,q){
  if(!q) return true;
  const s=q.toLowerCase();
  for(const c of COLS){
    const v=(r[c]||"").toString().toLowerCase();
    if(v.includes(s)) return true;
  }
  return false;
}
function applyFilters(){
  if(!RAW.length) return;
  const q=(el("q").value||"").trim();
  const active={};
  FILTERS.forEach(f=>{
    const sel=el(f.sel);
    if(!sel || sel.disabled) return;
    const col=findCol(...f.cols);
    if(!col) return;
    const v=sel.value||"";
    if(v) active[col]=v;
  });
  const filtered=RAW.filter(r=>{
    if(!rowMatchesText(r,q)) return false;
    for(const [col,val] of Object.entries(active)){
      if(String(r[col]||"")!==val) return false;
    }
    return true;
  });
  renderKPIs(filtered);
  renderCharts(filtered);
  renderTable(filtered);
}
function clearFilters(){
  el("q").value="";
  FILTERS.forEach(f=>{ const s=el(f.sel); if(s && !s.disabled) s.value=""; });
  applyFilters();
}

function renderKPIs(rows){
  el("k_regs").textContent=fmt(rows.length);
  const cPlan=findCol("PLANIFICADO","m3_PLANIFICADO","M3_PLANIFICADO");
  const cSum=findCol("SUMINISTRADO","m3_SUMINISTRADO","M3_SUMINISTRADO");
  const cPend=findCol("PENDIENTE");
  const cRech=findCol("RECHAZADO");
  el("k_plan").textContent=fmt(cPlan?rows.reduce((a,r)=>a+toNumber(r[cPlan]),0):0);
  el("k_sum").textContent =fmt(cSum ?rows.reduce((a,r)=>a+toNumber(r[cSum]),0):0);
  el("k_pend").textContent=fmt(cPend?rows.reduce((a,r)=>a+toNumber(r[cPend]),0):0);
  el("k_rech").textContent=fmt(cRech?rows.reduce((a,r)=>a+toNumber(r[cRech]),0):0);
}

function destroyChart(key){ if(CH[key]){ CH[key].destroy(); delete CH[key]; } }
function countBy(rows,col){
  const m=new Map(); if(!col) return m;
  rows.forEach(r=>{ const k=((r[col]||"(vacío)")+"").trim()||"(vacío)"; m.set(k,(m.get(k)||0)+1); });
  return m;
}
function topN(map,n){
  const arr=Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
}
function sumByKey(rows,keyCol,planCol,sumCol,n=12){
  const m=new Map();
  rows.forEach(r=>{
    const k=keyCol?((r[keyCol]||"(sin)")+""):"(sin)";
    const cur=m.get(k)||{plan:0,sum:0};
    if(planCol) cur.plan+=toNumber(r[planCol]);
    if(sumCol) cur.sum+=toNumber(r[sumCol]);
    m.set(k,cur);
  });
  const arr=Array.from(m.entries()).sort((a,b)=>(b[1].plan+b[1].sum)-(a[1].plan+a[1].sum)).slice(0,n);
  return {labels:arr.map(x=>x[0]), plan:arr.map(x=>Math.round(x[1].plan)), sum:arr.map(x=>Math.round(x[1].sum))};
}
function sumByDate(rows,dateCol,planCol,sumCol,n=35){
  const m=new Map();
  rows.forEach(r=>{
    const d=dateCol?(r[dateCol]||""):""; if(!d) return;
    const cur=m.get(d)||{plan:0,sum:0};
    if(planCol) cur.plan+=toNumber(r[planCol]);
    if(sumCol) cur.sum+=toNumber(r[sumCol]);
    m.set(d,cur);
  });
  const labels=Array.from(m.keys()).sort((a,b)=>{
    const pa=a.includes("/")?a.split("/").reverse().join("-"):a;
    const pb=b.includes("/")?b.split("/").reverse().join("-"):b;
    return new Date(pa)-new Date(pb);
  }).slice(-n);
  return {labels, plan:labels.map(d=>Math.round((m.get(d)||{plan:0}).plan)), sum:labels.map(d=>Math.round((m.get(d)||{sum:0}).sum))};
}

function renderCharts(rows){
  Chart.defaults.maintainAspectRatio=false;
  Chart.defaults.responsive=true;
  const cCnc1=findCol("CNC_NIVEL 1","CNC_NIVEL_1","CNC NIVEL 1");
  const cResp=findCol("RESPONSABLE_CNC","RESPONSABLE CNC");
  const cMina=findCol("MINA");
  const cFecha=findCol("FECHA");
  const cPlan=findCol("PLANIFICADO","m3_PLANIFICADO","M3_PLANIFICADO");
  const cSum=findCol("SUMINISTRADO","m3_SUMINISTRADO","M3_SUMINISTRADO");

  destroyChart("cnc1");
  const top=topN(countBy(rows,cCnc1),10);
  CH.cnc1=new Chart(el("ch_cnc1"),{type:"bar",data:{labels:top.labels,datasets:[{label:"Registros",data:top.values}]},
    options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}},y:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}}}}});

  destroyChart("resp");
  const dist=topN(countBy(rows,cResp),8);
  CH.resp=new Chart(el("ch_resp"),{type:"doughnut",data:{labels:dist.labels,datasets:[{data:dist.values}]},
    options:{plugins:{legend:{position:"bottom",labels:{color:"#374151",boxWidth:10}}}}});

  destroyChart("mina");
  const byMina=sumByKey(rows,cMina,cPlan,cSum,12);
  CH.mina=new Chart(el("ch_mina"),{type:"bar",data:{labels:byMina.labels,datasets:[{label:"Planificado",data:byMina.plan},{label:"Suministrado",data:byMina.sum}]},
    options:{plugins:{legend:{position:"bottom",labels:{color:"#374151",boxWidth:10}}},scales:{x:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}},y:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}}}}});

  destroyChart("fecha");
  const byFecha=sumByDate(rows,cFecha,cPlan,cSum,35);
  CH.fecha=new Chart(el("ch_fecha"),{type:"line",data:{labels:byFecha.labels,datasets:[{label:"Planificado",data:byFecha.plan,tension:.25},{label:"Suministrado",data:byFecha.sum,tension:.25}]},
    options:{plugins:{legend:{position:"bottom",labels:{color:"#374151",boxWidth:10}}},scales:{x:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}},y:{ticks:{color:"#374151"},grid:{color:"rgba(17,24,39,.10)"}}}}});
}

function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function renderTable(rows){
  const tbl=el("tbl");
  const thead="<thead><tr>"+COLS.map(h=>"<th>"+escapeHtml(h)+"</th>").join("")+"</tr></thead>";
  const limit=700;
  const body=rows.slice(0,limit).map(r=>"<tr>"+COLS.map(h=>"<td>"+escapeHtml(r[h]??"")+"</td>").join("")+"</tr>").join("");
  tbl.innerHTML=thead+"<tbody>"+body+"</tbody>";
}

el("btnRefresh").onclick=()=>loadData().catch(e=>showError(e.message));
el("btnClear").onclick=clearFilters;
el("btnConfig").onclick=()=>{
  const box=el("cfgBox");
  box.style.display=(box.style.display==="none")?"block":"none";
  el("csvUrl").value=getCsvUrl();
  el("logoUrl").value=getLogoUrl();
};
el("btnSaveCfg").onclick=()=>{
  const url=(el("csvUrl").value||"").trim();
  const logo=(el("logoUrl").value||"").trim();
  const msg=el("cfgMsg");
  if(!url || !url.includes("output=csv")){
    msg.innerHTML='<div class="err">Pega un link CSV publicado (debe contener <b>output=csv</b>).</div>';
    return;
  }
  setCsvUrl(url); setLogoUrl(logo);
  applyLogo();
  msg.innerHTML='<div class="ok">Guardado ✅. Presiona “Actualizar”.</div>';
};

window.addEventListener("DOMContentLoaded",()=>loadData().catch(e=>showError(e.message)));
</script>
</body>
</html>
