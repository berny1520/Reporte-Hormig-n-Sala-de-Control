<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Seguimiento – Hormigón / CNC</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg1:#0b1020; --bg2:#1a0f1f;
    --card:#0f172a; --panel:#0b1220; --white:#fff;
    --muted:#aab3c5; --line:rgba(255,255,255,.08);
    --accent:#ff4d4d; --good:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--white);
    background: radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.08), transparent 60%),
                radial-gradient(900px 500px at 80% 0%, rgba(255,77,77,.10), transparent 55%),
                linear-gradient(135deg,var(--bg1),var(--bg2));
  }
  .wrap{max-width:1320px; margin:16px auto 28px; padding:0 14px;}
  header{
    display:flex; gap:14px; align-items:center; justify-content:space-between;
    padding:12px 14px; border-radius:18px; background:rgba(0,0,0,.25); border:1px solid var(--line);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logoBox{
    width:128px; height:56px; border-radius:14px;
    background:rgba(255,255,255,.08);
    display:flex; align-items:center; justify-content:center;
    font-weight:700; letter-spacing:.6px;
  }
  .titles h1{margin:0; font-size:19px; line-height:1.15}
  .titles p{margin:2px 0 0; color:var(--muted); font-size:12px}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  button{
    border:1px solid var(--line); background:rgba(255,255,255,.08);
    color:#fff; padding:9px 11px; border-radius:12px; cursor:pointer;
  }
  button.primary{background:linear-gradient(135deg,#ff5a5a,#ff2f2f); border-color:transparent}
  button.ghost{background:rgba(255,255,255,.06)}
  button:active{transform:translateY(1px)}
  .cfg{
    margin-top:12px; padding:12px; border-radius:18px;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
  }
  .cfgRow{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
  .cfg label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
  .cfg input{
    width:100%; height:40px; padding:0 12px; border-radius:12px;
    background:rgba(0,0,0,.25); border:1px solid var(--line); color:#fff;
  }
  .ok{color:var(--good); font-weight:600; font-size:12px; margin-top:8px}
  .err{color:#ffb4b4; font-weight:600; font-size:12px; margin-top:8px}

  .filters{
    margin-top:12px; padding:12px; border-radius:18px;
    background:rgba(255,255,255,.04); border:1px solid var(--line);
  }
  .filters .row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:10px; align-items:end;
  }
  .field label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
  .field input,.field select{
    width:100%; height:38px; padding:0 10px; border-radius:12px;
    background:rgba(0,0,0,.25); border:1px solid var(--line); color:#fff;
  }

  .cards{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap:10px;
  }
  .card{
    background:rgba(255,255,255,.04);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    min-height:72px;
    position:relative; overflow:hidden;
  }
  .card:before{
    content:""; position:absolute; right:-14px; top:-14px;
    width:72px; height:72px; border-radius:999px;
    background:rgba(255,77,77,.12);
  }
  .card .t{font-size:11px; color:#dce2f2; opacity:.92}
  .card .v{font-size:20px; font-weight:800; margin-top:4px; line-height:1.05}
  .card .s{font-size:11px; color:var(--muted); margin-top:2px}

  .panels{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width:980px){ .panels{grid-template-columns:1fr;} }
  .panel{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    min-height:260px;
  }
  .panel h3{margin:0 0 8px; font-size:12px; color:#eef2ff}
  canvas{width:100%!important; height:190px!important; display:block}

  .tablePanel{
    margin-top:10px;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
  }
  .tablePanel h3{margin:0 0 10px; font-size:12px}
  .tableWrap{overflow:auto; max-width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.06)}
  table{
    border-collapse:collapse;
    width:max-content;
    min-width:1600px; /* fuerza barra lateral */
    background:rgba(0,0,0,.22);
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid rgba(255,255,255,.06);
    white-space:nowrap;
    font-size:12px;
  }
  th{
    position:sticky; top:0;
    background:rgba(10,14,26,.92);
    z-index:1;
    text-transform:uppercase;
    font-size:11px;
    letter-spacing:.4px;
  }
  tr:hover td{background:rgba(255,255,255,.03)}
  .note{margin-top:8px; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logoBox">XTREME</div>
        <div class="titles">
          <h1>Dashboard Seguimiento – Hormigón / CNC</h1>
          <p>Xtreme Mining · Fuente: Google Sheets (CSV publicado)</p>
        </div>
      </div>
      <div class="actions">
        <button class="ghost" id="btnConfig">Configurar fuente</button>
        <button class="ghost" id="btnClear">Limpiar filtros</button>
        <button class="primary" id="btnRefresh">Actualizar</button>
      </div>
    </header>

    <section class="cfg" id="cfgBox" style="display:none">
      <div class="cfgRow">
        <div>
          <label>URL CSV publicado (Google Sheets → Publicar en la web → CSV)</label>
          <input id="csvUrl" placeholder="Pega aquí el link ...output=csv" />
          <div class="note">Tip: debe verse como <b>docs.google.com/spreadsheets/d/e/.../pub?...&output=csv</b> (no el link normal de editar).</div>
          <div id="cfgMsg"></div>
        </div>
        <button class="primary" id="btnSaveUrl">Guardar</button>
      </div>
    </section>

    <section class="filters">
      <div class="row">
        <div class="field">
          <label>Buscar (texto libre)</label>
          <input id="q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." />
        </div>

        <div class="field"><label>MES</label><select id="f_mes"></select></div>
        <div class="field"><label>SEMANA</label><select id="f_semana"></select></div>
        <div class="field"><label>TURNO</label><select id="f_turno"></select></div>
        <div class="field"><label>GRADO</label><select id="f_grado"></select></div>
        <div class="field"><label>SUMINISTRO</label><select id="f_suministro"></select></div>
        <div class="field"><label>SALA DE CONTROL</label><select id="f_sala"></select></div>
        <div class="field"><label>CNC_NIVEL 1</label><select id="f_cnc1"></select></div>
        <div class="field"><label>RESPONSABLE_CNC</label><select id="f_resp"></select></div>
        <div class="field"><label>FECHA</label><select id="f_fecha"></select></div>
        <div class="field"><label>MINA</label><select id="f_mina"></select></div>
        <div class="field"><label>GRUPO</label><select id="f_grupo"></select></div>
      </div>
      <div class="ok" id="status"></div>
      <div class="err" id="error" style="display:none"></div>
    </section>

    <section class="cards">
      <div class="card"><div class="t">REGISTROS FILTRADOS</div><div class="v" id="k_regs">0</div><div class="s">Total visible según filtros</div></div>
      <div class="card"><div class="t">m³ PLANIFICADO (suma)</div><div class="v" id="k_plan">0</div><div class="s">Suma columna PLANIFICADO</div></div>
      <div class="card"><div class="t">m³ SUMINISTRADO (suma)</div><div class="v" id="k_sum">0</div><div class="s">Suma columna SUMINISTRADO</div></div>
      <div class="card"><div class="t">PENDIENTE (suma)</div><div class="v" id="k_pend">0</div><div class="s">Suma columna PENDIENTE</div></div>
      <div class="card"><div class="t">RECHAZADO (suma)</div><div class="v" id="k_rech">0</div><div class="s">Suma columna RECHAZADO</div></div>
    </section>

    <section class="panels">
      <div class="panel">
        <h3>Incidentes por CNC_NIVEL 1 (TOP 10)</h3>
        <canvas id="ch_cnc1"></canvas>
      </div>
      <div class="panel">
        <h3>Distribución por RESPONSABLE_CNC</h3>
        <canvas id="ch_resp"></canvas>
      </div>
    </section>

    <section class="panels">
      <div class="panel">
        <h3>m³ por MINA (Planificado vs Suministrado)</h3>
        <canvas id="ch_mina"></canvas>
      </div>
      <div class="panel">
        <h3>m³ por FECHA (Planificado vs Suministrado)</h3>
        <canvas id="ch_fecha"></canvas>
      </div>
    </section>

    <section class="tablePanel">
      <h3>Detalle (todas las columnas)</h3>
      <div class="tableWrap">
        <table id="tbl"></table>
      </div>
      <div class="note">La barra lateral aparece aquí para ver todas las columnas (la página no se desborda).</div>
    </section>

  </div>

<script>
/** =======================
 *  CONFIG
 *  ======================= */
const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv"; // opcional: pega aquí tu CSV para que cargue automático
const LS_KEY = "xtreme_hormigon_csv_url";

/** =======================
 *  CSV PARSER (simple, robusto)
 *  ======================= */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"' ){
      if (inQuotes && n === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes){
      row.push(cur); cur="";
    } else if ((c === '\n' || c === '\r') && !inQuotes){
      if (c === '\r' && n === '\n') i++;
      row.push(cur); rows.push(row);
      row=[]; cur="";
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  // remove empty trailing rows
  return rows.filter(r => r.some(v => (v||"").trim() !== ""));
}

function toNumber(v){
  if (v == null) return 0;
  const s = String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function fmt(n){
  return new Intl.NumberFormat("es-CL", { maximumFractionDigits: 0 }).format(n);
}

/** =======================
 *  STATE
 *  ======================= */
let RAW = [];           // array of objects
let COLS = [];          // headers
let CH = {};            // charts

const el = (id)=>document.getElementById(id);

function showError(msg){
  el("error").style.display = "block";
  el("error").textContent = msg;
}
function clearError(){
  el("error").style.display = "none";
  el("error").textContent = "";
}

/** =======================
 *  SOURCE (CSV URL)
 *  ======================= */
function getCsvUrl(){
  return localStorage.getItem(LS_KEY) || DEFAULT_CSV_URL || "";
}
function setCsvUrl(url){
  localStorage.setItem(LS_KEY, url);
}

/** =======================
 *  LOAD DATA
 *  ======================= */
async function loadData(){
  clearError();
  const url = getCsvUrl();
  if(!url){
    showError("Falta configurar la URL CSV. Presiona “Configurar fuente” y pega el link CSV publicado.");
    el("status").textContent = "";
    return;
  }
  el("status").textContent = "Cargando CSV…";
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("No se pudo descargar CSV (" + res.status + ")");
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length < 2) throw new Error("CSV vacío o con formato inesperado.");
  COLS = rows[0].map(h => (h||"").trim());
  RAW = rows.slice(1).map(r => {
    const obj = {};
    COLS.forEach((h, i) => obj[h] = (r[i] ?? "").trim());
    return obj;
  });
  el("status").textContent = "CSV cargado: " + RAW.length + " filas.";
  buildFilters();
  applyFilters();
}

/** =======================
 *  FILTERS
 *  ======================= */
const FILTER_MAP = [
  ["MES","f_mes"],
  ["SEMANA","f_semana"],
  ["TURNO","f_turno"],
  ["GRADO","f_grado"],
  ["SUMINISTRO","f_suministro"],
  ["SALA DE CONTROL","f_sala"],
  ["SALA_CONTROL","f_sala"],
  ["CNC_NIVEL 1","f_cnc1"],
  ["CNC_NIVEL_1","f_cnc1"],
  ["RESPONSABLE_CNC","f_resp"],
  ["FECHA","f_fecha"],
  ["MINA","f_mina"],
  ["GRUPO","f_grupo"]
];

function findCol(possible){
  // exact match first
  if (COLS.includes(possible)) return possible;
  // case-insensitive / underscores
  const norm = s => s.toLowerCase().replace(/\s+/g,"_");
  const p = norm(possible);
  for (const c of COLS){
    if (norm(c) === p) return c;
  }
  return null;
}

function setSelectOptions(sel, values){
  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Todos";
  sel.appendChild(optAll);
  values.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

function buildFilters(){
  // prepare selects
  const colBySelect = {};
  for (const [colName, selId] of FILTER_MAP){
    const col = findCol(colName);
    if (!col) continue;
    colBySelect[selId] = col;
  }

  const unique = (arr)=>Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),"es",{numeric:true}));

  for (const selId of Object.keys(colBySelect)){
    const col = colBySelect[selId];
    const values = unique(RAW.map(r=>r[col]));
    setSelectOptions(el(selId), values);
    el(selId).onchange = applyFilters;
  }

  el("q").oninput = debounce(applyFilters, 150);
}

function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

function rowMatchesText(r, q){
  if(!q) return true;
  const s = q.toLowerCase();
  for(const c of COLS){
    const v = (r[c]||"").toString().toLowerCase();
    if(v.includes(s)) return true;
  }
  return false;
}

function applyFilters(){
  if(!RAW.length) return;

  const q = (el("q").value || "").trim();
  // map select->col
  const active = {};
  for (const [colName, selId] of FILTER_MAP){
    const col = findCol(colName);
    if(!col) continue;
    const v = el(selId)?.value || "";
    if(v) active[col] = v;
  }

  const filtered = RAW.filter(r=>{
    if(!rowMatchesText(r,q)) return false;
    for(const [col,val] of Object.entries(active)){
      if(String(r[col]||"") !== val) return false;
    }
    return true;
  });

  renderKPIs(filtered);
  renderCharts(filtered);
  renderTable(filtered);
}

function clearFilters(){
  el("q").value = "";
  ["f_mes","f_semana","f_turno","f_grado","f_suministro","f_sala","f_cnc1","f_resp","f_fecha","f_mina","f_grupo"]
    .forEach(id=>{ if(el(id)) el(id).value=""; });
  applyFilters();
}

/** =======================
 *  KPIs
 *  ======================= */
function renderKPIs(rows){
  el("k_regs").textContent = fmt(rows.length);

  const cPlan = findCol("PLANIFICADO") || findCol("m3_PLANIFICADO") || findCol("M3_PLANIFICADO");
  const cSum  = findCol("SUMINISTRADO") || findCol("m3_SUMINISTRADO") || findCol("M3_SUMINISTRADO");
  const cPend = findCol("PENDIENTE");
  const cRech = findCol("RECHAZADO");

  const sPlan = cPlan ? rows.reduce((a,r)=>a+toNumber(r[cPlan]),0) : 0;
  const sSum  = cSum  ? rows.reduce((a,r)=>a+toNumber(r[cSum]),0)  : 0;
  const sPend = cPend ? rows.reduce((a,r)=>a+toNumber(r[cPend]),0) : 0;
  const sRech = cRech ? rows.reduce((a,r)=>a+toNumber(r[cRech]),0) : 0;

  el("k_plan").textContent = fmt(sPlan);
  el("k_sum").textContent  = fmt(sSum);
  el("k_pend").textContent = fmt(sPend);
  el("k_rech").textContent = fmt(sRech);
}

/** =======================
 *  CHARTS
 *  ======================= */
function destroyChart(key){
  if(CH[key]){ CH[key].destroy(); delete CH[key]; }
}
function renderCharts(rows){
  // defaults
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.responsive = true;

  const cCnc1 = findCol("CNC_NIVEL 1") || findCol("CNC_NIVEL_1") || findCol("CNC_NIVEL1");
  const cResp = findCol("RESPONSABLE_CNC");
  const cMina = findCol("MINA");
  const cFecha = findCol("FECHA");
  const cPlan = findCol("PLANIFICADO") || findCol("m3_PLANIFICADO") || findCol("M3_PLANIFICADO");
  const cSum  = findCol("SUMINISTRADO") || findCol("m3_SUMINISTRADO") || findCol("M3_SUMINISTRADO");

  // 1) TOP CNC1
  destroyChart("cnc1");
  const top = topN(countBy(rows, cCnc1), 10);
  CH.cnc1 = new Chart(el("ch_cnc1"), {
    type:"bar",
    data:{ labels: top.labels, datasets:[{ label:"Registros", data: top.values }] },
    options:{
      plugins:{ legend:{display:false}},
      scales:{
        x:{ ticks:{ color:"#cbd5e1"} , grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"#cbd5e1"} , grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  // 2) Responsables
  destroyChart("resp");
  const dist = topN(countBy(rows, cResp), 8);
  CH.resp = new Chart(el("ch_resp"),{
    type:"doughnut",
    data:{ labels: dist.labels, datasets:[{ data: dist.values }] },
    options:{
      plugins:{ legend:{ position:"bottom", labels:{ color:"#cbd5e1", boxWidth:10 } } }
    }
  });

  // 3) Mina plan vs sum
  destroyChart("mina");
  const byMina = sumByKey(rows, cMina, cPlan, cSum, 12);
  CH.mina = new Chart(el("ch_mina"),{
    type:"bar",
    data:{
      labels: byMina.labels,
      datasets:[
        { label:"Planificado", data: byMina.plan },
        { label:"Suministrado", data: byMina.sum }
      ]
    },
    options:{
      plugins:{ legend:{ position:"bottom", labels:{ color:"#cbd5e1", boxWidth:10 } } },
      scales:{
        x:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  // 4) Fecha plan vs sum (línea)
  destroyChart("fecha");
  const byFecha = sumByDate(rows, cFecha, cPlan, cSum, 35);
  CH.fecha = new Chart(el("ch_fecha"),{
    type:"line",
    data:{
      labels: byFecha.labels,
      datasets:[
        { label:"Planificado", data: byFecha.plan, tension:.25 },
        { label:"Suministrado", data: byFecha.sum, tension:.25 }
      ]
    },
    options:{
      plugins:{ legend:{ position:"bottom", labels:{ color:"#cbd5e1", boxWidth:10 } } },
      scales:{
        x:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });
}

function countBy(rows, col){
  const m = new Map();
  if(!col) return m;
  rows.forEach(r=>{
    const k = (r[col]||"(vacío)").trim() || "(vacío)";
    m.set(k, (m.get(k)||0)+1);
  });
  return m;
}
function topN(map, n){
  const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  return { labels: arr.map(x=>x[0]), values: arr.map(x=>x[1]) };
}
function sumByKey(rows, keyCol, planCol, sumCol, n=12){
  const m = new Map();
  rows.forEach(r=>{
    const k = keyCol ? ((r[keyCol]||"(sin)")+ "") : "(sin)";
    const cur = m.get(k) || {plan:0,sum:0};
    if(planCol) cur.plan += toNumber(r[planCol]);
    if(sumCol) cur.sum += toNumber(r[sumCol]);
    m.set(k, cur);
  });
  const arr = Array.from(m.entries()).sort((a,b)=>(b[1].plan+b[1].sum)-(a[1].plan+a[1].sum)).slice(0,n);
  return { labels: arr.map(x=>x[0]), plan: arr.map(x=>Math.round(x[1].plan)), sum: arr.map(x=>Math.round(x[1].sum)) };
}
function sumByDate(rows, dateCol, planCol, sumCol, n=35){
  const m = new Map();
  rows.forEach(r=>{
    const d = dateCol ? (r[dateCol]||"") : "";
    if(!d) return;
    const cur = m.get(d) || {plan:0,sum:0};
    if(planCol) cur.plan += toNumber(r[planCol]);
    if(sumCol) cur.sum += toNumber(r[sumCol]);
    m.set(d, cur);
  });
  const labels = Array.from(m.keys()).sort((a,b)=>new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).slice(-n);
  return {
    labels,
    plan: labels.map(d=>Math.round((m.get(d)||{plan:0}).plan)),
    sum: labels.map(d=>Math.round((m.get(d)||{sum:0}).sum)),
  };
}

/** =======================
 *  TABLE
 *  ======================= */
function renderTable(rows){
  const tbl = el("tbl");
  // header
  let thead = "<thead><tr>" + COLS.map(h=>`<th>${escapeHtml(h)}</th>`).join("") + "</tr></thead>";
  // body (limit for performance)
  const limit = 500; // keep fast; you can raise
  const bodyRows = rows.slice(0, limit).map(r=>{
    return "<tr>" + COLS.map(h=>`<td>${escapeHtml(r[h] ?? "")}</td>`).join("") + "</tr>";
  }).join("");
  let tbody = "<tbody>" + bodyRows + "</tbody>";
  tbl.innerHTML = thead + tbody;
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/** =======================
 *  UI
 *  ======================= */
el("btnRefresh").onclick = ()=>loadData().catch(e=>showError(e.message));
el("btnClear").onclick = clearFilters;
el("btnConfig").onclick = ()=>{
  const box = el("cfgBox");
  box.style.display = (box.style.display==="none") ? "block" : "none";
  el("csvUrl").value = getCsvUrl();
};
el("btnSaveUrl").onclick = ()=>{
  const url = (el("csvUrl").value||"").trim();
  const msg = el("cfgMsg");
  msg.className = "";
  if(!url || !url.includes("output=csv")){
    msg.innerHTML = '<div class="err">Pega un link CSV publicado (debe contener <b>output=csv</b>).</div>';
    return;
  }
  setCsvUrl(url);
  msg.innerHTML = '<div class="ok">Guardado ✅. Presiona “Actualizar”.</div>';
};

window.addEventListener("DOMContentLoaded", ()=>{
  // preload URL if exists
  const url = getCsvUrl();
  if(url) el("csvUrl").value = url;
  // auto-load
  loadData().catch(e=>showError(e.message));
});
</script>
</body>
</html>
