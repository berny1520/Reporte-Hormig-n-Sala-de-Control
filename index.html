<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Seguimiento – Hormigón / CNC</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb;
    --panel:#ffffff;
    --border:#e6e9f2;
    --text:#111827;
    --muted:#6b7280;
    --accent:#d7262f;      /* rojo Xtreme */
    --accent2:#0b5ed7;     /* azul */
    --shadow: 0 8px 24px rgba(16,24,40,.08);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:var(--bg);
  }
  .wrap{max-width:1320px; margin:14px auto 26px; padding:0 14px;}
  header{
    display:flex; gap:14px; align-items:center; justify-content:space-between;
    padding:12px 14px; border-radius:var(--radius);
    background:var(--panel); border:1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logoBox{
    width:128px; height:56px; border-radius:14px;
    background:#fff;
    border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; letter-spacing:.6px;
  }
  .titles h1{margin:0; font-size:18px; line-height:1.15}
  .titles p{margin:2px 0 0; color:var(--muted); font-size:12px}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  button{
    border:1px solid var(--border); background:#fff;
    color:var(--text); padding:9px 11px; border-radius:12px; cursor:pointer;
  }
  button.primary{background:var(--accent); border-color:var(--accent); color:#fff}
  button.ghost{background:#fff}
  button:active{transform:translateY(1px)}

  .cfg, .filters{
    margin-top:12px;
    padding:12px;
    border-radius:var(--radius);
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .cfgRow{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
  .cfg label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
  .cfg input{
    width:100%; height:40px; padding:0 12px; border-radius:12px;
    background:#fff; border:1px solid var(--border); color:var(--text);
  }

  .filters .row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:10px; align-items:end;
  }
  .field label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
  .field input,.field select{
    width:100%; height:38px; padding:0 10px; border-radius:12px;
    background:#fff; border:1px solid var(--border); color:var(--text);
  }

  .ok{color:#0f8a3b; font-weight:700; font-size:12px; margin-top:8px}
  .err{color:#b42318; font-weight:700; font-size:12px; margin-top:8px}

  .cards{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap:10px;
  }
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    min-height:72px;
    position:relative; overflow:hidden;
    box-shadow: var(--shadow);
  }
  .card:before{
    content:""; position:absolute; right:-16px; top:-16px;
    width:76px; height:76px; border-radius:999px;
    background:rgba(215,38,47,.10);
  }
  .card .t{font-size:11px; color:#374151}
  .card .v{font-size:20px; font-weight:900; margin-top:4px; line-height:1.05}
  .card .s{font-size:11px; color:var(--muted); margin-top:2px}

  .panels{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width:980px){ .panels{grid-template-columns:1fr;} }
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:12px;
    min-height:240px;
    box-shadow: var(--shadow);
  }
  .panel h3{margin:0 0 8px; font-size:12px; color:#111827}
  canvas{width:100%!important; height:180px!important; display:block}

  .tablePanel{
    margin-top:10px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:12px;
    box-shadow: var(--shadow);
  }
  .tablePanel h3{margin:0 0 10px; font-size:12px}
  .tableWrap{
    overflow:auto;
    max-width:100%;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
  }
  table{
    border-collapse:collapse;
    width:max-content;
    min-width:1600px; /* fuerza barra lateral */
    background:#fff;
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid var(--border);
    white-space:nowrap;
    font-size:12px;
    color:#111827;
  }
  th{
    position:sticky; top:0;
    background:#0b1220;
    color:#fff;
    z-index:1;
    text-transform:uppercase;
    font-size:11px;
    letter-spacing:.4px;
  }
  tr:hover td{background:#f7f8fc}
  .note{margin-top:8px; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo_Xtreme</div>
        <div class="titles">
          <h1>Dashboard Seguimiento – Hormigón / CNC</h1>
          <p>Xtreme Mining · Fuente: Google Sheets (CSV publicado)</p>
        </div>
      </div>
      <div class="actions">
        <button class="ghost" id="btnConfig">Configurar fuente</button>
        <button class="ghost" id="btnClear">Limpiar filtros</button>
        <button class="primary" id="btnRefresh">Actualizar</button>
      </div>
    </header>

    <section class="cfg" id="cfgBox" style="display:none">
      <div class="cfgRow">
        <div>
          <label>URL CSV publicado (Google Sheets → Publicar en la web → CSV)</label>
          <input id="csvUrl" placeholder="Pega aquí el link ...output=csv" />
          <div class="note">Debe verse como <b>docs.google.com/spreadsheets/d/e/.../pub?...&output=csv</b> (no el link de editar).</div>
          <div id="cfgMsg"></div>
        </div>
        <button class="primary" id="btnSaveUrl">Guardar</button>
      </div>
    </section>

    <section class="filters">
      <div class="row">
        <div class="field">
          <label>Buscar (texto libre)</label>
          <input id="q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." />
        </div>

        <div class="field"><label>MES</label><select id="f_mes"></select></div>
        <div class="field"><label>SEMANA</label><select id="f_semana"></select></div>
        <div class="field"><label>TURNO</label><select id="f_turno"></select></div>

        <div class="field"><label>GRADO</label><select id="f_grado"></select></div>
        <div class="field"><label>SUMINISTRO</label><select id="f_suministro"></select></div>
        <div class="field"><label>GRUPO</label><select id="f_grupo"></select></div>

        <div class="field"><label>SALA_CONTROL</label><select id="f_sala"></select></div>
        <div class="field"><label>MINA</label><select id="f_mina"></select></div>
        <div class="field"><label>LABOR_POSTURA</label><select id="f_labor"></select></div>

        <div class="field"><label>CNC_NIVEL_2</label><select id="f_cnc2"></select></div>
        <div class="field"><label>CNC_NIVEL_1</label><select id="f_cnc1"></select></div>
        <div class="field"><label>RESPONSABLE_CNC</label><select id="f_resp"></select></div>

        <div class="field"><label>FECHA</label><select id="f_fecha"></select></div>
      </div>

      <div class="ok" id="status"></div>
      <div class="err" id="error" style="display:none"></div>
    </section>

    <section class="cards">
      <div class="card"><div class="t">REGISTROS FILTRADOS</div><div class="v" id="k_regs">0</div><div class="s">Total visible según filtros</div></div>
      <div class="card"><div class="t">m³ PLANIFICADO (suma)</div><div class="v" id="k_plan">0</div><div class="s">Suma columna PLANIFICADO</div></div>
      <div class="card"><div class="t">m³ SUMINISTRADO (suma)</div><div class="v" id="k_sum">0</div><div class="s">Suma columna SUMINISTRADO</div></div>
      <div class="card"><div class="t">PENDIENTE (suma)</div><div class="v" id="k_pend">0</div><div class="s">Suma columna PENDIENTE</div></div>
      <div class="card"><div class="t">RECHAZADO (suma)</div><div class="v" id="k_rech">0</div><div class="s">Suma columna RECHAZADO</div></div>
    </section>

    <section class="panels">
      <div class="panel">
        <h3>Incidentes por CNC_NIVEL_1 (TOP 10)</h3>
        <canvas id="ch_cnc1"></canvas>
      </div>
      <div class="panel">
        <h3>Distribución por RESPONSABLE_CNC</h3>
        <canvas id="ch_resp"></canvas>
      </div>
    </section>

    <section class="panels">
      <div class="panel">
        <h3>m³ por MINA (Planificado vs Suministrado)</h3>
        <canvas id="ch_mina"></canvas>
      </div>
      <div class="panel">
        <h3>m³ por FECHA (Planificado vs Suministrado)</h3>
        <canvas id="ch_fecha"></canvas>
      </div>
    </section>

    <section class="tablePanel">
      <h3>Detalle (todas las columnas)</h3>
      <div class="tableWrap">
        <table id="tbl"></table>
      </div>
      <div class="note">La barra lateral aparece aquí para ver todas las columnas (la página no se desborda).</div>
    </section>

  </div>

<script>
const DEFAULT_CSV_URL = "";
const LS_KEY = "xtreme_hormigon_csv_url";

/* CSV parser */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"'){
      if (inQuotes && n === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes){
      row.push(cur); cur="";
    } else if ((c === '\n' || c === '\r') && !inQuotes){
      if (c === '\r' && n === '\n') i++;
      row.push(cur); rows.push(row);
      row=[]; cur="";
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(v => (v||"").trim() !== ""));
}
function toNumber(v){
  if (v == null) return 0;
  const s = String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmt(n){ return new Intl.NumberFormat("es-CL",{maximumFractionDigits:0}).format(n); }

let RAW = [];
let COLS = [];
let CH = {};

const el = (id)=>document.getElementById(id);

function showError(msg){
  el("error").style.display = "block";
  el("error").textContent = msg;
}
function clearError(){
  el("error").style.display = "none";
  el("error").textContent = "";
}
function getCsvUrl(){ return localStorage.getItem(LS_KEY) || DEFAULT_CSV_URL || ""; }
function setCsvUrl(url){ localStorage.setItem(LS_KEY, url); }

async function loadData(){
  clearError();
  const url = getCsvUrl();
  if(!url){
    showError("https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv");
    el("status").textContent = "";
    return;
  }
  el("status").textContent = "Cargando CSV…";
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("No se pudo descargar CSV ("+res.status+")");
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length < 2) throw new Error("CSV vacío o con formato inesperado.");
  COLS = rows[0].map(h => (h||"").trim());
  RAW = rows.slice(1).map(r => {
    const obj = {};
    COLS.forEach((h,i)=> obj[h] = (r[i] ?? "").trim());
    return obj;
  });
  el("status").textContent = "CSV cargado: " + RAW.length + " filas.";
  buildFilters();
  applyFilters();
}

/* Column matching helpers */
function findCol(possible){
  if (COLS.includes(possible)) return possible;
  const norm = s => s.toLowerCase().replace(/\s+/g,"_");
  const p = norm(possible);
  for (const c of COLS){
    if (norm(c) === p) return c;
  }
  return null;
}
function setSelectOptions(sel, values){
  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Todos";
  sel.appendChild(optAll);
  values.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}
const FILTER_MAP = [
  ["MES","f_mes"],
  ["SEMANA","f_semana"],
  ["TURNO","f_turno"],
  ["GRADO","f_grado"],
  ["SUMINISTRO","f_suministro"],
  ["GRUPO","f_grupo"],
  ["SALA_CONTROL","f_sala"],
  ["SALA DE CONTROL","f_sala"],
  ["MINA","f_mina"],
  ["LABOR_POSTURA","f_labor"],
  ["LABOR POSTURA","f_labor"],
  ["CNC_NIVEL_2","f_cnc2"],
  ["CNC_NIVEL 2","f_cnc2"],
  ["CNC_NIVEL_1","f_cnc1"],
  ["CNC_NIVEL 1","f_cnc1"],
  ["RESPONSABLE_CNC","f_resp"],
  ["FECHA","f_fecha"]
];

function unique(arr){
  return Array.from(new Set(arr.filter(Boolean)))
    .sort((a,b)=>String(a).localeCompare(String(b),"es",{numeric:true}));
}
function buildFilters(){
  // build only those that exist in CSV; hide missing fields (label+select container)
  FILTER_MAP.forEach(([colName, selId])=>{
    const sel = el(selId);
    if(!sel) return;
    const col = findCol(colName);
    const field = sel.closest(".field");
    if(!col){
      if(field) field.style.display = "none";
      return;
    }
    if(field) field.style.display = "";
    const values = unique(RAW.map(r=>r[col]));
    setSelectOptions(sel, values);
    sel.onchange = applyFilters;
  });

  el("q").oninput = debounce(applyFilters, 150);
}

function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function rowMatchesText(r, q){
  if(!q) return true;
  const s = q.toLowerCase();
  for(const c of COLS){
    const v = (r[c]||"").toString().toLowerCase();
    if(v.includes(s)) return true;
  }
  return false;
}

function applyFilters(){
  if(!RAW.length) return;
  const q = (el("q").value||"").trim();

  // active filter values per real column
  const active = {};
  FILTER_MAP.forEach(([colName, selId])=>{
    const col = findCol(colName);
    const sel = el(selId);
    if(!col || !sel) return;
    const v = sel.value || "";
    if(v) active[col] = v;
  });

  const filtered = RAW.filter(r=>{
    if(!rowMatchesText(r,q)) return false;
    for(const [col,val] of Object.entries(active)){
      if(String(r[col]||"") !== val) return false;
    }
    return true;
  });

  renderKPIs(filtered);
  renderCharts(filtered);
  renderTable(filtered);
}

function clearFilters(){
  el("q").value = "";
  FILTER_MAP.forEach(([,selId])=>{ const s=el(selId); if(s) s.value=""; });
  applyFilters();
}

/* KPIs */
function renderKPIs(rows){
  el("k_regs").textContent = fmt(rows.length);

  const cPlan = findCol("PLANIFICADO") || findCol("m3_PLANIFICADO") || findCol("M3_PLANIFICADO");
  const cSum  = findCol("SUMINISTRADO") || findCol("m3_SUMINISTRADO") || findCol("M3_SUMINISTRADO");
  const cPend = findCol("PENDIENTE");
  const cRech = findCol("RECHAZADO");

  const sPlan = cPlan ? rows.reduce((a,r)=>a+toNumber(r[cPlan]),0) : 0;
  const sSum  = cSum  ? rows.reduce((a,r)=>a+toNumber(r[cSum]),0)  : 0;
  const sPend = cPend ? rows.reduce((a,r)=>a+toNumber(r[cPend]),0) : 0;
  const sRech = cRech ? rows.reduce((a,r)=>a+toNumber(r[cRech]),0) : 0;

  el("k_plan").textContent = fmt(sPlan);
  el("k_sum").textContent  = fmt(sSum);
  el("k_pend").textContent = fmt(sPend);
  el("k_rech").textContent = fmt(sRech);
}

/* Charts */
function destroyChart(key){ if(CH[key]){ CH[key].destroy(); delete CH[key]; } }
function countBy(rows, col){
  const m = new Map();
  if(!col) return m;
  rows.forEach(r=>{
    const k = (r[col]||"(vacío)").trim() || "(vacío)";
    m.set(k, (m.get(k)||0)+1);
  });
  return m;
}
function topN(map, n){
  const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  return { labels: arr.map(x=>x[0]), values: arr.map(x=>x[1]) };
}
function sumByKey(rows, keyCol, planCol, sumCol, n=12){
  const m = new Map();
  rows.forEach(r=>{
    const k = keyCol ? ((r[keyCol]||"(sin)")+ "") : "(sin)";
    const cur = m.get(k) || {plan:0,sum:0};
    if(planCol) cur.plan += toNumber(r[planCol]);
    if(sumCol) cur.sum += toNumber(r[sumCol]);
    m.set(k, cur);
  });
  const arr = Array.from(m.entries()).sort((a,b)=>(b[1].plan+b[1].sum)-(a[1].plan+a[1].sum)).slice(0,n);
  return { labels: arr.map(x=>x[0]), plan: arr.map(x=>Math.round(x[1].plan)), sum: arr.map(x=>Math.round(x[1].sum)) };
}
function sumByDate(rows, dateCol, planCol, sumCol, n=35){
  const m = new Map();
  rows.forEach(r=>{
    const d = dateCol ? (r[dateCol]||"") : "";
    if(!d) return;
    const cur = m.get(d) || {plan:0,sum:0};
    if(planCol) cur.plan += toNumber(r[planCol]);
    if(sumCol) cur.sum += toNumber(r[sumCol]);
    m.set(d, cur);
  });
  const labels = Array.from(m.keys()).sort((a,b)=>{
    // supports dd/mm/yyyy or yyyy-mm-dd
    const pa = a.includes("/") ? a.split("/").reverse().join("-") : a;
    const pb = b.includes("/") ? b.split("/").reverse().join("-") : b;
    return new Date(pa) - new Date(pb);
  }).slice(-n);
  return { labels, plan: labels.map(d=>Math.round((m.get(d)||{plan:0}).plan)), sum: labels.map(d=>Math.round((m.get(d)||{sum:0}).sum)) };
}

function renderCharts(rows){
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.responsive = true;

  const cCnc1 = findCol("CNC_NIVEL_1") || findCol("CNC_NIVEL 1");
  const cResp = findCol("RESPONSABLE_CNC");
  const cMina = findCol("MINA");
  const cFecha = findCol("FECHA");
  const cPlan = findCol("PLANIFICADO") || findCol("m3_PLANIFICADO") || findCol("M3_PLANIFICADO");
  const cSum  = findCol("SUMINISTRADO") || findCol("m3_SUMINISTRADO") || findCol("M3_SUMINISTRADO");

  destroyChart("cnc1");
  const top = topN(countBy(rows, cCnc1), 10);
  CH.cnc1 = new Chart(el("ch_cnc1"), {
    type:"bar",
    data:{ labels: top.labels, datasets:[{ label:"Registros", data: top.values }] },
    options:{
      plugins:{ legend:{display:false}},
      scales:{
        x:{ ticks:{ color:"#374151"} , grid:{ color:"rgba(17,24,39,.10)" } },
        y:{ ticks:{ color:"#374151"} , grid:{ color:"rgba(17,24,39,.10)" } }
      }
    }
  });

  destroyChart("resp");
  const dist = topN(countBy(rows, cResp), 8);
  CH.resp = new Chart(el("ch_resp"),{
    type:"doughnut",
    data:{ labels: dist.labels, datasets:[{ data: dist.values }] },
    options:{ plugins:{ legend:{ position:"bottom", labels:{ color:"#374151", boxWidth:10 } } } }
  });

  destroyChart("mina");
  const byMina = sumByKey(rows, cMina, cPlan, cSum, 12);
  CH.mina = new Chart(el("ch_mina"),{
    type:"bar",
    data:{ labels: byMina.labels, datasets:[{ label:"Planificado", data: byMina.plan },{ label:"Suministrado", data: byMina.sum }] },
    options:{
      plugins:{ legend:{ position:"bottom", labels:{ color:"#374151", boxWidth:10 } } },
      scales:{
        x:{ ticks:{ color:"#374151" }, grid:{ color:"rgba(17,24,39,.10)" } },
        y:{ ticks:{ color:"#374151" }, grid:{ color:"rgba(17,24,39,.10)" } }
      }
    }
  });

  destroyChart("fecha");
  const byFecha = sumByDate(rows, cFecha, cPlan, cSum, 35);
  CH.fecha = new Chart(el("ch_fecha"),{
    type:"line",
    data:{ labels: byFecha.labels, datasets:[{ label:"Planificado", data: byFecha.plan, tension:.25 },{ label:"Suministrado", data: byFecha.sum, tension:.25 }] },
    options:{
      plugins:{ legend:{ position:"bottom", labels:{ color:"#374151", boxWidth:10 } } },
      scales:{
        x:{ ticks:{ color:"#374151" }, grid:{ color:"rgba(17,24,39,.10)" } },
        y:{ ticks:{ color:"#374151" }, grid:{ color:"rgba(17,24,39,.10)" } }
      }
    }
  });
}

/* Table */
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function renderTable(rows){
  const tbl = el("tbl");
  let thead = "<thead><tr>" + COLS.map(h=>`<th>${escapeHtml(h)}</th>`).join("") + "</tr></thead>";
  const limit = 700;
  const bodyRows = rows.slice(0, limit).map(r=>"<tr>"+COLS.map(h=>`<td>${escapeHtml(r[h] ?? "")}</td>`).join("")+"</tr>").join("");
  tbl.innerHTML = thead + "<tbody>"+bodyRows+"</tbody>";
}

/* UI */
el("btnRefresh").onclick = ()=>loadData().catch(e=>showError(e.message));
el("btnClear").onclick = clearFilters;
el("btnConfig").onclick = ()=>{
  const box = el("cfgBox");
  box.style.display = (box.style.display==="none") ? "block" : "none";
  el("csvUrl").value = getCsvUrl();
};
el("btnSaveUrl").onclick = ()=>{
  const url = (el("csvUrl").value||"").trim();
  const msg = el("cfgMsg");
  if(!url || !url.includes("output=csv")){
    msg.innerHTML = '<div class="err">Pega un link CSV publicado (debe contener <b>output=csv</b>).</div>';
    return;
  }
  setCsvUrl(url);
  msg.innerHTML = '<div class="ok">Guardado ✅. Presiona “Actualizar”.</div>';
};

window.addEventListener("DOMContentLoaded", ()=> loadData().catch(e=>showError(e.message)));
</script>
</body>
</html>
