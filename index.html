<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Seguimiento ‚Äì Hormig√≥n / CNC (Xtreme)</title>

  <!-- Libs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --dark:#0f172a;
      --accent:#ef4444;
      --accent2:#7c3aed;
      --shadow: 0 10px 28px rgba(0,0,0,.18);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:#111827;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(124,58,237,.24), transparent 55%),
                  radial-gradient(1200px 600px at 70% 0%, rgba(239,68,68,.22), transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:18px 14px 26px}
    header{
      display:flex;align-items:center;gap:14px;
      padding:14px 14px;border-radius:18px;
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.72));
      color:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.08);
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:260px;
      padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
    }
    .brand img{height:44px;width:auto;border-radius:10px;background:#fff;padding:6px}
    .brand .t1{font-weight:800;letter-spacing:.2px}
    .brand .t2{font-size:12px;color:rgba(255,255,255,.75);margin-top:2px}
    .spacer{flex:1}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn.red{background:linear-gradient(135deg, #ef4444, #b91c1c);border:0}
    .btn.red:hover{filter:brightness(1.05)}
    .btn.purple{background:linear-gradient(135deg,#7c3aed,#4c1d95);border:0}
    .btn.purple:hover{filter:brightness(1.05)}
    .grid{display:grid;gap:12px;margin-top:14px}
    .filters{
      background:var(--card);border-radius:var(--radius);
      padding:14px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.08);
    }
    .filters .row{display:grid;gap:10px}
    .row.r1{grid-template-columns: 1.2fr repeat(4, 1fr)}
    .row.r2{grid-template-columns: repeat(5, 1fr)}
    .row.r3{grid-template-columns: repeat(4, 1fr)}
    .field label{display:block;font-size:12px;font-weight:800;color:#111827;margin:0 0 6px}
    .field input,.field select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .bad{color:#dc2626;font-weight:700}

    .kpis{display:grid;gap:12px;grid-template-columns: repeat(5, 1fr)}
    .kpi{
      background:var(--card);border-radius:var(--radius);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      min-height:72px;
    }
    .kpi .n{font-size:26px;font-weight:900}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:2px}
    .kpi::after{
      content:"";
      position:absolute;right:-25px;top:-25px;
      width:90px;height:90px;border-radius:50%;
      background: rgba(239,68,68,.12);
    }

    .charts{display:grid;gap:12px;grid-template-columns: 2fr 1fr}
    .chartCard{
      background:var(--card);border-radius:var(--radius);
      padding:12px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.08);
      min-height: 240px;
    }
    .chartTitle{font-weight:900;margin:0 0 8px}
    .chartWrap{height:210px;}
    canvas{width:100% !important;height:100% !important;}

    .charts2{display:grid;gap:12px;grid-template-columns: 2fr 1fr}
    .tableCard{
      background:var(--card);border-radius:var(--radius);
      padding:12px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .tableTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .tableTop h3{margin:0;font-weight:900}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
    th{position:sticky;top:0;background:#0f172a;color:#fff;z-index:1}
    tbody tr:hover{background:#f8fafc}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;
      font-weight:800;font-size:11px;border:1px solid var(--line);background:#fff;
    }
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .mini{
      font-size:12px;font-weight:900;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer
    }
    .mini:hover{background:#f1f5f9}
    .mini.danger{border-color:#fecaca;background:#fff1f2}
    .mini.danger:hover{background:#ffe4e6}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:14px;z-index:50;
    }
    .modal{
      width:min(1020px, 100%);
      background:#fff;border-radius:18px;box-shadow: var(--shadow);
      overflow:hidden;border:1px solid rgba(255,255,255,.08);
    }
    .modalHead{
      padding:14px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(180deg,#ffffff, #f8fafc);
      border-bottom:1px solid var(--line);
    }
    .modalHead h2{margin:0;font-weight:950}
    .modalBody{padding:14px}
    .formGrid{display:grid;gap:10px;grid-template-columns: repeat(4, 1fr)}
    .formGrid .span2{grid-column: span 2}
    .formGrid .span4{grid-column: span 4}
    .modalFoot{
      padding:12px 14px;display:flex;gap:10px;justify-content:flex-end;align-items:center;
      border-top:1px solid var(--line);background:#fff;
    }
    .msg{font-weight:800;font-size:13px}
    .msg.ok{color:#16a34a}
    .msg.bad{color:#dc2626}

    @media (max-width: 980px){
      .row.r1{grid-template-columns: 1fr 1fr}
      .row.r2{grid-template-columns: 1fr 1fr}
      .row.r3{grid-template-columns: 1fr 1fr}
      .kpis{grid-template-columns: 1fr 1fr}
      .charts{grid-template-columns: 1fr}
      .charts2{grid-template-columns: 1fr}
      .formGrid{grid-template-columns: 1fr 1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <!-- Sube tu logo como:logo_Xtreme.png (o edita el src) -->
      <img id="logoImg" src="logo_Xtreme.png" alt="Xtreme logo" onerror="this.style.display='none'">
      <div>
        <div class="t1">Dashboard Seguimiento ‚Äì Hormig√≥n / CNC</div>
        <div class="t2">Xtreme Mining ¬∑ Google Sheets (CSV) + Apps Script (ingreso/edici√≥n)</div>
      </div>
    </div>

    <div class="spacer"></div>

    <button class="btn purple" id="btnNew">‚ûï Nuevo registro</button>
    <button class="btn" id="btnClear">üßπ Limpiar filtros</button>
    <button class="btn" id="btnRefresh">üîÑ Actualizar</button>
    <button class="btn red" id="btnPdf">‚¨á Exportar PDF</button>
  </header>

  <section class="filters" id="reportArea">
    <div class="row r1">
      <div class="field">
        <label>Buscar (texto libre)</label>
        <input id="q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." />
      </div>
      <div class="field">
        <label>MES</label>
        <select id="fMES"></select>
      </div>
      <div class="field">
        <label>SEMANA</label>
        <select id="fSEMANA"></select>
      </div>
      <div class="field">
        <label>TURNO</label>
        <select id="fTURNO"></select>
      </div>
      <div class="field">
        <label>GRUPO</label>
        <select id="fGRUPO"></select>
      </div>
    </div>

    <div class="row r2" style="margin-top:10px">
      <div class="field"><label>MINA</label><select id="fMINA"></select></div>
      <div class="field"><label>GRADO</label><select id="fGRADO"></select></div>
      <div class="field"><label>SUMINISTRO</label><select id="fSUMINISTRO"></select></div>
      <div class="field"><label>SALA DE CONTROL</label><select id="fSALA"></select></div>
      <div class="field"><label>LABOR_POSTURA</label><select id="fLABOR"></select></div>
    </div>

    <div class="row r3" style="margin-top:10px">
      <div class="field"><label>CNC_NIVEL 1</label><select id="fCNC1"></select></div>
      <div class="field"><label>CNC_NIVEL 2</label><select id="fCNC2"></select></div>
      <div class="field"><label>RESPONSABLE_CNC</label><select id="fRESP"></select></div>
      <div class="field"><label>FECHA</label><select id="fFECHA"></select></div>
    </div>

    <div class="hint" id="status">Cargando‚Ä¶</div>
  </section>

  <section class="kpis">
    <div class="kpi"><div class="n" id="kCount">0</div><div class="l">Registros filtrados</div></div>
    <div class="kpi"><div class="n" id="kPlan">0</div><div class="l">m¬≥ Planificado (suma)</div></div>
    <div class="kpi"><div class="n" id="kSumi">0</div><div class="l">m¬≥ Suministrado (suma)</div></div>
    <div class="kpi"><div class="n" id="kPend">0</div><div class="l">Pendiente (suma)</div></div>
    <div class="kpi"><div class="n" id="kTop">-</div><div class="l">CNC_NIVEL 1 (TOP)</div></div>
  </section>

  <section class="charts">
    <div class="chartCard">
      <div class="chartTitle">Incidentes por CNC_NIVEL 1 (TOP 10)</div>
      <div class="chartWrap"><canvas id="chCnc1"></canvas></div>
    </div>
    <div class="chartCard">
      <div class="chartTitle">Distribuci√≥n por RESPONSABLE_CNC</div>
      <div class="chartWrap"><canvas id="chResp"></canvas></div>
    </div>
  </section>

  <section class="charts2">
    <div class="chartCard">
      <div class="chartTitle">m¬≥ por MINA (Planificado vs Suministrado)</div>
      <div class="chartWrap"><canvas id="chMina"></canvas></div>
    </div>
    <div class="chartCard">
      <div class="chartTitle">m¬≥ por FECHA (Planificado vs Suministrado)</div>
      <div class="chartWrap"><canvas id="chFecha"></canvas></div>
    </div>
  </section>

  <section class="tableCard" style="margin-top:12px">
    <div class="tableTop">
      <h3>Detalle (todas las columnas)</h3>
      <div style="font-size:12px;color:var(--muted)">Tip: usa ‚ÄúEditar‚Äù para corregir un registro (requiere columna ID).</div>
    </div>
    <div style="overflow:auto;max-height:360px;border-radius:14px;border:1px solid var(--line)">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHead">
      <h2 id="modalTitle">Nuevo Registro</h2>
      <button class="btn red" id="btnClose">Cerrar</button>
    </div>
    <div class="modalBody">
      <div class="formGrid" id="formGrid">
        <div class="field"><label>FECHA</label><input id="iFECHA" type="date"></div>
        <div class="field"><label>MES</label><select id="iMES"></select></div>
        <div class="field"><label>SEMANA</label><select id="iSEMANA"></select></div>
        <div class="field"><label>TURNO</label><select id="iTURNO"></select></div>

        <div class="field"><label>GRUPO</label><select id="iGRUPO"></select></div>
        <div class="field"><label>MINA</label><select id="iMINA"></select></div>
        <div class="field"><label>LABOR_POSTURA</label><select id="iLABOR_POSTURA"></select></div>
        <div class="field"><label>GRADO</label><select id="iGRADO"></select></div>

        <div class="field"><label>SUMINISTRO</label><select id="iSUMINISTRO"></select></div>
        <div class="field"><label>PLANIFICADO</label><input id="iPLANIFICADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>SUMINISTRADO</label><input id="iSUMINISTRADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>PENDIENTE</label><input id="iPENDIENTE" type="number" step="0.01" placeholder="0"></div>

        <div class="field"><label>RECHAZADO</label><input id="iRECHAZADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>REAGENDADO</label><input id="iREAGENDADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>ELIMINADO</label><input id="iELIMINADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>N√öMERO GU√çA</label><input id="iNUMERO_GUIA" placeholder="Ej: 55626"></div>

        <div class="field"><label>HORA SALIDA PLANTA</label><input id="iHORA_SALIDA_PLANTA" type="time"></div>
        <div class="field"><label>HORA LLEGADA OBRA</label><input id="iHORA_LLEGADA_OBRA" type="time"></div>
        <div class="field"><label>HORA INICIO DESCARGA</label><input id="iHORA_INICIO_DESCARGA" type="time"></div>
        <div class="field"><label>HORA TERMINO DESCARGA</label><input id="iHORA_TERMINO_DESCARGA" type="time"></div>

        <div class="field span2"><label>CNC_NIVEL 2</label><select id="iCNC_NIVEL_2"></select></div>
        <div class="field"><label>CNC_NIVEL 1</label><select id="iCNC_NIVEL_1"></select></div>
        <div class="field"><label>RESPONSABLE_CNC</label><select id="iRESPONSABLE_CNC"></select></div>

        <div class="field span4"><label>SALA DE CONTROL</label><select id="iSALA_DE_CONTROL"></select></div>

        <!-- hidden -->
        <input id="iID" type="hidden">
      </div>
    </div>
    <div class="modalFoot">
      <div class="msg" id="saveMsg"></div>
      <button class="btn purple" id="btnSave">üíæ Guardar</button>
    </div>
  </div>
</div>

<script>
/** =========================
 *  CONFIG (EDITA AQU√ç)
 *  ========================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv";
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzmRXto1NpdgZtAWp745a65o1t78-NQeBC8L_62jgjRwwRe7a19FfLhnRw-0Ce60yoQ/exec";

/** Columnas esperadas (y nombre exacto en tu Sheet/CSV). */
const COLS = [
  "ID",
  "FECHA","MES","SEMANA","TURNO","GRUPO","MINA","LABOR_POSTURA","GRADO","SUMINISTRO",
  "PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO","REAGENDADO","ELIMINADO",
  "N√öMERO GU√çA","HORA SALIDA PLANTA","HORA LLEGADA OBRA","HORA INICIO DESCARGA","HORA TERMINO DESCARGA",
  "CNC _NIVEL 2","CNC _NIVEL 1","RESPONSABLE_CNC","SALA DE CONTROL"
];

/** Para dropdowns del ingreso: se construyen desde el CSV (valores √∫nicos). */
const FORM_SELECTS = {
  MES:"iMES",
  SEMANA:"iSEMANA",
  TURNO:"iTURNO",
  GRUPO:"iGRUPO",
  MINA:"iMINA",
  LABOR_POSTURA:"iLABOR_POSTURA",
  GRADO:"iGRADO",
  SUMINISTRO:"iSUMINISTRO",
  "CNC _NIVEL 2":"iCNC_NIVEL_2",
  "CNC _NIVEL 1":"iCNC_NIVEL_1",
  RESPONSABLE_CNC:"iRESPONSABLE_CNC",
  "SALA DE CONTROL":"iSALA_DE_CONTROL",
};

/** =========================
 *  STATE
 *  ========================= */
let raw = [];         // all rows (objects)
let filtered = [];    // filtered rows
let charts = {};
let lastFetchAt = 0;

/** =========================
 *  HELPERS
 *  ========================= */
const $ = (id)=>document.getElementById(id);

function normHeader(h){
  return String(h||"").trim();
}

function toNumber(v){
  if (v===null || v===undefined) return 0;
  const s = String(v).replace(",", ".").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function textMatch(row, q){
  if(!q) return true;
  const s = q.toLowerCase();
  return Object.values(row).some(v => String(v||"").toLowerCase().includes(s));
}

function uniq(arr){
  return Array.from(new Set(arr.filter(v => v!==null && v!==undefined && String(v).trim()!=="").map(v => String(v).trim())));
}

function setOptions(selectEl, values, allLabel="Todos"){
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = allLabel;
  selectEl.appendChild(opt0);
  values.forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    o.textContent=v;
    selectEl.appendChild(o);
  });
}

function setOptionsForm(selectEl, values){
  selectEl.innerHTML = "";
  const o0=document.createElement("option");
  o0.value="";
  o0.textContent="Seleccione‚Ä¶";
  selectEl.appendChild(o0);
  values.forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    o.textContent=v;
    selectEl.appendChild(o);
  });
}

function groupCount(rows, key){
  const m=new Map();
  rows.forEach(r=>{
    const k = String(r[key]||"").trim() || "(Vac√≠o)";
    m.set(k, (m.get(k)||0)+1);
  });
  return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
}

function groupSumBy(rows, key, col){
  const m=new Map();
  rows.forEach(r=>{
    const k = String(r[key]||"").trim() || "(Vac√≠o)";
    const v = toNumber(r[col]);
    m.set(k, (m.get(k)||0)+v);
  });
  return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
}

function safeDateIso(v){
  // acepta "YYYY-MM-DD" o "DD-MM-YYYY"
  const s = String(v||"").trim();
  if(!s) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if (/^\d{2}-\d{2}-\d{4}$/.test(s)){
    const [dd,mm,yy]=s.split("-");
    return `${yy}-${mm}-${dd}`;
  }
  return s;
}

/** =========================
 *  CSV LOAD
 *  ========================= */
async function fetchCsv(){
  if(!CSV_URL || CSV_URL.includes("REEMPLAZA")) throw new Error("Debes pegar tu CSV_URL en el index.html");
  const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
  const res = await fetch(url, { cache:"no-store", mode:"cors" });
  if(!res.ok) throw new Error("No se pudo leer CSV (status " + res.status + ")");
  const txt = await res.text();
  return parseCsv(txt);
}

function parseCsv(text){
  // parser simple (soporta comillas b√°sicas)
  const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim()!=="");
  if(lines.length<1) return [];
  const headers = splitCsvLine(lines[0]).map(normHeader);
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const parts = splitCsvLine(lines[i]);
    const obj={};
    headers.forEach((h,idx)=>obj[h]= (parts[idx] ?? "").trim());
    rows.push(obj);
  }
  return rows;
}

function splitCsvLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    } else if(ch === "," && !inQ){
      out.push(cur); cur="";
    } else {
      cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

/** =========================
 *  FILTERS
 *  ========================= */
function buildFilterOptions(){
  const map = {
    fMES:"MES",
    fSEMANA:"SEMANA",
    fTURNO:"TURNO",
    fGRUPO:"GRUPO",
    fMINA:"MINA",
    fGRADO:"GRADO",
    fSUMINISTRO:"SUMINISTRO",
    fSALA:"SALA DE CONTROL",
    fLABOR:"LABOR_POSTURA",
    fCNC1:"CNC _NIVEL 1",
    fCNC2:"CNC _NIVEL 2",
    fRESP:"RESPONSABLE_CNC",
    fFECHA:"FECHA",
  };
  for(const [selId, col] of Object.entries(map)){
    const values = uniq(raw.map(r => r[col]));
    values.sort((a,b)=>a.localeCompare(b,"es"));
    setOptions($(selId), values, selId==="fFECHA" ? "Todas" : "Todos");
  }
}

function applyFilters(){
  const q = $("q").value.trim();
  const pick = (id)=>$(id).value;
  filtered = raw.filter(r=>{
    if(!textMatch(r,q)) return false;
    const rules = [
      ["fMES","MES"],["fSEMANA","SEMANA"],["fTURNO","TURNO"],["fGRUPO","GRUPO"],
      ["fMINA","MINA"],["fGRADO","GRADO"],["fSUMINISTRO","SUMINISTRO"],["fSALA","SALA DE CONTROL"],
      ["fLABOR","LABOR_POSTURA"],["fCNC1","CNC _NIVEL 1"],["fCNC2","CNC _NIVEL 2"],
      ["fRESP","RESPONSABLE_CNC"],["fFECHA","FECHA"]
    ];
    for(const [fid,col] of rules){
      const v = pick(fid);
      if(v && String(r[col]||"").trim() !== v) return false;
    }
    return true;
  });
  renderAll();
}

function clearFilters(){
  $("q").value="";
  ["fMES","fSEMANA","fTURNO","fGRUPO","fMINA","fGRADO","fSUMINISTRO","fSALA","fLABOR","fCNC1","fCNC2","fRESP","fFECHA"]
    .forEach(id=>$(id).value="");
  applyFilters();
}

/** =========================
 *  RENDER
 *  ========================= */
function renderKpis(){
  $("kCount").textContent = String(filtered.length);
  const sum = (col)=> filtered.reduce((a,r)=>a+toNumber(r[col]),0);
  $("kPlan").textContent = String(Math.round(sum("PLANIFICADO")*100)/100);
  $("kSumi").textContent = String(Math.round(sum("SUMINISTRADO")*100)/100);
  $("kPend").textContent = String(Math.round(sum("PENDIENTE")*100)/100);

  const top = groupCount(filtered, "CNC _NIVEL 1")[0]?.[0] ?? "-";
  $("kTop").textContent = top;
}

function makeOrUpdateChart(key, cfg){
  if(charts[key]){ charts[key].data = cfg.data; charts[key].options = cfg.options; charts[key].update(); return; }
  charts[key] = new Chart($(key), cfg);
}

function renderCharts(){
  // CNC1 top10
  const cnc = groupCount(filtered, "CNC _NIVEL 1").slice(0,10);
  makeOrUpdateChart("chCnc1",{
    type:"bar",
    data:{ labels: cnc.map(x=>x[0]), datasets:[{ label:"Cantidad", data: cnc.map(x=>x[1]) }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}},
      scales:{ x:{ ticks:{ maxRotation:30, minRotation:0 } }, y:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });

  // Responsable donut
  const resp = groupCount(filtered, "RESPONSABLE_CNC").slice(0,8);
  makeOrUpdateChart("chResp",{
    type:"doughnut",
    data:{ labels: resp.map(x=>x[0]), datasets:[{ data: resp.map(x=>x[1]) }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
  });

  // Mina sums
  const minas = uniq(filtered.map(r=>r["MINA"])).sort((a,b)=>a.localeCompare(b,"es"));
  const plan = minas.map(m=> filtered.filter(r=>String(r["MINA"]||"")===m).reduce((a,r)=>a+toNumber(r["PLANIFICADO"]),0));
  const sumi = minas.map(m=> filtered.filter(r=>String(r["MINA"]||"")===m).reduce((a,r)=>a+toNumber(r["SUMINISTRADO"]),0));
  makeOrUpdateChart("chMina",{
    type:"bar",
    data:{ labels: minas, datasets:[
      { label:"Planificado", data: plan },
      { label:"Suministrado", data: sumi },
    ]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} }
  });

  // Fecha sums
  const fechas = uniq(filtered.map(r=>safeDateIso(r["FECHA"]))).sort();
  const planF = fechas.map(d=> filtered.filter(r=>safeDateIso(r["FECHA"])===d).reduce((a,r)=>a+toNumber(r["PLANIFICADO"]),0));
  const sumiF = fechas.map(d=> filtered.filter(r=>safeDateIso(r["FECHA"])===d).reduce((a,r)=>a+toNumber(r["SUMINISTRADO"]),0));
  makeOrUpdateChart("chFecha",{
    type:"line",
    data:{ labels: fechas, datasets:[
      { label:"Planificado", data: planF, tension:0.25 },
      { label:"Suministrado", data: sumiF, tension:0.25 },
    ]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} }
  });
}

function renderTable(){
  const thead = $("thead");
  const tbody = $("tbody");

  const cols = Object.keys(raw[0] || {});
  // si existe ID, lo dejamos; si no, igual mostramos todo.
  const showCols = cols.length ? cols : COLS;

  // header
  thead.innerHTML = "<tr>" + showCols.map(c=>`<th>${c}</th>`).join("") + "<th>Acciones</th></tr>";

  // body (limit to 250 for performance)
  const rows = filtered.slice(0,250);
  tbody.innerHTML = rows.map(r=>{
    const id = (r["ID"]||"").trim();
    const tds = showCols.map(c=>{
      const v = r[c] ?? "";
      return `<td>${escapeHtml(String(v))}</td>`;
    }).join("");
    const btns = `
      <div class="actions">
        <button class="mini" data-act="edit" data-id="${escapeAttr(id)}">Editar</button>
        <button class="mini danger" data-act="del" data-id="${escapeAttr(id)}">Eliminar</button>
      </div>`;
    return `<tr>${tds}<td>${btns}</td></tr>`;
  }).join("");

  // bind action clicks
  tbody.querySelectorAll("button[data-act]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const act=b.getAttribute("data-act");
      const id=b.getAttribute("data-id")||"";
      if(act==="edit") openEdit(id);
      if(act==="del") doDelete(id);
    });
  });
}

function escapeHtml(s){
  return s.replace(/[&<>"]/g, ch=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[ch]));
}
function escapeAttr(s){
  return String(s).replace(/"/g,"&quot;");
}

function renderAll(){
  renderKpis();
  renderCharts();
  renderTable();
}

/** =========================
 *  FORM DROPDOWNS (from CSV)
 *  ========================= */
function buildFormDropdowns(){
  // make map col -> unique values from raw
  const uniqMap = {};
  Object.keys(FORM_SELECTS).forEach(col=>{
    uniqMap[col] = uniq(raw.map(r=>r[col])).sort((a,b)=>a.localeCompare(b,"es"));
  });
  for(const [col, selId] of Object.entries(FORM_SELECTS)){
    const el = $(selId);
    if(!el) continue;
    setOptionsForm(el, uniqMap[col]);
  }
}

/** =========================
 *  MODAL: NEW / EDIT
 *  ========================= */
function openModal(){
  $("backdrop").style.display="flex";
}
function closeModal(){
  $("backdrop").style.display="none";
  $("saveMsg").textContent="";
  $("saveMsg").className="msg";
}
function resetForm(){
  $("iID").value="";
  $("iFECHA").value="";
  ["iPLANIFICADO","iSUMINISTRADO","iPENDIENTE","iRECHAZADO","iREAGENDADO","iELIMINADO"].forEach(id=>$(id).value="0");
  ["iNUMERO_GUIA","iHORA_SALIDA_PLANTA","iHORA_LLEGADA_OBRA","iHORA_INICIO_DESCARGA","iHORA_TERMINO_DESCARGA"].forEach(id=>$(id).value="");
  Object.values(FORM_SELECTS).forEach(id=>{ if($(id)) $(id).value=""; });
}

function openNew(){
  $("modalTitle").textContent="Nuevo Registro";
  resetForm();
  openModal();
}

function openEdit(id){
  if(!id){
    alert("Este CSV no trae columna ID. Para editar, el Apps Script debe agregar la columna ID y el CSV debe publicarse desde esa misma hoja.");
    return;
  }
  const r = raw.find(x => String(x["ID"]||"").trim()===id);
  if(!r){ alert("No se encontr√≥ el registro."); return; }
  $("modalTitle").textContent="Editar Registro (ID: " + id + ")";
  $("iID").value = id;

  $("iFECHA").value = safeDateIso(r["FECHA"]);
  // selects
  Object.entries(FORM_SELECTS).forEach(([col, selId])=>{
    if($(selId)) $(selId).value = String(r[col]||"").trim();
  });
  // numbers/text
  $("iPLANIFICADO").value = String(r["PLANIFICADO"] ?? "0");
  $("iSUMINISTRADO").value = String(r["SUMINISTRADO"] ?? "0");
  $("iPENDIENTE").value = String(r["PENDIENTE"] ?? "0");
  $("iRECHAZADO").value = String(r["RECHAZADO"] ?? "0");
  $("iREAGENDADO").value = String(r["REAGENDADO"] ?? "0");
  $("iELIMINADO").value = String(r["ELIMINADO"] ?? "0");
  $("iNUMERO_GUIA").value = String(r["N√öMERO GU√çA"] ?? "");
  $("iHORA_SALIDA_PLANTA").value = String(r["HORA SALIDA PLANTA"] ?? "");
  $("iHORA_LLEGADA_OBRA").value = String(r["HORA LLEGADA OBRA"] ?? "");
  $("iHORA_INICIO_DESCARGA").value = String(r["HORA INICIO DESCARGA"] ?? "");
  $("iHORA_TERMINO_DESCARGA").value = String(r["HORA TERMINO DESCARGA"] ?? "");

  openModal();
}

function collectForm(){
  // IMPORTANT: keys must match script headers (same text)
  const data = {
    "FECHA": $("iFECHA").value ? $("iFECHA").value : "",
    "MES": $("iMES").value,
    "SEMANA": $("iSEMANA").value,
    "TURNO": $("iTURNO").value,
    "GRUPO": $("iGRUPO").value,
    "MINA": $("iMINA").value,
    "LABOR_POSTURA": $("iLABOR_POSTURA").value,
    "GRADO": $("iGRADO").value,
    "SUMINISTRO": $("iSUMINISTRO").value,
    "PLANIFICADO": $("iPLANIFICADO").value,
    "SUMINISTRADO": $("iSUMINISTRADO").value,
    "PENDIENTE": $("iPENDIENTE").value,
    "RECHAZADO": $("iRECHAZADO").value,
    "REAGENDADO": $("iREAGENDADO").value,
    "ELIMINADO": $("iELIMINADO").value,
    "N√öMERO GU√çA": $("iNUMERO_GUIA").value,
    "HORA SALIDA PLANTA": $("iHORA_SALIDA_PLANTA").value,
    "HORA LLEGADA OBRA": $("iHORA_LLEGADA_OBRA").value,
    "HORA INICIO DESCARGA": $("iHORA_INICIO_DESCARGA").value,
    "HORA TERMINO DESCARGA": $("iHORA_TERMINO_DESCARGA").value,
    "CNC _NIVEL 2": $("iCNC_NIVEL_2").value,
    "CNC _NIVEL 1": $("iCNC_NIVEL_1").value,
    "RESPONSABLE_CNC": $("iRESPONSABLE_CNC").value,
    "SALA DE CONTROL": $("iSALA_DE_CONTROL").value
  };
  return data;
}

/** =========================
 *  SAVE / UPDATE / DELETE (Apps Script)
 *  ========================= */
async function sendToScript(payload){
  if(!APP_SCRIPT_URL || APP_SCRIPT_URL.includes("REEMPLAZA")) throw new Error("Debes pegar tu APP_SCRIPT_URL en el index.html");
  // IMPORTANTE: para evitar CORS en GitHub Pages, usamos no-cors (respuesta opaca)
  await fetch(APP_SCRIPT_URL, {
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
}

async function save(){
  $("saveMsg").textContent="Enviando‚Ä¶";
  $("saveMsg").className="msg";
  try{
    const id = $("iID").value.trim();
    const data = collectForm();
    if(!data.FECHA) throw new Error("FECHA es obligatoria");
    const payload = id ? { action:"update", id, data } : { action:"add", data };
    await sendToScript(payload);

    $("saveMsg").textContent="Guardado. Actualizando‚Ä¶";
    $("saveMsg").className="msg ok";

    await reloadData();
    closeModal();
  }catch(err){
    $("saveMsg").textContent = "Error: " + String(err.message || err);
    $("saveMsg").className="msg bad";
  }
}

async function doDelete(id){
  if(!id){ alert("Este CSV no trae columna ID. Para eliminar, necesitas ID."); return; }
  if(!confirm("¬øEliminar el registro ID " + id + "?")) return;
  try{
    await sendToScript({ action:"delete", id });
    await reloadData();
  }catch(err){
    alert("No se pudo eliminar: " + String(err.message || err));
  }
}

/** =========================
 *  PDF EXPORT
 *  ========================= */
async function exportPdf(){
  const area = $("reportArea");
  const node = document.querySelector(".wrap"); // exporta todo el dashboard
  const canvas = await html2canvas(node, { scale: 2, useCORS: true, backgroundColor: "#0b1220" });
  const imgData = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;

  // A4 landscape
  const pdf = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });
  const pw = pdf.internal.pageSize.getWidth();
  const ph = pdf.internal.pageSize.getHeight();

  // fit
  const ratio = Math.min(pw / canvas.width, ph / canvas.height);
  const w = canvas.width * ratio;
  const h = canvas.height * ratio;
  const x = (pw - w)/2;
  const y = (ph - h)/2;

  pdf.addImage(imgData, "PNG", x, y, w, h);
  pdf.save("Reporte_Hormigon_CNC_Xtreme.pdf");
}

/** =========================
 *  INIT
 *  ========================= */
async function reloadData(){
  $("status").textContent = "Cargando CSV‚Ä¶";
  try{
    raw = await fetchCsv();
    lastFetchAt = Date.now();

    // si la hoja no tiene ID, lo mostramos como aviso
    const hasId = raw.length && Object.prototype.hasOwnProperty.call(raw[0], "ID");
    $("status").innerHTML = hasId
      ? `<span class="ok">CSV cargado: ${raw.length} filas.</span>`
      : `<span class="bad">CSV cargado: ${raw.length} filas, pero falta columna <b>ID</b>. (Sin ID no se puede editar/eliminar)</span>`;

    buildFilterOptions();
    buildFormDropdowns();
    applyFilters();
  }catch(err){
    $("status").innerHTML = `<span class="bad">Error de red: no se pudo leer el CSV.</span> <span class="hint">(${escapeHtml(String(err.message||err))})</span>`;
    raw = [];
    filtered = [];
    renderAll();
  }
}

function bindUi(){
  // filter change
  ["q","fMES","fSEMANA","fTURNO","fGRUPO","fMINA","fGRADO","fSUMINISTRO","fSALA","fLABOR","fCNC1","fCNC2","fRESP","fFECHA"]
    .forEach(id=>$(id).addEventListener("input", applyFilters));
  ["fMES","fSEMANA","fTURNO","fGRUPO","fMINA","fGRADO","fSUMINISTRO","fSALA","fLABOR","fCNC1","fCNC2","fRESP","fFECHA"]
    .forEach(id=>$(id).addEventListener("change", applyFilters));

  $("btnClear").addEventListener("click", clearFilters);
  $("btnRefresh").addEventListener("click", reloadData);
  $("btnPdf").addEventListener("click", exportPdf);
  $("btnNew").addEventListener("click", openNew);
  $("btnClose").addEventListener("click", closeModal);
  $("backdrop").addEventListener("click", (e)=>{ if(e.target.id==="backdrop") closeModal(); });
  $("btnSave").addEventListener("click", save);
}

bindUi();
reloadData();
</script>
</body>
</html>
