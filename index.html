<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Xtreme ‚Äì Hormig√≥n / CNC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --dark:#0b1020; --dark2:#111827; --accent:#ef4444; --accent2:#334155;
      --shadow:0 10px 25px rgba(0,0,0,.06); --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .topbar{background:linear-gradient(90deg,var(--dark),var(--dark2));color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .brand{display:flex;align-items:center;gap:12px;min-width:320px}
    .logoWrap{width:190px;height:46px;display:flex;align-items:center;justify-content:flex-start;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:6px 10px}
    .logoWrap img{max-height:34px;max-width:170px;display:block}
    .titles .h1{font-weight:900;font-size:14px;line-height:1.15;letter-spacing:.2px}
    .titles .h2{font-size:11px;color:rgba(255,255,255,.75);margin-top:2px;line-height:1.1}
    .container{max-width:1400px;margin:14px auto 40px;padding:0 14px}

    .filters,.filters2,.filters3{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:grid;gap:10px;align-items:end}
    .filters{grid-template-columns:1.4fr repeat(5,1fr)}
    .filters2{margin-top:10px;grid-template-columns:repeat(6,1fr)}
    .filters3{margin-top:10px;grid-template-columns:repeat(6,1fr)}
    .field label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:800;letter-spacing:.2px}
    input[type="text"], input[type="date"], input[type="time"], input[type="number"], select{
      width:100%;height:36px;border-radius:10px;border:1px solid var(--line);padding:0 10px;outline:none;background:#fff;font-size:13px
    }
    input:focus,select:focus{border-color:#c7cdd6;box-shadow:0 0 0 3px rgba(148,163,184,.25)}
    .btn{height:38px;border-radius:12px;border:1px solid rgba(255,255,255,.14);padding:0 14px;background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
    .btn.secondary{background:rgba(255,255,255,.08)}
    .btn.danger{background:rgba(239,68,68,.85);border-color:rgba(239,68,68,.5)}
    .btn2{height:38px;border-radius:12px;border:1px solid var(--line);padding:0 14px;background:#fff;color:var(--text);font-weight:800;cursor:pointer}
    .btn2.dark{background:var(--dark2);color:#fff;border-color:rgba(255,255,255,.12)}
    .btn2:active,.btn:active{transform:translateY(1px)}

    .grid-kpis{margin-top:12px;display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .kpi .label{font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.25px}
    .kpi .value{font-size:22px;font-weight:950;margin-top:6px}
    .kpi .sub{font-size:11px;color:var(--muted);margin-top:4px}

    .grid-charts{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-charts-2{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .card h3{margin:0 0 10px 0;font-size:13px;font-weight:950}
    .chartbox{height:280px}

    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:12px;white-space:nowrap}
    thead th{position:sticky;top:0;background:var(--dark2);color:#fff;font-size:11px;letter-spacing:.2px;text-align:left}
    tbody tr:hover{background:#f9fafb}
    .footer-note{margin-top:8px;font-size:12px;color:var(--muted);font-weight:700}
    .footer-note.err{color:#ef4444}

    .modalBg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:center;justify-content:center;padding:18px}
    .modalCard{width:min(1100px,95vw);background:#fff;border-radius:16px;box-shadow:0 25px 70px rgba(0,0,0,.35);padding:14px}
    .modalGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .modalFoot{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .warn{margin-top:10px;font-size:12px;color:#ef4444;font-weight:900}
    .subnote{margin-top:10px;font-size:12px;color:#16a34a;font-weight:900}

    @media (max-width:1100px){
      .filters{grid-template-columns:1fr 1fr}
      .filters2,.filters3{grid-template-columns:1fr 1fr}
      .grid-kpis{grid-template-columns:1fr 1fr}
      .grid-charts,.grid-charts-2{grid-template-columns:1fr}
      .modalGrid{grid-template-columns:1fr 1fr}
    }
    @media print{
      .topbar, .filters, .filters2, .filters3, .modalBg { display:none !important; }
      body{background:#fff}
      .card, .kpi{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap">
        <img src="logo_Xtreme.png" alt="Xtreme Mining" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block';" />
          <div id="logoFallback" style="display:none;color:#fff;font-weight:700;">XTREME</div>
      </div>
      <div class="titles">
        <div class="h1">Dashboard Seguimiento ‚Äì Hormig√≥n / CNC</div>
        <div class="h2">Xtreme Mining ‚Ä¢ Datos desde Google Sheets (CSV)</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <button class="btn secondary" id="btnNew">‚ûï Nuevo registro</button>
      <button class="btn secondary" id="btnClear">üßπ Limpiar filtros</button>
      <button class="btn danger" id="btnPdf">‚¨á Exportar PDF</button>
    </div>
  </div>

  <div class="container">
    <div class="filters">
      <div class="field">
        <label>Buscar (texto libre)</label>
        <input id="q" type="text" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'." />
      </div>
      <div class="field"><label>MES</label><select id="f_mes"><option value="">Todos</option></select></div>
      <div class="field"><label>SEMANA</label><select id="f_semana"><option value="">Todos</option></select></div>
      <div class="field"><label>TURNO</label><select id="f_turno"><option value="">Todos</option></select></div>
      <div class="field"><label>GRUPO</label><select id="f_grupo"><option value="">Todos</option></select></div>
      <div class="field"><label>MINA</label><select id="f_mina"><option value="">Todos</option></select></div>
    </div>

    <div class="filters2">
      <div class="field"><label>GRADO</label><select id="f_grado"><option value="">Todos</option></select></div>
      <div class="field"><label>SUMINISTRO</label><select id="f_suministro"><option value="">Todos</option></select></div>
      <div class="field"><label>SALA DE CONTROL</label><select id="f_sala"><option value="">Todos</option></select></div>
      <div class="field"><label>LABOR_POSTURA</label><select id="f_labor"><option value="">Todos</option></select></div>
      <div class="field"><label>CNC _NIVEL 2</label><select id="f_cnc2"><option value="">Todos</option></select></div>
      <div class="field"><label>CNC _NIVEL 1</label><select id="f_cnc1"><option value="">Todos</option></select></div>
    </div>

    <div class="filters3">
      <div class="field"><label>RESPONSABLE_CNC</label><select id="f_resp"><option value="">Todos</option></select></div>
      <div class="field"><label>FECHA</label><select id="f_fecha"><option value="">Todas</option></select></div>
      <div class="field"><label>PLANIFICADO</label><select id="f_plan"><option value="">Todos</option></select></div>
      <div class="field"><label>SUMINISTRADO</label><select id="f_sum"><option value="">Todos</option></select></div>
      <div class="field"><label>PENDIENTE</label><select id="f_pend"><option value="">Todos</option></select></div>
      <div class="field"><label>RECHAZADO</label><select id="f_rech"><option value="">Todos</option></select></div>
    </div>

    <div class="grid-kpis">
      <div class="kpi"><div class="label">REGISTROS FILTRADOS</div><div class="value" id="k_total">0</div><div class="sub">Total visible seg√∫n filtros</div></div>
      <div class="kpi"><div class="label">m¬≥ PLANIFICADO (suma)</div><div class="value" id="k_plan">0</div><div class="sub">Suma columna PLANIFICADO</div></div>
      <div class="kpi"><div class="label">m¬≥ SUMINISTRADO (suma)</div><div class="value" id="k_sumi">0</div><div class="sub">Suma columna SUMINISTRADO</div></div>
      <div class="kpi"><div class="label">PENDIENTE (suma)</div><div class="value" id="k_pend">0</div><div class="sub">Suma columna PENDIENTE</div></div>
      <div class="kpi"><div class="label">RECHAZADO (suma)</div><div class="value" id="k_rech_sum">0</div><div class="sub">Suma columna RECHAZADO</div></div>
    </div>

    <div class="grid-charts">
      <div class="card"><h3>Incidentes por CNC _NIVEL 1 (TOP 10)</h3><div class="chartbox"><canvas id="chCnc1"></canvas></div></div>
      <div class="card"><h3>Distribuci√≥n por RESPONSABLE_CNC</h3><div class="chartbox"><canvas id="chResp"></canvas></div></div>
    </div>

    <div class="grid-charts-2">
      <div class="card"><h3>m¬≥ por MINA (Planificado vs Suministrado)</h3><div class="chartbox"><canvas id="chMina"></canvas></div></div>
      <div class="card"><h3>m¬≥ por FECHA (Planificado vs Suministrado)</h3><div class="chartbox"><canvas id="chFecha"></canvas></div></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3>Detalle (todas las columnas)</h3>
      <div class="table-wrap">
        <table id="tbl">
          <thead><tr id="tblHead"></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div class="footer-note" id="note">Cargando datos‚Ä¶</div>
    </div>
  </div>

  <div class="modalBg" id="modalBg">
    <div class="modalCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h3 style="margin:0;">‚ûï Nuevo Registro</h3>
        <button class="btn danger" id="btnClose">Cerrar</button>
      </div>

      <div class="modalGrid">
        <div class="field"><label>FECHA</label><input id="n_FECHA" type="date"></div>
        <div class="field"><label>MES</label><select id="n_MES"></select></div>
        <div class="field"><label>SEMANA</label><select id="n_SEMANA"></select></div>
        <div class="field"><label>TURNO</label><select id="n_TURNO"></select></div>

        <div class="field"><label>GRUPO</label><select id="n_GRUPO"></select></div>
        <div class="field"><label>MINA</label><select id="n_MINA"></select></div>
        <div class="field"><label>LABOR_POSTURA</label><select id="n_LABOR"></select></div>
        <div class="field"><label>GRADO</label><select id="n_GRADO"></select></div>

        <div class="field"><label>SUMINISTRO</label><select id="n_SUMINISTRO"></select></div>
        <div class="field"><label>PLANIFICADO</label><input id="n_PLANIFICADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>SUMINISTRADO</label><input id="n_SUMINISTRADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>PENDIENTE</label><input id="n_PENDIENTE" type="number" step="0.01" placeholder="0"></div>

        <div class="field"><label>RECHAZADO</label><input id="n_RECHAZADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>REAGENDADO</label><input id="n_REAGENDADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>ELIMINADO</label><input id="n_ELIMINADO" type="number" step="0.01" placeholder="0"></div>
        <div class="field"><label>N√öMERO GU√çA</label><input id="n_GUIA" type="text" placeholder=""></div>

        <div class="field"><label>HORA SALIDA PLANTA</label><input id="n_HSAL" type="time"></div>
        <div class="field"><label>HORA LLEGADA OBRA</label><input id="n_HLLE" type="time"></div>
        <div class="field"><label>HORA INICIO DESCARGA</label><input id="n_HINI" type="time"></div>
        <div class="field"><label>HORA TERMINO DESCARGA</label><input id="n_HTER" type="time"></div>

        <div class="field"><label>CNC _NIVEL 2</label><select id="n_CNC2"></select></div>
        <div class="field"><label>CNC _NIVEL 1</label><select id="n_CNC1"></select></div>
        <div class="field"><label>RESPONSABLE_CNC</label><select id="n_RESP"></select></div>
        <div class="field"><label>SALA DE CONTROL</label><select id="n_SALA"></select></div>
      </div>

      <div class="warn" id="saveErr" style="display:none">‚ùå Error de red (no se pudo enviar). Revisa que el WebApp est√© ‚ÄúCualquiera‚Äù y el link sea /exec.</div>
      <div class="subnote" id="saveOk" style="display:none">‚úÖ Enviado. Actualizando‚Ä¶</div>

      <div class="modalFoot">
        <button class="btn2 dark" id="btnSave">üíæ Guardar</button>
      </div>
    </div>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx5JxXi--rzK6hsFSymA4x3TKHoxXQ6d2do2A3jjCgYiNcdwRTyc355nnkM7HNql9Pl/exec;

const HEADERS = [
  "FECHA","MES","SEMANA","TURNO","GRUPO","MINA","LABOR_POSTURA","GRADO","SUMINISTRO",
  "PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO","REAGENDADO","ELIMINADO",
  "N√öMERO GU√çA","HORA SALIDA PLANTA","HORA LLEGADA OBRA","HORA INICIO DESCARGA","HORA TERMINO DESCARGA",
  "CNC _NIVEL 2","CNC _NIVEL 1","RESPONSABLE_CNC","SALA DE CONTROL"
];


// Valores por defecto para los desplegables (cuando el CSV est√© vac√≠o)
const CATALOG = {
  "MES": [
    "Enero",
    "Febrero",
    "Marzo",
    "Abril",
    "Mayo",
    "Junio",
    "Julio",
    "Agosto",
    "Septiembre",
    "Octubre",
    "Noviembre",
    "Diciembre"
  ],
  "SEMANA": [],
  "TURNO": [
    "1",
    "2",
    "A",
    "B",
    "C"
  ],
  "GRUPO": [
    "Grupo_1",
    "Grupo_2",
    "Grupo_3",
    "Grupo_4"
  ],
  "MINA": [
    "ESMERALDA",
    "ESMERALDA_ACARREO",
    "ESMERALDA_PANEL_1",
    "ESMERALDA_PANEL_2",
    "DIABLO_REGIMIENTO",
    "PACIFICO_SUPERIOR",
    "PILAR_NORTE",
    "PANEL_RENO",
    "RENO",
    "RRNN",
    "DACITA",
    "PANEL_INVARIANTE",
    "TENIENTE_6",
    "TENIENTE_7",
    "TENIENTE_8",
    "ANDESITA",
    "COL√ìN",
    "ADIT_71"
  ],
  "LABOR_POSTURA": [
    "C-49 IZ",
    "C-55 IZ",
    "C-25 Z-44 HW",
    "C-25 Z-45 HW",
    "C-49 OP-48",
    "C-23 Z-0",
    "C-23 Z-42 FW",
    "C-23 Z-42 HW",
    "C-2 Z-10/9",
    "C-2 Z-5/6",
    "C-0 SOC. SUR A Z-10",
    "OP-27 UH",
    "OP-26 Pto 22-A",
    "OP-26 Pto 22-B",
    "OP-26 Pto 24",
    "OP-26 Pto 23",
    "OP-27 Pto 20-A",
    "OP-27 Pto 20-B",
    "OP-27 Pto 21-A",
    "OP-27 Pto 21-B",
    "OP-27 Pto 22-A",
    "Pilar Bz 24-1S (Pto 1)",
    "Soc. Hw 1 (Pto 2)",
    "Soc. Hw 1 / Acceso Sur Loop (Pto 3)",
    "Acceso Sur Loop (Pto 4)",
    "Soc. Hw 1 / Loop Norte (Pto 5)",
    "Loop Fw A (Pto 6)",
    "Loop Fw B (Pto 7)",
    "CX 1S/2S con Loop 1S (Pto 8)",
    "Loop Hw / CX Loop 1S/2S (Pto 9)",
    "Loop Hw / Adit 65 (Pto 10)",
    "Loop Hw entre P4 y P5 (Pto 11)",
    "Fr Inv descarga Dacita (Pto 12)",
    "CAV acceso descarga CH DT (Pto 13)",
    "Galer√≠a curva CH DT (Pto 14)",
    "OP 24",
    "EDIFICIO 132"
  ],
  "GRADO": [
    "SH-22,5 NORMAL",
    "SH-22,5 FIBRA",
    "SH-300",
    "HN-70",
    "HN-30",
    "HN-40",
    "HN-50",
    "HB-30",
    "HB-40",
    "HB-50",
    "GN-25",
    "HB-70",
    "GN-65"
  ],
  "SUMINISTRO": [
    "En Planta",
    "En Obra"
  ],
  "CNC _NIVEL 2": [
    "Interferencia por derrumbe",
    "Comunicaci√≥n",
    "Trabajos en ruta",
    "Traslado personal DET",
    "ruta no apta para el ingreso de mixer",
    "Simulacros",
    "Ventana horaria",
    "Restricci√≥n por evento climatico",
    "Movilizaciones",
    "Visita Gerencia GSYS",
    "Cambio de prioridad",
    "Sin Autorizacion DET",
    "APP no disponible",
    "Planta sin comunicaci√≥n",
    "Sismolog√≠a",
    "Ruta marina",
    "Cenefa",
    "Trabajo otras empresas",
    "Equipos en √°rea",
    "Marina en postura",
    "Liberaci√≥n de gases",
    "Energ√≠a",
    "Agua",
    "Cancha no lista",
    "Trabajos otras disciplinas",
    "Cancelacion Suministro",
    "Pedido Fuera de Programa",
    "Confirmacion fuera de horario",
    "Indisponibilidad de mixer propio",
    "Falta operador",
    "Falta personal OOCC",
    "Equipo shortcrete F/S",
    "Bomba F/S",
    "Problemas con escolta",
    "Lento retorno de equipos",
    "Mixer Retrasado",
    "Sin retorno de mixer a planta",
    "Capacidad maxima equipo",
    "Mezcladores",
    "Postura rematada con menos m3",
    "Cambio de Postura",
    "Suspension Administrativa",
    "Planificaci√≥n err√≥nea",
    "Problemas en la calidad",
    "Falta suministros",
    "Falla planta",
    "Incumplimiento horario APP",
    "Equipo F/S Xtreme",
    "Tarjeta Verde",
    "Somnolencia",
    "Proceso de cargu√≠o tarda mas de lo programado",
    "Espera equipo en planta"
  ],
  "CNC _NIVEL 1": [
    "Ruta Codelco",
    "Clima",
    "Personal",
    "Prioridades",
    "APP no disponible",
    "Comunicaci√≥n",
    "Sismolog√≠a",
    "Ruta",
    "Interferencia empresas",
    "Liberaci√≥n de gases",
    "Servicios",
    "Frente no preparada",
    "Pedido",
    "Indisponibilidad de mixer propio",
    "Dotaci√≥n no disponible",
    "Equipos",
    "Postura",
    "Suministro",
    "Planificaci√≥n err√≥nea",
    "Calidad",
    "Indisponibilidad de planta",
    "Incumplimiento horario APP",
    "Equipo F/S",
    "Planta",
    "Falla operacional",
    "Espera equipo en planta"
  ],
  "RESPONSABLE_CNC": [
    "CODELCO",
    "INTERNA",
    "SUMINISTRO"
  ],
  "SALA DE CONTROL": [
    "Carlos Salazar Rodriguez",
    "Martin Arriaza Vidal",
    "Alvaro Coloma Toledo",
    "Marcelo Henriquez Ortiz"
  ]
};


const $ = (id)=>document.getElementById(id);
const uniq = (arr)=>Array.from(new Set(arr.filter(v=>v!=="" && v!=null))).sort((a,b)=>String(a).localeCompare(String(b)));
const num = (v)=>{
  if (v===null||v===undefined) return 0;
  const s = String(v).trim().replace(/\./g,"").replace(",",".");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
};
function parseCSV(text){
  const rows=[];
  let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (c === '"' && n === '"'){ cur+='"'; i++; continue; }
    if (c === '"'){ inQ = !inQ; continue; }
    if (c === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((c === '\n' || c === '\r') && !inQ){
      if (cur!=="" || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur="";
      continue;
    }
    cur += c;
  }
  if (cur!=="" || row.length){ row.push(cur); rows.push(row); }
  return rows;
}
function fmt2(n){ return (Math.round(n*100)/100).toLocaleString("es-CL"); }
function ymdToDMY(ymd){
  if (!ymd) return "";
  const [y,m,d]=ymd.split("-");
  return `${d}-${m}-${y}`;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

let allRows = [];
let filtered = [];
let charts = { cnc1:null, resp:null, mina:null, fecha:null };

const filterMap = new Map([
  ["f_fecha","FECHA"], ["f_mes","MES"], ["f_semana","SEMANA"], ["f_turno","TURNO"], ["f_grupo","GRUPO"], ["f_mina","MINA"],
  ["f_grado","GRADO"], ["f_suministro","SUMINISTRO"], ["f_sala","SALA DE CONTROL"], ["f_labor","LABOR_POSTURA"],
  ["f_cnc2","CNC _NIVEL 2"], ["f_cnc1","CNC _NIVEL 1"], ["f_resp","RESPONSABLE_CNC"],
  ["f_plan","PLANIFICADO"], ["f_sum","SUMINISTRADO"], ["f_pend","PENDIENTE"], ["f_rech","RECHAZADO"]
]);

async function fetchTextWithRetry(url, tries=3){
  let lastErr=null;
  for (let i=0;i<tries;i++){
    try{
      const bust = (url.includes("?") ? "&" : "?") + "cb=" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const res = await fetch(url + bust, { cache:"no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }catch(e){
      lastErr=e;
      await new Promise(r=>setTimeout(r, 400*(i+1)));
    }
  }
  throw lastErr || new Error("No se pudo cargar");
}

async function loadCSV(){
  const note = $("note");
  note.classList.remove("err");
  note.textContent = "Cargando datos‚Ä¶";

  const text = await fetchTextWithRetry(CSV_URL, 3);
  const grid = parseCSV(text);

  if (!grid.length){
    allRows=[];
    note.classList.add("err");
    note.textContent = "Error de red: CSV vac√≠o (no lleg√≥ contenido).";
    return;
  }

  const header = grid[0].map(h=>String(h||"").trim());
  const missing = HEADERS.filter(h=>!header.includes(h));
  if (missing.length){
    allRows=[];
    note.classList.add("err");
    note.textContent = "Faltan columnas en CSV: " + missing.join(", ");
    return;
  }

  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  const rows = grid.slice(1)
    .filter(r=>r.some(x=>String(x??"").trim()!==""))
    .map(r=>{
      const obj={};
      for (const h of HEADERS){
        obj[h] = (r[idx[h]] ?? "").toString().trim();
      }
      return obj;
    });

  allRows = rows;
  if (!allRows.length){
    note.textContent = "CSV sin filas (solo encabezados). Igual puedes ingresar registros con 'Nuevo registro'.";
  }else{
    note.textContent = `Datos cargados: ${allRows.length} registros.`;
  }
}

function fillDropdown(selectId, values, withAllLabel){
  const el = $(selectId);
  if (!el) return;
  const cur = el.value;
  el.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = withAllLabel || "Todos";
  el.appendChild(opt0);

  for (const v of values){
    const o=document.createElement("option");
    o.value=v;
    o.textContent=v;
    el.appendChild(o);
  }
  el.value = values.includes(cur) ? cur : "";
}

function buildFiltersFromData(){
  const u = (col)=>uniq(allRows.map(r=>(r[col]??"").trim()));
  fillDropdown("f_mes", u("MES"), "Todos");
  fillDropdown("f_semana", u("SEMANA"), "Todos");
  fillDropdown("f_turno", u("TURNO"), "Todos");
  fillDropdown("f_grupo", u("GRUPO"), "Todos");
  fillDropdown("f_mina", u("MINA"), "Todos");

  fillDropdown("f_grado", u("GRADO"), "Todos");
  fillDropdown("f_suministro", u("SUMINISTRO"), "Todos");
  fillDropdown("f_sala", u("SALA DE CONTROL"), "Todos");
  fillDropdown("f_labor", u("LABOR_POSTURA"), "Todos");
  fillDropdown("f_cnc2", u("CNC _NIVEL 2"), "Todos");
  fillDropdown("f_cnc1", u("CNC _NIVEL 1"), "Todos");

  fillDropdown("f_resp", u("RESPONSABLE_CNC"), "Todos");
  fillDropdown("f_fecha", u("FECHA"), "Todas");
  fillDropdown("f_plan", u("PLANIFICADO"), "Todos");
  fillDropdown("f_sum", u("SUMINISTRADO"), "Todos");
  fillDropdown("f_pend", u("PENDIENTE"), "Todos");
  fillDropdown("f_rech", u("RECHAZADO"), "Todos");
}

function buildModalDropdownsFromData(){
  const u = (col)=>{
    const fromData = uniq(allRows.map(r=>(r[col]??"").trim()));
    const fromCat = (CATALOG[col] || []).map(v=>String(v).trim()).filter(v=>v);
    return (fromData.length ? fromData : uniq(fromCat));
  };
  const fillModal = (id, col)=>{
    const el = $(id);
    if (!el) return;
    el.innerHTML = `<option value="">Seleccione‚Ä¶</option>` + u(col).map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  };
  fillModal("n_MES","MES");
  fillModal("n_SEMANA","SEMANA");
  fillModal("n_TURNO","TURNO");
  fillModal("n_GRUPO","GRUPO");
  fillModal("n_MINA","MINA");
  fillModal("n_LABOR","LABOR_POSTURA");
  fillModal("n_GRADO","GRADO");
  fillModal("n_SUMINISTRO","SUMINISTRO");
  fillModal("n_CNC2","CNC _NIVEL 2");
  fillModal("n_CNC1","CNC _NIVEL 1");
  fillModal("n_RESP","RESPONSABLE_CNC");
  fillModal("n_SALA","SALA DE CONTROL");
}

function applyFilters(){
  const q = $("q").value.trim().toLowerCase();
  let rows = allRows.slice();

  for (const [id, col] of filterMap){
    const v = ($(id)?.value ?? "").trim();
    if (v) rows = rows.filter(r => (r[col] ?? "").trim() === v);
  }

  if (q){
    rows = rows.filter(r => HEADERS.some(h => String(r[h] ?? "").toLowerCase().includes(q)));
  }

  filtered = rows;
  renderKPIs();
  renderCharts();
  renderTable();
}

function renderKPIs(){
  $("k_total").textContent = String(filtered.length);
  $("k_plan").textContent = fmt2(filtered.reduce((a,r)=>a+num(r["PLANIFICADO"]),0));
  $("k_sumi").textContent = fmt2(filtered.reduce((a,r)=>a+num(r["SUMINISTRADO"]),0));
  $("k_pend").textContent = fmt2(filtered.reduce((a,r)=>a+num(r["PENDIENTE"]),0));
  $("k_rech_sum").textContent = fmt2(filtered.reduce((a,r)=>a+num(r["RECHAZADO"]),0));
}

function groupCount(col){
  const m=new Map();
  for (const r of filtered){
    const k=(r[col]??"").trim() || "(vac√≠o)";
    m.set(k, (m.get(k)||0)+1);
  }
  return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
}
function groupSum(colGroup, colValue){
  const m=new Map();
  for (const r of filtered){
    const k=(r[colGroup]??"").trim() || "(vac√≠o)";
    m.set(k, (m.get(k)||0)+num(r[colValue]));
  }
  return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
}

function renderCharts(){
  const cnc = groupCount("CNC _NIVEL 1").slice(0,10);
  if (charts.cnc1) charts.cnc1.destroy();
  charts.cnc1 = new Chart($("chCnc1"), {
    type:"bar",
    data:{ labels: cnc.map(x=>x[0]), datasets:[{ label:"Registros", data: cnc.map(x=>x[1]) }]},
    options:{ responsive:true, maintainAspectRatio:false }
  });

  const resp = groupCount("RESPONSABLE_CNC").slice(0,12);
  if (charts.resp) charts.resp.destroy();
  charts.resp = new Chart($("chResp"), {
    type:"doughnut",
    data:{ labels: resp.map(x=>x[0]), datasets:[{ label:"Registros", data: resp.map(x=>x[1]) }]},
    options:{ responsive:true, maintainAspectRatio:false }
  });

  const planByM = groupSum("MINA","PLANIFICADO").slice(0,12);
  const minas = planByM.map(x=>x[0]);
  const plan = minas.map(m=> filtered.filter(r=>(r["MINA"]??"").trim()===m).reduce((a,r)=>a+num(r["PLANIFICADO"]),0));
  const sumi = minas.map(m=> filtered.filter(r=>(r["MINA"]??"").trim()===m).reduce((a,r)=>a+num(r["SUMINISTRADO"]),0));
  if (charts.mina) charts.mina.destroy();
  charts.mina = new Chart($("chMina"), {
    type:"bar",
    data:{ labels:minas, datasets:[{label:"Planificado", data:plan},{label:"Suministrado", data:sumi}] },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  const byF = new Map();
  for (const r of filtered){
    const f=(r["FECHA"]??"").trim() || "(vac√≠o)";
    if (!byF.has(f)) byF.set(f, {p:0,s:0});
    const o=byF.get(f);
    o.p += num(r["PLANIFICADO"]);
    o.s += num(r["SUMINISTRADO"]);
  }
  const fechas = Array.from(byF.keys()).sort((a,b)=>String(a).localeCompare(String(b)));
  if (charts.fecha) charts.fecha.destroy();
  charts.fecha = new Chart($("chFecha"), {
    type:"line",
    data:{ labels: fechas, datasets:[{label:"Planificado", data:fechas.map(f=>byF.get(f).p), tension:.25},{label:"Suministrado", data:fechas.map(f=>byF.get(f).s), tension:.25}] },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

function renderTable(){
  const head = $("tblHead");
  const body = $("tblBody");
  head.innerHTML = HEADERS.map(h=>`<th>${escapeHtml(h)}</th>`).join("");

  const maxRows = 600;
  const rows = filtered.slice(0,maxRows);
  body.innerHTML = rows.map(r=>{
    return "<tr>" + HEADERS.map(h=>`<td title="${escapeHtml(r[h]??"")}">${escapeHtml(r[h]??"")}</td>`).join("") + "</tr>";
  }).join("");

  const note = $("note");
  if (!allRows.length) return;
  note.classList.remove("err");
  note.textContent = `Mostrando ${filtered.length} registro(s)` + (filtered.length>maxRows ? ` ‚Ä¢ Mostrando ${maxRows} de ${filtered.length}` : "");
}

function openModal(){
  $("modalBg").style.display="flex";
  $("saveErr").style.display="none";
  $("saveOk").style.display="none";
  if (!$("n_FECHA").value){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    $("n_FECHA").value = `${y}-${m}-${dd}`;
  }
}
function closeModal(){ $("modalBg").style.display="none"; }

async function saveRecord(){
  $("saveErr").style.display="none";
  $("saveOk").style.display="none";

  const payload = {
    "FECHA": ymdToDMY($("n_FECHA").value),
    "MES": $("n_MES").value,
    "SEMANA": $("n_SEMANA").value,
    "TURNO": $("n_TURNO").value,
    "GRUPO": $("n_GRUPO").value,
    "MINA": $("n_MINA").value,
    "LABOR_POSTURA": $("n_LABOR").value,
    "GRADO": $("n_GRADO").value,
    "SUMINISTRO": $("n_SUMINISTRO").value,
    "PLANIFICADO": $("n_PLANIFICADO").value,
    "SUMINISTRADO": $("n_SUMINISTRADO").value,
    "PENDIENTE": $("n_PENDIENTE").value,
    "RECHAZADO": $("n_RECHAZADO").value,
    "REAGENDADO": $("n_REAGENDADO").value,
    "ELIMINADO": $("n_ELIMINADO").value,
    "N√öMERO GU√çA": $("n_GUIA").value,
    "HORA SALIDA PLANTA": $("n_HSAL").value,
    "HORA LLEGADA OBRA": $("n_HLLE").value,
    "HORA INICIO DESCARGA": $("n_HINI").value,
    "HORA TERMINO DESCARGA": $("n_HTER").value,
    "CNC _NIVEL 2": $("n_CNC2").value,
    "CNC _NIVEL 1": $("n_CNC1").value,
    "RESPONSABLE_CNC": $("n_RESP").value,
    "SALA DE CONTROL": $("n_SALA").value
  };

  try{
    await fetch(WEBAPP_URL, {
      method:"POST",
      mode:"no-cors",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    $("saveOk").style.display="block";
    setTimeout(async ()=>{
      try{ await boot(); closeModal(); }catch(e){ console.error(e); }
    }, 2500);

  }catch(err){
    console.error(err);
    $("saveErr").style.display="block";
  }
}

async function boot(){
  await loadCSV();
  buildFiltersFromData();
  buildModalDropdownsFromData();
  applyFilters();
}

$("btnNew").onclick = openModal;
$("btnClose").onclick = closeModal;
$("modalBg").addEventListener("click",(e)=>{ if(e.target.id==="modalBg") closeModal(); });
$("btnSave").onclick = saveRecord;

$("btnClear").onclick = ()=>{
  $("q").value="";
  for (const [id] of filterMap) $(id).value="";
  applyFilters();
};

$("btnPdf").onclick = ()=>window.print();

$("q").addEventListener("input", ()=>applyFilters());
for (const [id] of filterMap){
  $(id).addEventListener("change", ()=>applyFilters());
}

boot().catch(err=>{
  console.error(err);
  const note = $("note");
  note.classList.add("err");
  note.textContent = "Error de red: no se pudo leer el CSV. Revisa publicaci√≥n del Sheet y el link CSV.";
});
</script>
</body>
</html>
