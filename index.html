<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Seguimiento ‚Äì Hormig√≥n / CNC (Modo local)</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:rgba(15,23,42,.10);
    --shadow:0 10px 30px rgba(15,23,42,.08);
    --accent:#e11d2e;
    --accent2:#0ea5e9;
    --ok:#16a34a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
  }
  .wrap{max-width:1220px;margin:20px auto 60px; padding:0 16px;}
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:14px 16px;
    box-shadow:var(--shadow);
    position:sticky; top:12px; z-index:5;
  }
  .brand{display:flex; align-items:center; gap:12px; min-width:260px;}
  .brand .logoBox{
    width:160px; height:58px; border:1px solid var(--border); border-radius:14px;
    display:flex; align-items:center; justify-content:center; background:#fff; overflow:hidden;
  }
  .brand img{max-width:150px; height:46px; object-fit:contain; display:block;}
  .brandText h1{font-size:18px; margin:0; line-height:1.1;}
  .brandText p{margin:4px 0 0; font-size:12px; color:var(--muted);}
  .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  .btn{
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{filter:brightness(.98)}
  .btn.primary{background:var(--accent); border-color:transparent; color:#fff;}
  .btn.blue{background:var(--accent2); border-color:transparent; color:#fff;}
  .btn.ghost{background:#fff}
  .btn.small{padding:8px 10px; font-size:12px; border-radius:10px;}
  .panel{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:14px;
    box-shadow:var(--shadow);
  }
  .filtersHeader{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
  .hint{font-size:12px; color:var(--muted)}
  .filters{
    display:grid;
    grid-template-columns: 1.2fr repeat(5, 1fr);
    gap:10px;
    margin-top:10px;
  }
  .field label{display:block; font-size:11px; letter-spacing:.02em; color:var(--muted); font-weight:800; margin:0 0 6px}
  .field input, .field select{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid var(--border);
    outline:none;
    background:#fff;
    font-size:13px;
  }
  .field input:focus, .field select:focus{border-color: rgba(14,165,233,.55); box-shadow:0 0 0 4px rgba(14,165,233,.12)}
  .statusline{margin-top:10px; font-size:12px; color:var(--ok); font-weight:800}
  .cards{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
    margin-top:12px;
  }
  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px 12px;
    box-shadow: 0 8px 20px rgba(15,23,42,.06);
    position:relative;
    overflow:hidden;
    min-height:72px;
  }
  .card::after{
    content:"";
    position:absolute;
    right:-30px; top:-30px;
    width:90px; height:90px;
    border-radius:999px;
    background: rgba(225,29,46,.08);
  }
  .card .k{font-size:11px; color:var(--muted); font-weight:900; text-transform:uppercase}
  .card .v{font-size:22px; font-weight:900; margin-top:6px; letter-spacing:-.02em}
  .card .s{font-size:12px; color:var(--muted); margin-top:2px}
  .charts{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
    margin-top:14px;
  }
  .chartBox{
    background:#fff;
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px;
    box-shadow:var(--shadow);
    min-height:320px;
  }
  .chartTitle{font-weight:900; font-size:13px; margin:2px 2px 8px}
  .chartCanvasWrap{height:260px}
  canvas{max-width:100% !important;}
  .tableBox{
    margin-top:14px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .tableHead{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    padding:12px 12px;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, #ffffff, #fbfcff);
  }
  .tableHead h3{margin:0; font-size:13px}
  .tableWrap{overflow-x:auto; max-width:100%;}
  table{border-collapse:separate; border-spacing:0; width:100%; min-width:980px;}
  thead th{
    position:sticky; top:0;
    background:#0b1220;
    color:#fff;
    font-size:11px;
    text-align:left;
    padding:10px 10px;
    white-space:nowrap;
  }
  tbody td{
    font-size:12px;
    padding:9px 10px;
    border-bottom:1px solid rgba(15,23,42,.08);
    white-space:nowrap;
  }
  tbody tr:hover td{background:rgba(14,165,233,.06)}
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:3px 8px; border-radius:999px; font-weight:800; font-size:11px;
    border:1px solid rgba(15,23,42,.10);
    background:rgba(15,23,42,.03);
  }
  /* Modal */
  .backdrop{position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; z-index:50; padding:18px;}
  .modal{
    width:min(980px, 100%);
    background:#fff;
    border-radius:18px;
    box-shadow: 0 30px 80px rgba(2,6,23,.35);
    overflow:hidden;
    border:1px solid rgba(255,255,255,.12);
  }
  .modalHeader{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px; border-bottom:1px solid var(--border);}
  .modalHeader h2{margin:0; font-size:14px}
  .modalBody{padding:14px}
  .formGrid{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
  .modalFooter{display:flex; justify-content:flex-end; gap:10px; padding:14px; border-top:1px solid var(--border); background:#fbfcff;}
  .note{font-size:12px; color:var(--muted); margin:0 0 10px}
  .danger{color:#b91c1c; font-weight:800}
  @media (max-width: 1100px){
    .filters{grid-template-columns: 1.2fr repeat(3, 1fr);}
    .cards{grid-template-columns: repeat(2, 1fr);}
    .charts{grid-template-columns: 1fr;}
    .formGrid{grid-template-columns: repeat(2, 1fr);}
    .brand{min-width:auto}
  }
  @media (max-width: 560px){
    .filters{grid-template-columns: 1fr;}
    .actions{justify-content:flex-start}
    .formGrid{grid-template-columns: 1fr;}
    .brandText h1{font-size:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
  <div>
    <img src="logo_Xtreme.png" alt="Xtreme Mining" />
    <div>
        <div class="brandText">
          <h1>Dashboard Seguimiento ‚Äì Hormig√≥n / CNC</h1>
          <p>Xtreme Mining ¬∑ Modo local (ingreso + Excel/PDF) ¬∑ Fuente opcional: CSV publicado</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="btnConfig">‚öôÔ∏è Configurar fuente</button>
        <button class="btn" id="btnPlantilla">üì• Descargar plantilla</button>
        <button class="btn blue" id="btnNuevo">‚ûï Nuevo registro</button>
        <button class="btn" id="btnLimpiar">üßπ Limpiar filtros</button>
        <button class="btn primary" id="btnActualizar">üîÑ Actualizar</button>
        <button class="btn" id="btnExcel">üìä Excel</button>
        <button class="btn" id="btnPDF">üßæ PDF</button>
      </div>
    </div>

    <div class="panel" style="margin-top:14px">
      <div class="filtersHeader">
        <div>
          <div style="font-weight:900; font-size:13px">Filtros</div>
          <div class="hint">Filtra y luego exporta Excel/PDF. Los registros que ingresas quedan guardados en este navegador (localStorage).</div>
        </div>
        <div class="hint"><span class="pill">üíæ Local</span> <span id="localCount">0</span> registros ingresados</div>
      </div>

      <div class="filters" id="filtersGrid"></div>
      <div class="statusline" id="statusLine">Listo.</div>
      <div class="cards" id="cardsRow"></div>
    </div>

    <div class="charts">
      <div class="chartBox">
        <div class="chartTitle">Incidentes por CNC_NIVEL_1 (TOP 10)</div>
        <div class="chartCanvasWrap"><canvas id="chTopNivel1"></canvas></div>
      </div>

      <div class="chartBox">
        <div class="chartTitle">Distribuci√≥n por RESPONSABLE_CNC</div>
        <div class="chartCanvasWrap"><canvas id="chResponsable"></canvas></div>
      </div>

      <div class="chartBox">
        <div class="chartTitle">m¬≥ por MINA (Planificado vs Suministrado)</div>
        <div class="chartCanvasWrap"><canvas id="chMina"></canvas></div>
      </div>

      <div class="chartBox">
        <div class="chartTitle">m¬≥ por FECHA (Planificado vs Suministrado)</div>
        <div class="chartCanvasWrap"><canvas id="chFecha"></canvas></div>
      </div>
    </div>

    <div class="tableBox">
      <div class="tableHead">
        <h3>Detalle (todas las columnas)</h3>
        <div class="hint">La tabla tiene desplazamiento horizontal (scroll lateral).</div>
      </div>
      <div class="tableWrap">
        <table>
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbodyRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Config -->
  <div class="backdrop" id="cfgBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
      <div class="modalHeader">
        <h2 id="cfgTitle">Configurar fuente (opcional)</h2>
        <button class="btn small" id="cfgClose">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="note">Si tienes un CSV publicado de Google Sheets, p√©galo aqu√≠. Si lo dejas vac√≠o, el dashboard funcionar√° solo con tus registros locales.</p>
        <div class="field">
          <label>URL CSV publicado (Google Sheets)</label>
          <input id="csvUrlInput" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" />
        </div>
        <p class="note" style="margin-top:10px">Tip: si cambias la fuente, presiona <b>Actualizar</b>. Los registros ingresados localmente no se pierden.</p>
      </div>
      <div class="modalFooter">
        <button class="btn" id="cfgClear">Vaciar URL</button>
        <button class="btn primary" id="cfgSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo -->
  <div class="backdrop" id="newBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="newTitle">
      <div class="modalHeader">
        <h2 id="newTitle">Nuevo registro (se guarda en este navegador)</h2>
        <button class="btn small" id="newClose">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="note">
          Los desplegables se alimentan con valores √∫nicos de la base (CSV + registros locales). Si un valor no existe, puedes escribirlo en el campo.
          <span class="danger" id="newWarn" style="display:none"></span>
        </p>
        <div class="formGrid" id="newFormGrid"></div>
      </div>
      <div class="modalFooter">
        <button class="btn" id="newCancel">Cancelar</button>
        <button class="btn blue" id="newSave">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<script>
(() => {
  const LS_URL_KEY = "xtreme_hormigon_csv_url_v1";
  const LS_LOCAL_KEY = "xtreme_hormigon_local_rows_v1";

  const CORE_FIELDS = ["GRADO","SUMINISTRO","TURNO","GRUPO","SALA_CONTROL","MINA","LABOR_POSTURA","CNC_NIVEL_2","CNC_NIVEL_1","RESPONSABLE_CNC"];
  const NUM_CANDIDATES = ["PLANIFICADO","SUMINISTRADO","PENDIENTE","RECHAZADO"];
  const DATE_CANDIDATES = ["FECHA","Fecha","date","DATE"];

  let baseRows = [];
  let localRows = [];
  let allRows = [];
  let columns = [];

  const charts = { topNivel1:null, resp:null, mina:null, fecha:null };

  const $ = (id) => document.getElementById(id);
  const safeStr = (v) => (v===null||v===undefined) ? "" : String(v).trim();

  function toNumber(v){
    const s = safeStr(v).replace(/\./g,"").replace(",",".");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }

  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i<text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQuotes=false; i++; continue;
        }
        field += c; i++; continue;
      }
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ","){ row.push(field); field=""; i++; continue; }
      if(c === "\n"){ row.push(field); field=""; rows.push(row); row=[]; i++; continue; }
      if(c === "\r"){ i++; continue; }
      field += c; i++;
    }
    row.push(field); rows.push(row);
    return rows;
  }

  function normalizeKey(k){
    return safeStr(k).toUpperCase()
      .replace(/\s+/g,"_")
      .replace(/[^A-Z0-9_]/g,"_")
      .replace(/_+/g,"_")
      .replace(/^_+|_+$/g,"");
  }

  function remapHeaders(headers){
    const map = {};
    headers.forEach(h => map[h] = normalizeKey(h));
    return map;
  }

  function applyHeaderMap(obj, headerMap){
    const out = {};
    for(const [k,v] of Object.entries(obj)){
      const nk = headerMap[k] || normalizeKey(k);
      out[nk] = v;
    }
    return out;
  }

  function normalizeRow(row){
    const out = {};
    for(const k of Object.keys(row)) out[normalizeKey(k)] = row[k];
    return out;
  }

  function unionColumns(rows){
    const set = new Set();
    rows.forEach(r => Object.keys(r).forEach(k=>set.add(k)));
    const core = CORE_FIELDS.filter(c=>set.has(c));
    const rest = [...set].filter(k=>!core.includes(k)).sort((a,b)=>a.localeCompare(b));
    return [...core, ...rest];
  }

  function uniqueValues(rows, key){
    const set = new Set();
    rows.forEach(r => { const v = safeStr(r[key]); if(v) set.add(v); });
    return [...set].sort((a,b)=>a.localeCompare(b,"es"));
  }

  function getDateField(){
    const normalizedCandidates = DATE_CANDIDATES.map(normalizeKey);
    return normalizedCandidates.find(k => columns.includes(k)) || (columns.includes("FECHA") ? "FECHA" : null);
  }

  function formatInt(n){ return new Intl.NumberFormat("es-CL").format(n); }
  function formatNum(n){ return new Intl.NumberFormat("es-CL",{maximumFractionDigits:2}).format(n); }

  const filterState = {};

  function buildFilters(){
    const grid = $("filtersGrid");
    grid.innerHTML = "";

    const search = document.createElement("div");
    search.className = "field";
    search.innerHTML = `
      <label>Buscar (texto libre)</label>
      <input id="f_Q" placeholder="Ej: 'ESMERALDA', 'Ruta', 'C-23'..." />
    `;
    grid.appendChild(search);

    const possible = ["MES","SEMANA","TURNO","GRADO","SUMINISTRO","GRUPO","SALA_CONTROL","MINA","LABOR_POSTURA","CNC_NIVEL_2","CNC_NIVEL_1","RESPONSABLE_CNC","FECHA"];
    for(const key of possible){
      const nk = normalizeKey(key);
      if(!columns.includes(nk)) continue;
      const box = document.createElement("div");
      box.className = "field";
      box.innerHTML = `<label>${nk}</label><select id="f_${nk}"><option value="">Todos</option></select>`;
      grid.appendChild(box);
    }

    $("f_Q").addEventListener("input", () => { filterState.Q = $("f_Q").value; renderAll(); });
    possible.forEach(key=>{
      const nk = normalizeKey(key);
      const el = $("f_"+nk);
      if(!el) return;
      el.addEventListener("change", ()=>{ filterState[nk]=el.value; renderAll(); });
    });

    populateFilterOptions();
  }

  function populateFilterOptions(){
    const possible = ["MES","SEMANA","TURNO","GRADO","SUMINISTRO","GRUPO","SALA_CONTROL","MINA","LABOR_POSTURA","CNC_NIVEL_2","CNC_NIVEL_1","RESPONSABLE_CNC","FECHA"];
    for(const key of possible){
      const nk = normalizeKey(key);
      const sel = $("f_"+nk);
      if(!sel) continue;
      const cur = sel.value;
      sel.innerHTML = `<option value="">Todos</option>`;
      uniqueValues(allRows, nk).forEach(v=>{
        const opt = document.createElement("option");
        opt.value=v; opt.textContent=v;
        sel.appendChild(opt);
      });
      sel.value = cur || "";
    }
  }

  function filterRows(){
    const q = safeStr(filterState.Q).toLowerCase();
    return allRows.filter(r=>{
      if(q){
        const hay = columns.map(c=>safeStr(r[c])).join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      for(const [k,v] of Object.entries(filterState)){
        if(k==="Q"||!v) continue;
        if(safeStr(r[k]) !== v) return false;
      }
      return true;
    });
  }

  function buildCards(filtered){
    const row = $("cardsRow");
    row.innerHTML = "";
    const total = filtered.length;

    const defs = [{title:"Registros filtrados", value:formatInt(total), sub:"Total visible seg√∫n filtros"}];
    for(const k of NUM_CANDIDATES){
      if(columns.includes(k)){
        const sum = filtered.reduce((a,r)=>a+toNumber(r[k]),0);
        defs.push({title:`${k} (suma)`, value:formatNum(sum), sub:`Suma columna ${k}`});
      }
    }
    defs.slice(0,5).forEach(d=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML = `<div class="k">${d.title}</div><div class="v">${d.value}</div><div class="s">${d.sub}</div>`;
      row.appendChild(div);
    });
  }

  function renderTable(filtered){
    const thead=$("theadRow"), tbody=$("tbodyRows");
    thead.innerHTML=""; tbody.innerHTML="";
    columns.forEach(c=>{
      const th=document.createElement("th");
      th.textContent=c;
      thead.appendChild(th);
    });

    const maxRows=500;
    filtered.slice(0,maxRows).forEach(r=>{
      const tr=document.createElement("tr");
      columns.forEach(c=>{
        const td=document.createElement("td");
        td.textContent=safeStr(r[c]);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    if(filtered.length>maxRows){
      const tr=document.createElement("tr");
      const td=document.createElement("td");
      td.colSpan=columns.length;
      td.style.color="#64748b";
      td.style.fontWeight="800";
      td.textContent=`Mostrando ${maxRows} de ${filtered.length} filas. (Exporta Excel/PDF para todo)`;
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  }

  function destroyChart(ch){ if(ch) try{ ch.destroy(); }catch(e){} return null; }

  function chartTopNivel1(filtered){
    const key = columns.includes("CNC_NIVEL_1") ? "CNC_NIVEL_1" : null;
    const ctx = $("chTopNivel1").getContext("2d");
    if(!key){ charts.topNivel1=destroyChart(charts.topNivel1); return; }
    const counts=new Map();
    filtered.forEach(r=>{
      const v=safeStr(r[key])||"(vac√≠o)";
      counts.set(v,(counts.get(v)||0)+1);
    });
    const items=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
    charts.topNivel1=destroyChart(charts.topNivel1);
    charts.topNivel1=new Chart(ctx,{
      type:"bar",
      data:{labels:items.map(x=>x[0]), datasets:[{label:"Cantidad", data:items.map(x=>x[1])}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{maxRotation:30,minRotation:30}}}}
    });
  }

  function chartResponsable(filtered){
    const key = columns.includes("RESPONSABLE_CNC") ? "RESPONSABLE_CNC" : null;
    const ctx = $("chResponsable").getContext("2d");
    if(!key){ charts.resp=destroyChart(charts.resp); return; }
    const counts=new Map();
    filtered.forEach(r=>{
      const v=safeStr(r[key])||"(vac√≠o)";
      counts.set(v,(counts.get(v)||0)+1);
    });
    const items=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
    charts.resp=destroyChart(charts.resp);
    charts.resp=new Chart(ctx,{
      type:"doughnut",
      data:{labels:items.map(x=>x[0]), datasets:[{data:items.map(x=>x[1])}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}}
    });
  }

  function chartMina(filtered){
    const minaKey = columns.includes("MINA") ? "MINA" : null;
    const pKey = columns.includes("PLANIFICADO") ? "PLANIFICADO" : null;
    const sKey = columns.includes("SUMINISTRADO") ? "SUMINISTRADO" : null;
    const ctx = $("chMina").getContext("2d");
    if(!minaKey || (!pKey && !sKey)){ charts.mina=destroyChart(charts.mina); return; }

    const agg=new Map();
    filtered.forEach(r=>{
      const m=safeStr(r[minaKey])||"(sin mina)";
      if(!agg.has(m)) agg.set(m,{p:0,s:0});
      const o=agg.get(m);
      if(pKey) o.p += toNumber(r[pKey]);
      if(sKey) o.s += toNumber(r[sKey]);
    });
    const items=[...agg.entries()].sort((a,b)=>(b[1].p+b[1].s)-(a[1].p+a[1].s)).slice(0,12);
    charts.mina=destroyChart(charts.mina);
    charts.mina=new Chart(ctx,{
      type:"bar",
      data:{labels:items.map(x=>x[0]),
        datasets:[
          pKey?{label:"Planificado", data:items.map(x=>x[1].p)}:null,
          sKey?{label:"Suministrado", data:items.map(x=>x[1].s)}:null
        ].filter(Boolean)
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}, scales:{x:{ticks:{maxRotation:20,minRotation:20}}}}
    });
  }

  function chartFecha(filtered){
    const dKey = getDateField();
    const pKey = columns.includes("PLANIFICADO") ? "PLANIFICADO" : null;
    const sKey = columns.includes("SUMINISTRADO") ? "SUMINISTRADO" : null;
    const ctx = $("chFecha").getContext("2d");
    if(!dKey || (!pKey && !sKey)){ charts.fecha=destroyChart(charts.fecha); return; }

    const agg=new Map();
    filtered.forEach(r=>{
      const d=safeStr(r[dKey]);
      if(!d) return;
      if(!agg.has(d)) agg.set(d,{p:0,s:0});
      const o=agg.get(d);
      if(pKey) o.p += toNumber(r[pKey]);
      if(sKey) o.s += toNumber(r[sKey]);
    });
    const labels=[...agg.keys()].sort((a,b)=>a.localeCompare(b));
    charts.fecha=destroyChart(charts.fecha);
    charts.fecha=new Chart(ctx,{
      type:"line",
      data:{labels,
        datasets:[
          pKey?{label:"Planificado", data:labels.map(d=>agg.get(d).p), tension:.25}:null,
          sKey?{label:"Suministrado", data:labels.map(d=>agg.get(d).s), tension:.25}:null
        ].filter(Boolean)
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}, elements:{point:{radius:2}}, scales:{x:{ticks:{maxRotation:30,minRotation:30}}}}
    });
  }

  function openBackdrop(id){ $(id).style.display="flex"; }
  function closeBackdrop(id){ $(id).style.display="none"; }

  function loadLocal(){
    try{ localRows = JSON.parse(localStorage.getItem(LS_LOCAL_KEY) || "[]") || []; }
    catch(e){ localRows = []; }
  }
  function saveLocal(){
    localStorage.setItem(LS_LOCAL_KEY, JSON.stringify(localRows));
    $("localCount").textContent = String(localRows.length);
  }
  function addLocalRow(row){
    const stamp = new Date().toISOString();
    localRows.push({...row, _LOCAL_CREATED_AT: stamp});
    saveLocal();
  }

  async function loadCSV(url){
    if(!url){ baseRows=[]; return; }
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("No se pudo cargar CSV (status "+res.status+")");
    const text = await res.text();
    const raw = parseCSV(text);
    if(!raw.length){ baseRows=[]; return; }

    const headers = raw[0].map(h=>safeStr(h));
    const headerMap = remapHeaders(headers);

    const data = [];
    for(let i=1;i<raw.length;i++){
      const arr = raw[i];
      if(arr.length===1 && safeStr(arr[0])==="") continue;
      const obj = {};
      headers.forEach((h,idx)=>{ obj[h] = arr[idx] ?? ""; });
      const mapped = applyHeaderMap(obj, headerMap);
      data.push(normalizeRow(mapped));
    }
    baseRows = data;
  }

  function rebuildAllRows(){
    allRows = [...(baseRows||[]), ...(localRows||[])].map(normalizeRow);
    // si no hay datos a√∫n, crea columnas base para que existan desplegables
    if(!allRows.length){
      columns = [...CORE_FIELDS, ...NUM_CANDIDATES, "FECHA", "MES", "SEMANA"];
      return;
    }
    columns = unionColumns(allRows);
  }

  function buildNewForm(){
    const grid = $("newFormGrid");
    grid.innerHTML = "";

    const formCols = (() => {
      const basic = new Set(CORE_FIELDS);
      NUM_CANDIDATES.forEach(k=>{ if(columns.includes(k)) basic.add(k); });
      const dKey = getDateField(); if(dKey) basic.add(dKey);
      ["MES","SEMANA"].forEach(k=>{ if(columns.includes(k)) basic.add(k); });
      return [...basic];
    })();

    const uniq = {};
    formCols.forEach(k => uniq[k] = uniqueValues(allRows, k));

    formCols.forEach(k=>{
      const box=document.createElement("div");
      box.className="field";
      box.innerHTML = `
        <label>${k}</label>
        <div style="display:grid; grid-template-columns: 1fr; gap:6px;">
          <select id="n_${k}_sel"><option value="">(Escribir o elegir)</option></select>
          <input id="n_${k}" placeholder="Texto" />
        </div>
      `;
      grid.appendChild(box);
      const sel = $("n_"+k+"_sel");
      uniq[k].slice(0,250).forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v; opt.textContent=v;
        sel.appendChild(opt);
      });
      sel.addEventListener("change", ()=>{ $("n_"+k).value = sel.value; });
    });
  }

  function renderAll(){
    const filtered = filterRows();
    buildCards(filtered);
    renderTable(filtered);
    chartTopNivel1(filtered);
    chartResponsable(filtered);
    chartMina(filtered);
    chartFecha(filtered);
    $("statusLine").textContent = `Filtrado: ${filtered.length} filas ¬∑ Base: ${baseRows.length} ¬∑ Local: ${localRows.length}`;
  }

  function exportExcel(filtered){
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(filtered.map(r=>{
      const o={};
      columns.forEach(c=>o[c]=safeStr(r[c]));
      return o;
    }));
    XLSX.utils.book_append_sheet(wb, ws, "Datos");
    XLSX.writeFile(wb, `Hormigon_CNC_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  function downloadTemplate(){
    const wb = XLSX.utils.book_new();
    const headers = [...new Set(["FECHA","MES","SEMANA", ...CORE_FIELDS, ...NUM_CANDIDATES])];
    const ws = XLSX.utils.aoa_to_sheet([headers]);
    XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
    XLSX.writeFile(wb, "Plantilla_Hormigon_CNC.xlsx");
  }

  function exportPDF(filtered){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    doc.text("Dashboard Seguimiento ‚Äì Hormig√≥n / CNC (Exportaci√≥n)", 40, 40);
    doc.setFont("helvetica","normal"); doc.setFontSize(10);
    doc.text(`Fecha: ${new Date().toLocaleString("es-CL")}   ‚Ä¢   Filas: ${filtered.length}   ‚Ä¢   Local: ${localRows.length}`, 40, 60);

    const head = [columns];
    const body = filtered.slice(0,2000).map(r=>columns.map(c=>safeStr(r[c])));
    doc.autoTable({
      startY: 80,
      head, body,
      styles:{fontSize:7, cellPadding:3},
      headStyles:{fillColor:[11,18,32]},
      theme:"grid",
      margin:{left:40,right:40},
      tableWidth:"auto",
    });
    doc.save(`Hormigon_CNC_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Buttons
  $("btnLimpiar").addEventListener("click", ()=>{
    for(const k of Object.keys(filterState)) delete filterState[k];
    const q=$("f_Q"); if(q) q.value="";
    document.querySelectorAll('[id^="f_"]').forEach(el=>{ if(el.tagName==="SELECT") el.value=""; });
    renderAll();
  });

  $("btnActualizar").addEventListener("click", ()=> bootstrap());
  $("btnExcel").addEventListener("click", ()=> exportExcel(filterRows()));
  $("btnPDF").addEventListener("click", ()=> exportPDF(filterRows()));
  $("btnPlantilla").addEventListener("click", ()=> downloadTemplate());

  $("btnConfig").addEventListener("click", ()=>{
    $("csvUrlInput").value = localStorage.getItem(LS_URL_KEY) || "";
    openBackdrop("cfgBackdrop");
  });
  $("cfgClose").addEventListener("click", ()=> closeBackdrop("cfgBackdrop"));
  $("cfgBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="cfgBackdrop") closeBackdrop("cfgBackdrop"); });
  $("cfgClear").addEventListener("click", ()=>{ $("csvUrlInput").value=""; });
  $("cfgSave").addEventListener("click", ()=>{
    const url = $("csvUrlInput").value.trim();
    if(url) localStorage.setItem(LS_URL_KEY,url);
    else localStorage.removeItem(LS_URL_KEY);
    closeBackdrop("cfgBackdrop");
    bootstrap();
  });

  $("btnNuevo").addEventListener("click", ()=>{
    buildNewForm();
    openBackdrop("newBackdrop");
  });
  $("newClose").addEventListener("click", ()=> closeBackdrop("newBackdrop"));
  $("newCancel").addEventListener("click", ()=> closeBackdrop("newBackdrop"));
  $("newBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="newBackdrop") closeBackdrop("newBackdrop"); });

  $("newSave").addEventListener("click", ()=>{
    const row = {};
    document.querySelectorAll('[id^="n_"]').forEach(el=>{
      if(el.tagName!=="INPUT") return;
      const k = el.id.slice(2);
      row[k] = el.value.trim();
    });
    const filled = CORE_FIELDS.filter(k=>safeStr(row[k]));
    if(filled.length < 2){
      $("newWarn").style.display="inline";
      $("newWarn").textContent=" ¬∑ Completa al menos 2 campos principales (por ejemplo MINA y CNC_NIVEL_1).";
      return;
    }
    $("newWarn").style.display="none";
    addLocalRow(normalizeRow(row));
    rebuildAllRows();
    populateFilterOptions();
    renderAll();
    closeBackdrop("newBackdrop");
  });

  async function bootstrap(){
    $("statusLine").textContent = "Cargando...";
    loadLocal(); saveLocal();

    const url = localStorage.getItem(LS_URL_KEY) || "";
    try{
      await loadCSV(url);
      rebuildAllRows();
      buildFilters();
      populateFilterOptions();
      renderAll();
      $("statusLine").textContent = `CSV cargado: ${baseRows.length} filas. Local: ${localRows.length} filas.`;
    }catch(e){
      baseRows=[];
      rebuildAllRows();
      buildFilters();
      populateFilterOptions();
      renderAll();
      $("statusLine").innerHTML = `<span class="danger">No se pudo cargar el CSV.</span> Trabajando solo con registros locales. (Detalle: ${e.message})`;
    }
  }

  bootstrap();
})();
</script>
</body>
</html>
