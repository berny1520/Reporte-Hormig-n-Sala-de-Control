<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Hormig√≥n / CNC</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --dark:#0f172a;
      --accent:#ef4444; /* rojo */
      --accent2:#334155; /* gris oscuro */
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .topbar{
      background: linear-gradient(90deg, #0b1020, #111827);
      color:#fff;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px;
    }
    .logo{
      width:52px;height:34px;
      border-radius:8px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
      font-weight:800;
      letter-spacing:.5px;
    }
    .titles .h1{
      font-weight:800;
      font-size:14px;
      line-height:1.15;
    }
    .titles .h2{
      font-size:11px;
      color: rgba(255,255,255,.75);
      margin-top:2px;
      line-height:1.1;
    }
    .container{
      max-width: 1320px;
      margin: 16px auto 40px;
      padding: 0 14px;
    }

    .filters{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr auto auto;
      gap: 10px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
      letter-spacing:.2px;
    }
    input[type="text"], select{
      width:100%;
      height:36px;
      border-radius:10px;
      border:1px solid var(--line);
      padding:0 10px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    input[type="text"]:focus, select:focus{
      border-color:#c7cdd6;
      box-shadow: 0 0 0 3px rgba(148,163,184,.25);
    }
    .btn{
      height:36px;
      padding: 0 12px;
      border-radius:10px;
      border:1px solid transparent;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn.secondary{
      background: var(--accent2);
      color:#fff;
    }
    .btn.danger{
      background: var(--accent);
      color:#fff;
    }
    .btn:active{ transform: translateY(1px); }

    .grid-kpis{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    .kpi{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      position:relative;
      overflow:hidden;
      min-height:76px;
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .kpi .value{
      font-size:22px;
      font-weight:900;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }
    .kpi::after{
      content:"";
      position:absolute;
      right:-40px; top:-40px;
      width:100px;height:100px;
      border-radius:50%;
      background: rgba(239,68,68,.08);
    }

    .grid-charts{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .card h3{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.2px;
      color:#0f172a;
      font-weight:900;
    }
    .chartbox{
      height: 280px;
    }

    .grid-charts-2{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .table-wrap{
      margin-top:12px;
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid var(--line);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 980px;
      background: #fff;
    }
    thead th{
      position:sticky;
      top:0;
      background:#0f172a;
      color:#fff;
      font-size:11px;
      text-align:left;
      padding:10px;
      z-index:1;
      white-space:nowrap;
    }
    tbody td{
      font-size:12px;
      padding:9px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody tr:nth-child(even){
      background:#fafafa;
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      border:1px solid var(--line);
    }
    .pill.CODELCO{ background: rgba(59,130,246,.12); }
    .pill.INTERNA{ background: rgba(148,163,184,.18); }
    .pill.SUMINISTRO{ background: rgba(249,115,22,.14); }

    .footer-note{
      margin-top:10px;
      color:var(--muted);
      font-size:11px;
    }

    /* Responsive */
    @media (max-width:1200px){
      .filters{ grid-template-columns: 1fr 1fr 1fr 1fr; }
      .grid-kpis{ grid-template-columns: repeat(3, 1fr); }
      .grid-charts{ grid-template-columns: 1fr; }
      .grid-charts-2{ grid-template-columns: 1fr; }
    }

    /* Print (Export PDF) */
    @media print{
      .topbar{ position:static; box-shadow:none; }
      .btn, .footer-note{ display:none !important; }
      body{ background:#fff; }
      .container{ max-width:none; margin:0; }
      .filters{ grid-template-columns: 1fr 1fr 1fr 1fr; }
      .card, .kpi{ box-shadow:none; }
      .chartbox{ height: 240px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">XT</div>
      <div class="titles">
        <div class="h1">Dashboard Hormig√≥n / CNC ‚Äì Seguimiento</div>
        <div class="h2">Datos desde Google Sheets (CSV) ‚Ä¢ Vista ejecutiva</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- FILTROS -->
    <div class="filters">
      <div class="field">
        <label>Buscar (RUT / texto)</label>
        <input id="q" type="text" placeholder="Ej: 12.345.678-9 o 'Interferencia'..." />
      </div>

      <div class="field">
        <label>GRADO</label>
        <select id="f_grado"><option value="">Todos</option></select>
      </div>
      <div class="field">
        <label>SUMINISTRO</label>
        <select id="f_suministro"><option value="">Todos</option></select>
      </div>
      <div class="field">
        <label>TURNO</label>
        <select id="f_turno"><option value="">Todos</option></select>
      </div>
      <div class="field">
        <label>GRUPO</label>
        <select id="f_grupo"><option value="">Todos</option></select>
      </div>
      <div class="field">
        <label>MINA</label>
        <select id="f_mina"><option value="">Todos</option></select>
      </div>
      <div class="field">
        <label>RESPONSABLE</label>
        <select id="f_responsable"><option value="">Todos</option></select>
      </div>

      <button class="btn secondary" id="btnReset">üßπ Limpiar filtros</button>
      <button class="btn danger" id="btnPdf">‚¨á Exportar PDF</button>
    </div>

    <!-- KPIs -->
    <div class="grid-kpis">
      <div class="kpi">
        <div class="label">REGISTROS FILTRADOS</div>
        <div class="value" id="k_total">0</div>
        <div class="sub">Total visible seg√∫n filtros</div>
      </div>
      <div class="kpi">
        <div class="label">MINAS √öNICAS</div>
        <div class="value" id="k_minas">0</div>
        <div class="sub">Diversidad de frentes</div>
      </div>
      <div class="kpi">
        <div class="label">CNC NIVEL 1 (TOP)</div>
        <div class="value" id="k_top_cnc1">-</div>
        <div class="sub">Causa principal</div>
      </div>
      <div class="kpi">
        <div class="label">CODELCO</div>
        <div class="value" id="k_codelco">0</div>
        <div class="sub">Responsable CNC</div>
      </div>
      <div class="kpi">
        <div class="label">INTERNA</div>
        <div class="value" id="k_interna">0</div>
        <div class="sub">Responsable CNC</div>
      </div>
      <div class="kpi">
        <div class="label">SUMINISTRO</div>
        <div class="value" id="k_sum">0</div>
        <div class="sub">Responsable CNC</div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="grid-charts">
      <div class="card">
        <h3>Incidentes por CNC NIVEL 1</h3>
        <div class="chartbox"><canvas id="chCnc1"></canvas></div>
      </div>

      <div class="card">
        <h3>Distribuci√≥n por Responsable</h3>
        <div class="chartbox"><canvas id="chResp"></canvas></div>
      </div>
    </div>

    <div class="grid-charts-2">
      <div class="card">
        <h3>Incidentes por Mina</h3>
        <div class="chartbox"><canvas id="chMina"></canvas></div>
      </div>

      <div class="card">
        <h3>Incidentes por Turno</h3>
        <div class="chartbox"><canvas id="chTurno"></canvas></div>
      </div>
    </div>

    <!-- TABLA -->
    <div class="card" style="margin-top:12px;">
      <h3>Detalle de Registros</h3>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr id="tblHead"></tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div class="footer-note" id="note">Cargando datos‚Ä¶</div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQpnX_1KJzAhOEvVGx_AaCV-FfoLl37pOHX5S4MZY_IejaX78BBgGLFR8fn2AzwmwEQWdpL5Ln2kI2/pub?gid=1538363274&single=true&output=csv";

  // Columnas esperadas (para filtros y vistas)
  const COLS = [
    "GRADO","SUMINISTRO","TURNO","GRUPO","SALA_CONTROL","MINA",
    "LABORPOSTURA","CNC_NIVEL_2","CNC_NIVEL_1","RESPONSABLE_CNC"
  ];

  // ====== STATE ======
  let rawRows = [];     // [{col:val,...}]
  let viewRows = [];    // filtered rows
  let charts = {};      // Chart instances

  // ====== HELPERS ======
  function csvParse(text){
    // Parser simple (soporta comillas)
    const rows = [];
    let cur = "", inQ = false;
    const out = [[]];
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const nxt = text[i+1];
      if (ch === '"' && nxt === '"'){ cur += '"'; i++; continue; }
      if (ch === '"'){ inQ = !inQ; continue; }
      if (!inQ && ch === ','){ out[out.length-1].push(cur); cur=""; continue; }
      if (!inQ && (ch === '\n' || ch === '\r')){
        if (ch === '\r' && nxt === '\n') i++;
        out[out.length-1].push(cur); cur="";
        out.push([]);
        continue;
      }
      cur += ch;
    }
    out[out.length-1].push(cur);

    // remove trailing empty line
    const cleaned = out.filter(r => r.length > 1 || (r[0] && r[0].trim() !== ""));
    return cleaned;
  }

  function uniq(arr){
    return [...new Set(arr.filter(v => v !== null && v !== undefined && String(v).trim() !== ""))]
      .map(v => String(v).trim())
      .sort((a,b)=>a.localeCompare(b, "es"));
  }

  function countBy(rows, key){
    const m = new Map();
    rows.forEach(r=>{
      const v = (r[key] ?? "").toString().trim() || "(vac√≠o)";
      m.set(v, (m.get(v)||0)+1);
    });
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  function topLabel(countPairs){
    if (!countPairs.length) return "-";
    return countPairs[0][0];
  }

  function setOptions(selectEl, values){
    const current = selectEl.value;
    selectEl.innerHTML = `<option value="">Todos</option>` + values.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    // try keep selected if still exists
    if (values.includes(current)) selectEl.value = current;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function getFilters(){
    return {
      q: document.getElementById("q").value.trim().toLowerCase(),
      GRADO: document.getElementById("f_grado").value,
      SUMINISTRO: document.getElementById("f_suministro").value,
      TURNO: document.getElementById("f_turno").value,
      GRUPO: document.getElementById("f_grupo").value,
      MINA: document.getElementById("f_mina").value,
      RESPONSABLE_CNC: document.getElementById("f_responsable").value,
    };
  }

  function applyFilters(){
    const f = getFilters();
    viewRows = rawRows.filter(r=>{
      // dropdown filters
      for (const k of ["GRADO","SUMINISTRO","TURNO","GRUPO","MINA","RESPONSABLE_CNC"]){
        if (f[k] && String(r[k] ?? "").trim() !== f[k]) return false;
      }
      // search
      if (f.q){
        const blob = COLS.map(c => (r[c] ?? "")).join(" ").toLowerCase();
        if (!blob.includes(f.q)) return false;
      }
      return true;
    });

    renderKPIs();
    renderCharts();
    renderTable();
    document.getElementById("note").textContent = `Registros: ${viewRows.length.toLocaleString("es-CL")} (filtrados)`;
  }

  function renderKPIs(){
    const total = viewRows.length;
    const minas = uniq(viewRows.map(r=>r.MINA)).length;
    const cnc1 = countBy(viewRows, "CNC_NIVEL_1");
    const respPairs = countBy(viewRows, "RESPONSABLE_CNC");

    const codelco = respPairs.find(([k])=>k==="CODELCO")?.[1] ?? 0;
    const interna = respPairs.find(([k])=>k==="INTERNA")?.[1] ?? 0;
    const sum = respPairs.find(([k])=>k==="SUMINISTRO")?.[1] ?? 0;

    document.getElementById("k_total").textContent = total.toLocaleString("es-CL");
    document.getElementById("k_minas").textContent = minas.toLocaleString("es-CL");
    document.getElementById("k_top_cnc1").textContent = topLabel(cnc1);
    document.getElementById("k_codelco").textContent = codelco.toLocaleString("es-CL");
    document.getElementById("k_interna").textContent = interna.toLocaleString("es-CL");
    document.getElementById("k_sum").textContent = sum.toLocaleString("es-CL");
  }

  function renderCharts(){
    // CNC NIVEL 1 (bar)
    const cnc1 = countBy(viewRows, "CNC_NIVEL_1").slice(0, 10);
    const cncLabels = cnc1.map(x=>x[0]);
    const cncVals = cnc1.map(x=>x[1]);

    charts.cnc1 = makeOrUpdateChart("chCnc1", charts.cnc1, {
      type: "bar",
      data: { labels: cncLabels, datasets: [{ label: "Cantidad", data: cncVals }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ ticks:{ maxRotation:45, minRotation:20 } }, y:{ beginAtZero:true } }
      }
    });

    // Responsable (doughnut)
    const resp = countBy(viewRows, "RESPONSABLE_CNC").slice(0, 8);
    charts.resp = makeOrUpdateChart("chResp", charts.resp, {
      type:"doughnut",
      data:{ labels: resp.map(x=>x[0]), datasets:[{ data: resp.map(x=>x[1]) }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
    });

    // Mina (bar)
    const mina = countBy(viewRows, "MINA").slice(0, 12);
    charts.mina = makeOrUpdateChart("chMina", charts.mina, {
      type:"bar",
      data:{ labels: mina.map(x=>x[0]), datasets:[{ label:"Cantidad", data: mina.map(x=>x[1]) }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true } }
      }
    });

    // Turno (bar)
    const turno = countBy(viewRows, "TURNO");
    charts.turno = makeOrUpdateChart("chTurno", charts.turno, {
      type:"bar",
      data:{ labels: turno.map(x=>x[0]), datasets:[{ label:"Cantidad", data: turno.map(x=>x[1]) }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  function makeOrUpdateChart(canvasId, chartInstance, config){
    const ctx = document.getElementById(canvasId);
    if (chartInstance){
      chartInstance.config.type = config.type;
      chartInstance.data = config.data;
      chartInstance.options = config.options;
      chartInstance.update();
      return chartInstance;
    }
    return new Chart(ctx, config);
  }

  function renderTable(){
    const head = document.getElementById("tblHead");
    const body = document.getElementById("tblBody");

    // Header
    head.innerHTML = COLS.map(c=>`<th>${escapeHtml(c)}</th>`).join("");

    // Body (limit for performance)
    const maxRows = 600;
    const rows = viewRows.slice(0, maxRows);
    body.innerHTML = rows.map(r=>{
      return `<tr>` + COLS.map(c=>{
        const val = (r[c] ?? "").toString().trim();
        if (c === "RESPONSABLE_CNC"){
          const klass = val || "";
          return `<td><span class="pill ${escapeHtml(klass)}">${escapeHtml(val || "-")}</span></td>`;
        }
        return `<td title="${escapeHtml(val)}">${escapeHtml(val)}</td>`;
      }).join("") + `</tr>`;
    }).join("");

    if (viewRows.length > maxRows){
      const note = document.getElementById("note");
      note.textContent += ` ‚Ä¢ Mostrando ${maxRows} de ${viewRows.length}`;
    }
  }

  function fillDropdownsFromRaw(){
    setOptions(document.getElementById("f_grado"), uniq(rawRows.map(r=>r.GRADO)));
    setOptions(document.getElementById("f_suministro"), uniq(rawRows.map(r=>r.SUMINISTRO)));
    setOptions(document.getElementById("f_turno"), uniq(rawRows.map(r=>r.TURNO)));
    setOptions(document.getElementById("f_grupo"), uniq(rawRows.map(r=>r.GRUPO)));
    setOptions(document.getElementById("f_mina"), uniq(rawRows.map(r=>r.MINA)));
    setOptions(document.getElementById("f_responsable"), uniq(rawRows.map(r=>r.RESPONSABLE_CNC)));
  }

  function resetFilters(){
    document.getElementById("q").value = "";
    document.getElementById("f_grado").value = "";
    document.getElementById("f_suministro").value = "";
    document.getElementById("f_turno").value = "";
    document.getElementById("f_grupo").value = "";
    document.getElementById("f_mina").value = "";
    document.getElementById("f_responsable").value = "";
    applyFilters();
  }

  async function loadData(){
    const note = document.getElementById("note");
    note.textContent = "Cargando CSV‚Ä¶";

    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo cargar el CSV.");
    const text = await res.text();
    const grid = csvParse(text);
    if (grid.length < 2) throw new Error("CSV sin datos.");

    const header = grid[0].map(h => h.trim());
    const missing = COLS.filter(c => !header.includes(c));
    if (missing.length){
      note.textContent = `Faltan columnas en CSV: ${missing.join(", ")}`;
      console.warn("Header CSV:", header);
      return;
    }

    rawRows = grid.slice(1)
      .filter(r => r.some(x => String(x ?? "").trim() !== ""))
      .map(r=>{
        const obj = {};
        header.forEach((h,i)=> obj[h] = (r[i] ?? "").toString().trim());
        return obj;
      });

    fillDropdownsFromRaw();
    applyFilters();
  }

  function wireEvents(){
    const ids = ["q","f_grado","f_suministro","f_turno","f_grupo","f_mina","f_responsable"];
    ids.forEach(id => document.getElementById(id).addEventListener("input", applyFilters));
    document.getElementById("btnReset").addEventListener("click", resetFilters);
    document.getElementById("btnPdf").addEventListener("click", () => window.print());
  }

  (function init(){
    wireEvents();
    loadData().catch(err=>{
      document.getElementById("note").textContent = "Error: " + err.message;
      console.error(err);
    });
  })();
</script>
</body>
</html>
